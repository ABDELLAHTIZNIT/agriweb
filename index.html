<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AB AGRIWEB - Login</title>
  <link rel="stylesheet" href="assets/css/base.css" />
</head>
<body class="login-body">

<div class="login-wrap">
  <!-- Logo -->
  <div id="loginLogoWrap" class="login-logo-wrap hidden">
    <img id="loginLogoImg" alt="Logo" class="login-logo">
  </div>

  <!-- App title -->
  <h1 id="appTitle" class="login-title">AB AGRIWEB</h1>

  <!-- Hint -->
  <div id="noOpsHint" class="hint hidden">
    Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù‘Ù„. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ù…Ø§Ù„
    <b>Setup (no login)</b> Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª Ø«Ù… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ParamÃ¨tres.
  </div>

  <!-- Form -->
  <div class="field">
    <label class="label">Username</label>
    <input id="u" class="input" placeholder="Enter your username" />
  </div>

  <div class="field">
    <label class="label">Password</label>
    <div class="field">
      <input id="p" type="password" class="input" placeholder="Enter your password" />
      <span class="eye" onclick="togglePass()">ğŸ‘ï¸</span>
    </div>
  </div>

  <button class="btn" id="loginBtn">Se connecter</button>
  <button class="btn ghost" id="setupBtn"
          title="Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚Øª Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯">Setup (no login)</button>
  <a href="#" id="forgotLink" class="link">Forgot password?</a>
</div>

<!-- Recovery Modal -->
<div id="recoveryModal" class="modal-wrap">
  <div class="modal-bg" onclick="closeRecovery()"></div>
  <div class="modal">
    <h3>Account recovery</h3>
    <div class="small" id="recoveryHints"></div>

    <div class="tabbar">
      <button class="btn small" onclick="switchRecTab('code')">Code</button>
      <button class="btn small" onclick="switchRecTab('qa')">Question secrÃ¨te</button>
    </div>

    <div id="recTabCode">
      <label class="label">Recovery code (6 digits)</label>
      <input id="rec_code" class="input" placeholder="Ex: 123456" />
      <button class="btn" onclick="tryCode()">VÃ©rifier & ouvrir</button>
    </div>

    <div id="recTabQA" class="hidden">
      <div id="qa_wrap">
        <label class="label" id="qa_question">Question</label>
        <input id="qa_answer" class="input" placeholder="Votre rÃ©ponse" />
        <button class="btn" onclick="tryQA()">VÃ©rifier & ouvrir</button>
      </div>
      <div id="qa_empty" class="small hidden">Question secrÃ¨te ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„Ø©.</div>
    </div>

    <div class="small" id="recoveryContact" style="margin-top:8px"></div>

    <div class="right" style="margin-top:10px">
      <button class="btn ghost" onclick="closeRecovery()">Fermer</button>
    </div>
  </div>
</div>

<script>
const LS_APPCFG='ab_appcfg';
const LS_OPERATORS='ab_operators';
const LS_SEC='ab_security';

function g(id){return document.getElementById(id);}

function loadCfg(){
  try{return JSON.parse(localStorage.getItem(LS_APPCFG)||'{}')}catch{return{}}
}
function applyBranding(){
  const c=loadCfg();

  // Title
  const name=c.appName||'AB AGRIWEB';
  document.title = name+' - Login';
  g('appTitle').textContent = name;

  // Logo
  const logo = c.logo || c.logoUrl || '';
  if(logo){
    g('loginLogoImg').src = logo;
    g('loginLogoWrap').classList.remove('hidden');
  } else {
    g('loginLogoWrap').classList.add('hidden');
  }

  // Background
  const bg = c.loginBg || c.loginBgUrl || '';
  if(bg){
    document.body.style.backgroundImage = `url('${bg}')`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
  }else{
    document.body.style.backgroundImage = 'linear-gradient(180deg,#020817,#111827)';
  }
}

function togglePass(){
  const i=g('p');
  i.type = i.type==='password' ? 'text' : 'password';
}

function loadOps(){
  try{return JSON.parse(localStorage.getItem(LS_OPERATORS)||'[]')}catch{return[]}
}

function loginFlow(){
  const ops = loadOps();
  const u = (g('u').value||'').trim();
  const p = (g('p').value||'').trim();

  if(ops.length===0 && localStorage.getItem('ab_setup')!=='1'){
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ø³ØªØ¹Ù…Ù„ Setup (no login) Ø£Ùˆ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹.');
    openRecovery();
    return;
  }
  if(!u || !p){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.'); return; }

  const ok = ops.find(x =>
    (x.username||'').toLowerCase()===u.toLowerCase() &&
    (x.password||'')===p
  );
  if(!ok){ alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'); return; }

  window.location.href='main.html';
}

function openRecovery(){
  const sec = (function(){try{return JSON.parse(localStorage.getItem(LS_SEC)||'{}')}catch{return{}}})();
  const email=sec.email||'', phone=sec.phone||'';
  const emailHint=email?`Email: ${email.replace(/(.{2}).+(@.+)/,'$1***$2')}`:'Email ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·';
  const phoneHint=phone?`TÃ©lÃ©phone: ****${phone.slice(-4)}`:'TÃ©lÃ©phone ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·';
  g('recoveryHints').textContent='Ø§Ø³ØªØ¹Ù…Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø£Ùˆ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠ Ø¥Ù† ÙˆÙØ¬Ø¯.';
  g('recoveryContact').textContent=`${emailHint} | ${phoneHint}`;

  const hasQ = !!sec.question;
  g('qa_wrap').classList.toggle('hidden',!hasQ);
  g('qa_empty').classList.toggle('hidden',hasQ);
  if(hasQ) g('qa_question').textContent = sec.question;

  switchRecTab('code');
  g('recoveryModal').classList.add('show');
}
function closeRecovery(){ g('recoveryModal').classList.remove('show'); }

function switchRecTab(tab){
  g('recTabCode').classList.toggle('hidden',tab!=='code');
  g('recTabQA').classList.toggle('hidden',tab!=='qa');
}

function tryCode(){
  const code=(g('rec_code').value||'').trim();
  let sec={}; try{sec=JSON.parse(localStorage.getItem(LS_SEC)||'{}')}catch{}
  if(code && sec.recoveryCode && code===String(sec.recoveryCode)){
    localStorage.setItem('ab_setup','1');
    window.location.href='main.html';
  }else{
    alert('Code invalide ou ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·.');
  }
}
function hashLite(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return String(h)}
function tryQA(){
  const ans=(g('qa_answer').value||'').trim().toLowerCase();
  let sec={}; try{sec=JSON.parse(localStorage.getItem(LS_SEC)||'{}')}catch{}
  if(!sec.answerHash){ alert('Question secrÃ¨te ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„Ø©.'); return; }
  if(hashLite(ans)===sec.answerHash){
    localStorage.setItem('ab_setup','1');
    window.location.href='main.html';
  }else{
    alert('RÃ©ponse incorrecte.');
  }
}

/* Setup button */
document.addEventListener('DOMContentLoaded',()=>{
  applyBranding();
  if(loadOps().length===0){ g('noOpsHint').classList.remove('hidden'); }

  g('loginBtn').onclick = (e)=>{e.preventDefault();loginFlow();}
  g('forgotLink').onclick = (e)=>{e.preventDefault();openRecovery();}
  g('setupBtn').onclick = (e)=>{
    e.preventDefault();
    localStorage.setItem('ab_setup','1');
    window.location.href='main.html';
  }
});
</script>
</body>
</html>
