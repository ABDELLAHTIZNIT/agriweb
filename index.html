<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AB AGRIWEB - Login</title>
  <link rel="stylesheet" href="assets/css/base.css"/>
</head>
<body class="login-body">

<header class="top-login">
  <div class="top-login-left">
    <!-- logo ÿ≥Ÿäÿ∂ÿ®ÿ∑ ŸÖŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ -->
  </div>
  <div class="top-login-right">
    <div class="lang-switch">
      <button id="lang-btn" class="btn small">üåê EN</button>
      <div id="lang-menu" class="lang-menu hidden">
        <button onclick="setLang('en')">English</button>
        <button onclick="setLang('fr')">Fran√ßais</button>
        <button onclick="setLang('ar')">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
      </div>
    </div>
  </div>
</header>

<main class="login-wrap">
  <section class="login-card">
    <div class="login-logo-wrap">
      <img id="loginLogoImg" class="login-logo" alt="Logo"/>
      <h1 id="login-title">AB AGRIWEB</h1>
    </div>

    <div id="setup-msg" class="setup-msg hidden"></div>

    <div class="stack">
      <label class="label" id="lbl-user">Username</label>
      <input id="in-user" class="input" placeholder="admin"/>
      <label class="label" id="lbl-pass">Password</label>
      <input id="in-pass" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
    </div>

    <div class="stack" style="margin-top:16px;gap:8px">
      <button class="btn wide" id="btn-login" onclick="doLogin()">Sign in</button>
      <button class="btn wide ghost" id="btn-setup" onclick="openSetup()">Setup (no login)</button>
      <button class="link-btn" id="btn-forgot" type="button" onclick="openRecovery()">Forgot password?</button>
    </div>
  </section>
</main>

<!-- Modal recovery (ÿ®ÿ≥Ÿäÿ∑) -->
<div id="rec-modal" class="modal-wrap">
  <div class="modal-bg" onclick="closeRecovery()"></div>
  <div class="modal" style="max-width:500px">
    <h3 id="rec-title">Account recovery</h3>
    <p id="rec-text" class="small muted">
      Use the information you configured in "Security / Password" inside the application.
    </p>
    <div class="stack">
      <div>
        <label class="label" id="rec-email-label">Recovery email</label>
        <input id="rec-email" class="input" placeholder="admin@farm.com"/>
      </div>
      <div>
        <label class="label" id="rec-question-label">Secret question</label>
        <input id="rec-question" class="input" readonly/>
      </div>
      <div>
        <label class="label" id="rec-answer-label">Secret answer</label>
        <input id="rec-answer" class="input" placeholder="Answer"/>
      </div>
      <div>
        <label class="label" id="rec-code-label">Recovery code</label>
        <input id="rec-code" class="input" placeholder="123456"/>
      </div>
    </div>
    <div class="right" style="margin-top:10px;gap:8px">
      <button class="btn" onclick="checkRecovery()" id="rec-check-btn">Check</button>
      <button class="btn danger" onclick="closeRecovery()" id="rec-close-btn">Close</button>
    </div>
  </div>
</div>

<script>
/* ----- helpers ----- */
const LS_APPCFG = 'ab_appcfg';
const LS_OPERATORS = 'ab_operators';
const LS_SECURITY = 'ab_security';
const LS_LANG = 'ab_lang';
const LS_USER = 'ab_user';

function g(id){return document.getElementById(id);}
function v(id){const el=g(id);return el?el.value.trim():'';}
function loadJson(key,def){try{const v=localStorage.getItem(key);return v?JSON.parse(v):def;}catch(e){return def;}}

/* ----- language system ----- */
const LANG = {
  en: {
    code:'EN',
    loginTitle:'AB AGRIWEB',
    username:'Username',
    password:'Password',
    signIn:'Sign in',
    setup:'Setup (no login)',
    forgot:'Forgot password?',
    noUsers:'No operator configured. Use Setup mode or go to "Settings ‚Üí Management ‚Üí Users" to create one.',
    recTitle:'Account recovery',
    recText:'Use the information configured in "Security / Password" inside the application.',
    recEmail:'Recovery email',
    recQuestion:'Secret question',
    recAnswer:'Secret answer',
    recCode:'Recovery code',
    recCheck:'Check',
    recClose:'Close',
    recOk:'Recovery data seems valid. You can reset your password inside the app.',
    recFail:'Recovery data does not match.'
  },
  fr: {
    code:'FR',
    loginTitle:'AB AGRIWEB',
    username:'Identifiant',
    password:'Mot de passe',
    signIn:'Se connecter',
    setup:'Mode setup (sans login)',
    forgot:'Mot de passe oubli√© ?',
    noUsers:"Aucun op√©rateur configur√©. Utilisez le mode Setup ou cr√©ez un utilisateur dans ¬´ Param√®tres ‚Üí Management ‚Üí Users ¬ª.",
    recTitle:'R√©cup√©ration du compte',
    recText:'Utilisez les informations configur√©es dans ¬´ Security / Password ¬ª dans l‚Äôapplication.',
    recEmail:'Email de r√©cup√©ration',
    recQuestion:'Question secr√®te',
    recAnswer:'R√©ponse secr√®te',
    recCode:'Code de r√©cup√©ration',
    recCheck:'V√©rifier',
    recClose:'Fermer',
    recOk:'Les donn√©es de r√©cup√©ration sont valides. Vous pouvez r√©initialiser le mot de passe dans l‚Äôapp.',
    recFail:'Les donn√©es de r√©cup√©ration ne correspondent pas.'
  },
  ar: {
    code:'AR',
    loginTitle:'AB AGRIWEB',
    username:'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
    password:'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±',
    signIn:'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ',
    setup:'Ÿàÿ∂ÿπ ÿßŸÑÿ•ÿπÿØÿßÿØ (ÿ®ÿØŸàŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ)',
    forgot:'ŸÜÿ≥Ÿäÿ™ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±ÿü',
    noUsers:'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£Ÿä ŸÖÿ≥ÿ™ÿÆÿØŸÖ. ÿßÿ≥ÿ™ÿπŸÖŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿ•ÿπÿØÿßÿØ ÿ£Ÿà ÿ£ÿ∂ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ: ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ‚Üí Management ‚Üí Users.',
    recTitle:'ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ≠ÿ≥ÿßÿ®',
    recText:'ÿßÿ≥ÿ™ÿπŸÖŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ™Ÿä ŸÇŸÖÿ™ ÿ®ÿ≠ŸÅÿ∏Ÿáÿß ŸÅŸä "Security / Password" ÿØÿßÿÆŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ.',
    recEmail:'ÿ®ÿ±ŸäÿØ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ',
    recQuestion:'ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ≥ÿ±Ÿä',
    recAnswer:'ÿßŸÑÿ¨Ÿàÿßÿ® ÿßŸÑÿ≥ÿ±Ÿä',
    recCode:'ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ',
    recCheck:'ÿ™ÿ≠ŸÇŸÇ',
    recClose:'ÿ•ÿ∫ŸÑÿßŸÇ',
    recOk:'ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿµÿ≠Ÿäÿ≠ÿ©. ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ŸÖŸÜ ÿØÿßÿÆŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ.',
    recFail:'ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©.'
  }
};

function currentLangCode(){
  const c = localStorage.getItem(LS_LANG);
  return (c && LANG[c]) ? c : 'en';
}

function applyLang(){
  const L = LANG[currentLangCode()];
  g('lang-btn').textContent = 'üåê ' + L.code;
  g('login-title').textContent = L.loginTitle;
  g('lbl-user').textContent = L.username;
  g('lbl-pass').textContent = L.password;
  g('btn-login').textContent = L.signIn;
  g('btn-setup').textContent = L.setup;
  g('btn-forgot').textContent = L.forgot;

  const sec = LANG[currentLangCode()];
  g('rec-title').textContent = sec.recTitle;
  g('rec-text').textContent = sec.recText;
  g('rec-email-label').textContent = sec.recEmail;
  g('rec-question-label').textContent = sec.recQuestion;
  g('rec-answer-label').textContent = sec.recAnswer;
  g('rec-code-label').textContent = sec.recCode;
  g('rec-check-btn').textContent = sec.recCheck;
  g('rec-close-btn').textContent = sec.recClose;

  // setup message
  const users = loadJson(LS_OPERATORS,[]);
  const msg = g('setup-msg');
  if(!users || !users.length){
    msg.textContent = L.noUsers;
    msg.classList.remove('hidden');
  }else{
    msg.classList.add('hidden');
  }
}

function setLang(code){
  if(!LANG[code]) return;
  localStorage.setItem(LS_LANG,code);
  applyLang();
  g('lang-menu').classList.add('hidden');
}

/* ----- Lang menu UI ----- */
g('lang-btn').addEventListener('click',()=>{
  g('lang-menu').classList.toggle('hidden');
});
document.addEventListener('click',e=>{
  if(!g('lang-btn').contains(e.target) && !g('lang-menu').contains(e.target)){
    g('lang-menu').classList.add('hidden');
  }
});

/* ----- Branding / background ----- */
function applyBranding(){
  const cfg = loadJson(LS_APPCFG,{}) || {};
  const labels = cfg.labels || {};
  const appName = labels.chip || cfg.appName || 'AB AGRIWEB';
  g('login-title').textContent = appName;

  const logo = cfg.logo || cfg.logoUrl;
  const img = g('loginLogoImg');
  if(logo){ img.src = logo; img.style.display='block'; }
  else { img.style.display='none'; }

  const bg = cfg.loginBg || cfg.loginBgUrl;
  if(bg){
    document.body.style.backgroundImage = `url('${bg}')`;
    document.body.style.backgroundSize='cover';
    document.body.style.backgroundAttachment='fixed';
  }

  // logo zoom
  const zx = cfg.zoomX || 100;
  const zy = cfg.zoomY || 100;
  img.style.transform = `scale(${zx/100},${zy/100})`;
}

/* ----- Login logic ----- */
function doLogin(){
  const user=v('in-user');
  const pass=v('in-pass');
  const users=loadJson(LS_OPERATORS,[])||[];
  const u = users.find(x=>x.username===user && x.password===pass);
  if(!u){
    alert('Invalid username or password.');
    return;
  }
  localStorage.setItem(LS_USER,JSON.stringify({username:u.username,profile:u.profile||''}));
  window.location.href='main.html';
}

function openSetup(){
  // Ÿàÿ∂ÿπ ÿßŸÑÿ•ÿπÿØÿßÿØ ÿ®ÿØŸàŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ
  window.location.href='main.html?setup=1';
}

/* ----- Recovery ----- */
function openRecovery(){
  const sec = loadJson(LS_SECURITY,{})||{};
  g('rec-email').value='';
  g('rec-answer').value='';
  g('rec-code').value='';
  g('rec-question').value = sec.question || '';
  g('rec-modal').classList.add('show');
}

function closeRecovery(){
  g('rec-modal').classList.remove('show');
}

function hashLite(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return String(h);}

function checkRecovery(){
  const sec = loadJson(LS_SECURITY,{})||{};
  const L = LANG[currentLangCode()];
  const emailOk = !sec.email || v('rec-email')===sec.email;
  const codeOk  = !sec.recoveryCode || v('rec-code')===sec.recoveryCode;
  const ansOk   = !sec.answerHash || hashLite(v('rec-answer').toLowerCase())===sec.answerHash;

  if(emailOk && codeOk && ansOk){
    alert(L.recOk);
  }else{
    alert(L.recFail);
  }
}

/* ----- init ----- */
(function init(){
  applyBranding();
  applyLang();
})();
</script>
</body>
</html>
