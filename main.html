<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AB AGRIWEB - Dashboard</title>
<style>
:root{
  --bg:#0f172a;
  --bg-soft:#020817;
  --panel:#0b1220;
  --text:#e2e8f0;
  --muted:#9ca3af;
  --accent:#22c55e;
  --border:#243046;
  --tile:#0c1526;
  --tileIcon:#0f1a2e;
  --warn-bg:#fde68a1a;
  --warn-border:#fbbf24;
  --warn-text:#fcd34d;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
}
.hidden{display:none!important}

/* HEADER */
header{
  position:sticky;top:0;z-index:40;
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 14px;
  background:var(--panel);
  border-bottom:1px solid var(--border);
}
.left-head{display:flex;align-items:center;gap:10px}
.menu-btn{
  width:36px;height:36px;border-radius:10px;
  border:1px solid #111827;background:#020817;
  color:var(--text);display:flex;align-items:center;justify-content:center;
  font-size:20px;cursor:pointer;
}
.brand{display:flex;align-items:center;gap:8px}
#appTitleTop{
  font-weight:800;font-size:15px;letter-spacing:.4px;
  color:var(--accent);
}
#appBadgeImg{
  height:22px;border-radius:6px;border:1px solid #1f2937;
}

/* SIDEBAR */
.sidebar{
  position:fixed;top:0;left:-260px;width:260px;height:100%;
  background:#020817;border-right:1px solid var(--border);
  padding-top:52px;display:flex;flex-direction:column;
  transition:left .25s ease;z-index:35;
}
.sidebar.open{left:0}
.sidebar a{
  display:flex;align-items:center;gap:8px;
  padding:9px 14px;margin:2px 8px;
  border-radius:9px;font-size:13px;
  color:#cbd5e1;text-decoration:none;
}
.sidebar a span.emoji{width:18px;text-align:center}
.sidebar a:hover{background:#111827;color:#fff;}
.sidebar a.active{background:var(--accent);color:#020817;font-weight:700;}
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  opacity:0;pointer-events:none;transition:opacity .25s;z-index:30;
}
.overlay.active{opacity:1;pointer-events:auto;}

/* MAIN */
main.content{padding:16px}
.card{
  background:var(--bg-soft);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.35);
}
.card h2{margin-bottom:6px;font-size:18px}
.card p{font-size:13px;color:var(--muted)}

/* Setup banner */
.setup-banner{
  border-radius:14px;
  border:1px dashed var(--warn-border);
  background:var(--warn-bg);
  padding:10px 10px 8px;
  margin-bottom:14px;
  font-size:12px;
  color:var(--warn-text);
}
.setup-actions{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}

/* Buttons & inputs */
.btn{
  padding:7px 10px;border-radius:8px;
  border:1px solid var(--accent);background:transparent;
  color:var(--accent);cursor:pointer;font-size:12px;
}
.btn:hover{background:var(--accent);color:#020817}
.btn.icon{width:32px;height:32px;display:flex;align-items:center;justify-content:center;padding:0}
.btn.danger{border-color:#ef4444;color:#fca5a5}
.btn.danger:hover{background:#ef4444;color:#020817}
.input,select,textarea{
  width:100%;max-width:340px;
  padding:9px 10px;
  border-radius:9px;
  border:1px solid #111827;
  background:#020817;color:#e5e7eb;
  font-size:12px;
}
.row{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
.label{
  display:block;font-size:10px;color:#9ca3af;margin-bottom:3px;
}

/* Tiles */
.stack{display:grid;gap:8px;margin-top:8px}
.tile{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;
  background:var(--tile);
  border-radius:12px;
  border:1px solid #111827;
  cursor:pointer;
}
.tile .icon{
  width:30px;height:30px;
  display:grid;place-items:center;
  background:var(--tileIcon);
  border-radius:9px;
  border:1px solid #1f2a44;
  font-size:16px;
}
.tile h4{margin:0;font-size:13px}
.tile p{margin:0;font-size:11px;color:var(--muted)}
.tile:hover{border-color:var(--accent);box-shadow:0 0 0 1px rgba(34,197,94,.15) inset}

/* Lists */
.list{display:grid;gap:8px;margin-top:10px}
.item{
  display:grid;grid-template-columns:1fr auto;gap:8px;
  align-items:center;
  padding:9px 10px;
  background:#020817;
  border-radius:10px;
  border:1px solid #111827;
  font-size:11px;
}
.meta{display:flex;flex-wrap:wrap;gap:8px;color:#9ca3af}
.meta b{color:#e5e7eb}

/* Accordion in app settings */
.accordion{margin-top:10px;border-radius:12px;border:1px solid var(--border);background:#020817;}
.acc-hd{
  width:100%;padding:9px 10px;
  border:none;outline:none;
  background:#0c1526;
  color:var(--text);font-size:12px;
  display:flex;align-items:center;justify-content:space-between;
  border-radius:12px 12px 0 0;
  cursor:pointer;
}
.acc-bd{padding:10px;display:none;font-size:11px}
.acc.open .acc-bd{display:block}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}

/* Combo list */
.combo{position:relative;max-width:340px}
.combo-list{
  position:absolute;left:0;right:0;top:100%;
  background:#020817;border:1px solid #111827;
  max-height:200px;overflow-y:auto;
  border-radius:9px;margin-top:3px;z-index:50;
}
.combo-item{padding:6px 8px;font-size:11px;cursor:pointer;border-bottom:1px solid #111827}
.combo-item:hover{background:#111827}
.combo-item.muted{color:#6b7280;cursor:default}

/* Modals */
.modal-wrap{position:fixed;inset:0;display:none;place-items:center;z-index:60}
.modal-wrap.show{display:grid}
.modal-bg{position:absolute;inset:0;background:rgba(0,0,0,.45);}
.modal{
  position:relative;z-index:61;
  width:min(480px,94vw);
  background:#020817;border-radius:14px;
  border:1px solid var(--border);
  padding:12px;
  box-shadow:0 20px 40px rgba(0,0,0,.6);
  font-size:12px;
}
.modal h3{margin-bottom:6px;font-size:14px}
.right{display:flex;justify-content:flex-end;gap:6px;margin-top:6px}
</style>
</head>
<body>

<header>
  <div class="left-head">
    <button id="menuBtn" class="menu-btn">â˜°</button>
    <div class="brand">
      <div id="appTitleTop">AB AGRIWEB</div>
      <img id="appBadgeImg" class="hidden" alt="">
    </div>
  </div>
</header>

<!-- SIDEBAR -->
<aside id="sidebar" class="sidebar">
  <a href="#" id="nav-home" class="active"><span class="emoji">ğŸ </span><span id="lbl-nav-home">Accueil</span></a>
  <a href="#" id="nav-irrig"><span class="emoji">ğŸŒ¿</span><span id="lbl-nav-irrig">Irrigation</span></a>
  <a href="#" id="nav-trait"><span class="emoji">ğŸ’§</span><span id="lbl-nav-trait">Traitement</span></a>
  <a href="#" id="nav-settings"><span class="emoji">âš™ï¸</span><span id="lbl-nav-settings">ParamÃ¨tres</span></a>
  <a href="#" id="nav-logout"><span class="emoji">ğŸšª</span><span id="lbl-nav-logout">Logout</span></a>
</aside>
<div id="overlay" class="overlay"></div>

<main class="content">

  <!-- Setup banner -->
  <section id="setupBanner" class="setup-banner hidden">
    âš ï¸ Setup Mode Ù…ÙØ¹Ù„: ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ø³Ø± Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø¶Ø¨Ø· Ø§Ù„Ù„ÙˆØºÙˆØŒ Ø§Ù„Ø®Ù„ÙÙŠØ©...).
    <div class="setup-actions">
      <button class="btn danger" onclick="disableSetup()">Ø¥ÙŠÙ‚Ø§Ù Setup Mode</button>
      <button class="btn" onclick="goSettings()">Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ParamÃ¨tres</button>
    </div>
  </section>

  <!-- Accueil -->
  <section id="page-home" class="card">
    <h2>Bienvenue ğŸ‘‹</h2>
    <p id="homeText">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ AB AGRIWEB. Ø§Ø³ØªØ¹Ù…Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ø¨Ø¯Ø¡.</p>
    <div id="firstRunHint" class="hint hidden" style="margin-top:8px">
      ğŸ” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ <b>ParamÃ¨tres â†’ OpÃ©rateurs</b> ÙˆØ£Ø¶Ù Ø£ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù….
    </div>
  </section>

  <!-- ParamÃ¨tres (tuiles) -->
  <section id="page-settings" class="card hidden">
    <h2>ParamÃ¨tres</h2>
    <p class="hint">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¯Ø§Ø±ØªÙ‡.</p>
    <div class="stack">
      <div class="tile" onclick="openPage('operators')">
        <div class="icon">ğŸ‘¥</div>
        <div><h4 id="lbl-tile-operators">OPÃ‰RATEUR</h4><p>Gestion des utilisateurs</p></div>
      </div>
      <div class="tile" onclick="openPage('profiles')">
        <div class="icon">ğŸ§©</div>
        <div><h4 id="lbl-tile-profiles">PROFILE</h4><p>Profils et rÃ´les</p></div>
      </div>
      <div class="tile" onclick="openPage('refs')">
        <div class="icon">ğŸ—‚ï¸</div>
        <div><h4 id="lbl-tile-refs">RÃ‰FÃ‰RENTIELS</h4><p>Listes maÃ®tres</p></div>
      </div>
      <div class="tile" onclick="openPage('appcfg');focusAcc('acc-brand')">
        <div class="icon">ğŸ¨</div>
        <div><h4 id="lbl-tile-appcfg">BRANDING</h4><p>Ù„ÙˆØºÙˆ + Ù‚ÙˆØ§Ù„Ø¨ + Ø®Ù„ÙÙŠØ§Øª</p></div>
      </div>
      <div class="tile" onclick="openPage('appcfg');focusAcc('acc-nav')">
        <div class="icon">ğŸ”¤</div>
        <div><h4>LibellÃ©s</h4><p>ØªØ®ØµÙŠØµ Ù†ØµÙˆØµ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª</p></div>
      </div>
      <div class="tile" onclick="openPage('appcfg');focusAcc('acc-sec')">
        <div class="icon">ğŸ”</div>
        <div><h4>SÃ©curitÃ©</h4><p>Email / TÃ©lÃ©phone / Question secrÃ¨te / Code</p></div>
      </div>
    </div>
  </section>

  <!-- Profiles -->
  <section id="page-profiles" class="card hidden">
    <div class="right">
      <button class="btn icon" onclick="toggleProfileForm(true)">â•</button>
    </div>
    <h2>Profils</h2>
    <p class="hint">Ø£Ø¶Ù Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (Admin, Magasinier, ...).</p>
    <div id="profileForm" class="row hidden">
      <input id="profileName" class="input" placeholder="Ex: Admin, Magasinier">
      <button class="btn" onclick="addProfile()">Confirmer</button>
      <button class="btn danger" onclick="toggleProfileForm(false)">Annuler</button>
    </div>
    <div id="profilesList" class="list"></div>
  </section>

  <!-- Operators -->
  <section id="page-operators" class="card hidden">
    <div class="right">
      <button class="btn icon" onclick="opToggleForm(true)">â•</button>
    </div>
    <h2>OpÃ©rateurs</h2>
    <p class="hint">Ù…Ø³ØªØ®Ø¯Ù…Ùˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆØ¶ÙŠØ¹Ø©.</p>
    <div id="opAddForm" class="row hidden">
      <input id="op_username" class="input" placeholder="Nom dâ€™utilisateur">
      <input id="op_password" type="password" class="input" placeholder="Mot de passe">
      <select id="op_profile" class="input"></select>
      <div class="combo" id="combo-op-ferme">
        <input id="op_ferme_input" class="input" placeholder="Choisir une ferme...">
        <div id="op_ferme_list" class="combo-list hidden"></div>
        <input type="hidden" id="op_ferme">
      </div>
      <button class="btn" onclick="opAdd()">Confirmer</button>
      <button class="btn danger" onclick="opToggleForm(false)">Annuler</button>
    </div>
    <div id="operatorsList" class="list"></div>
  </section>

  <!-- Farms -->
  <section id="page-farms" class="card hidden">
    <div class="right">
      <button class="btn icon" onclick="farmToggleForm(true)">â•</button>
    </div>
    <h2>Fermes</h2>
    <p class="hint">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¶ÙŠØ¹Ø§Øª Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„Ù‡Ø§ ÙÙŠ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª.</p>
    <div id="farmAddForm" class="row hidden">
      <input id="farm_name" class="input" placeholder="Nom de la ferme">
      <input id="farm_area" class="input" placeholder="Surface">
      <input id="farm_company" class="input" placeholder="SociÃ©tÃ©">
      <input id="farm_location" class="input" placeholder="Emplacement">
      <input id="farm_manager" class="input" placeholder="Responsable">
      <input id="farm_phone" class="input" placeholder="TÃ©lÃ©phone">
      <button class="btn" onclick="farmAdd()">Confirmer</button>
      <button class="btn danger" onclick="farmToggleForm(false)">Annuler</button>
    </div>
    <div id="farmsList" class="list"></div>
  </section>

  <!-- RÃ©fÃ©rentiels -->
  <section id="page-refs" class="card hidden">
    <h2>RÃ©fÃ©rentiels</h2>
    <p class="hint">Ù„ÙˆØ§Ø¦Ø­ Ù…Ø³Ø§Ø¹Ø¯Ø©: sociÃ©tÃ©s, variÃ©tÃ©s, transports...</p>
    <div id="refsHome" class="stack">
      <div class="tile" onclick="openPage('farms')"><div class="icon">ğŸï¸</div><div><h4>Fermes</h4></div></div>
      <div class="tile" onclick="refsOpen('companies')"><div class="icon">ğŸ¢</div><div><h4>SociÃ©tÃ©s</h4></div></div>
      <div class="tile" onclick="refsOpen('responsables')"><div class="icon">ğŸ‘¤</div><div><h4>Responsables</h4></div></div>
      <div class="tile" onclick="refsOpen('stations')"><div class="icon">ğŸš</div><div><h4>Stations</h4></div></div>
      <div class="tile" onclick="refsOpen('secteurs')"><div class="icon">ğŸ§­</div><div><h4>Secteurs</h4></div></div>
      <div class="tile" onclick="refsOpen('parcelles')"><div class="icon">ğŸ§±</div><div><h4>Parcelles</h4></div></div>
      <div class="tile" onclick="refsOpen('transports')"><div class="icon">ğŸšš</div><div><h4>Transports</h4></div></div>
      <div class="tile" onclick="refsOpen('varietes')"><div class="icon">ğŸŒ±</div><div><h4>VariÃ©tÃ©s</h4></div></div>
      <div class="tile" onclick="refsOpen('varietes_champ')"><div class="icon">ğŸŒ¿</div><div><h4>VariÃ©tÃ©s champ</h4></div></div>
      <div class="tile" onclick="refsOpen('gestions')"><div class="icon">ğŸ“¦</div><div><h4>Gestion stock</h4></div></div>
      <div class="tile" onclick="refsOpen('achats')"><div class="icon">ğŸ§¾</div><div><h4>Achats</h4></div></div>
    </div>

    <div id="refsCat" class="hidden" style="margin-top:12px">
      <div class="right">
        <button class="btn icon" onclick="refsToggleForm(true)">â•</button>
      </div>
      <h3 id="refsCatTitle" style="font-size:14px;margin-bottom:4px">CatÃ©gorie</h3>
      <div id="refsHint" class="hint">Ø§Ø³ØªØ¹Ù…Ù„ âœï¸ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ùˆ ğŸ—‘ï¸ Ù„Ù„Ø­Ø°Ù.</div>
      <div id="refsAddForm" class="row hidden">
        <input id="refsInput" class="input" placeholder="Nom Ã  ajouter">
        <button class="btn" onclick="refsAdd()">Confirmer</button>
        <button class="btn danger" onclick="refsToggleForm(false)">Annuler</button>
      </div>
      <div id="refsList" class="list"></div>
    </div>
  </section>

  <!-- RÃ©glages de lâ€™application (LibellÃ©s + SÃ©curitÃ© + Branding) -->
  <section id="page-appcfg" class="card hidden">
    <h2>RÃ©glages de lâ€™application</h2>
    <p class="hint">LibellÃ©s, sÃ©curitÃ©ØŒ ÙˆØ§Ù„Ù€ Branding (Ø§Ù„Ù„ÙˆØºÙˆ ÙˆØ§Ù„Ø®Ù„ÙÙŠØ§Øª) Ù…Ù† Ù‡Ù†Ø§.</p>

    <!-- 2) LibellÃ©s Navigation -->
    <div id="acc-nav" class="accordion acc">
      <button class="acc-hd" onclick="toggleAcc('acc-nav')">
        1) LibellÃ©s Navigation
        <span>Accueil â€¢ Irrigation â€¢ Traitement â€¢ ParamÃ¨tres â€¢ Logout</span>
      </button>
      <div class="acc-bd">
        <div class="grid">
          <div><label class="label">Accueil</label><input id="cfg-nav-home" class="input"></div>
          <div><label class="label">Irrigation</label><input id="cfg-nav-irrig" class="input"></div>
          <div><label class="label">Traitement</label><input id="cfg-nav-trait" class="input"></div>
          <div><label class="label">ParamÃ¨tres</label><input id="cfg-nav-settings" class="input"></div>
          <div><label class="label">Logout</label><input id="cfg-nav-logout" class="input"></div>
        </div>
      </div>
    </div>

    <!-- 3) Tuiles -->
    <div id="acc-tiles" class="accordion acc">
      <button class="acc-hd" onclick="toggleAcc('acc-tiles')">
        2) Tuiles ParamÃ¨tres
        <span>OpÃ©rateur â€¢ Profil â€¢ RÃ©fÃ©rentiels â€¢ Branding</span>
      </button>
      <div class="acc-bd">
        <div class="grid">
          <div><label class="label">OpÃ©rateur</label><input id="cfg-tile-operators" class="input"></div>
          <div><label class="label">Profil</label><input id="cfg-tile-profiles" class="input"></div>
          <div><label class="label">RÃ©fÃ©rentiels</label><input id="cfg-tile-refs" class="input"></div>
          <div><label class="label">Branding</label><input id="cfg-tile-appcfg" class="input"></div>
        </div>
      </div>
    </div>

    <!-- 4) SÃ©curitÃ© -->
    <div id="acc-sec" class="accordion acc">
      <button class="acc-hd" onclick="toggleAcc('acc-sec')">
        3) SÃ©curitÃ©
        <span>Email â€¢ TÃ©lÃ©phone â€¢ Question â€¢ Code</span>
      </button>
      <div class="acc-bd">
        <div class="grid">
          <div><label class="label">Email de rÃ©cupÃ©ration</label><input id="sec-email" class="input"></div>
          <div><label class="label">TÃ©lÃ©phone</label><input id="sec-phone" class="input"></div>
          <div><label class="label">Question secrÃ¨te</label><input id="sec-question" class="input"></div>
          <div><label class="label">RÃ©ponse</label><input id="sec-answer" class="input" placeholder="Saisir pour mettre Ã  jour"></div>
          <div>
            <label class="label">Code de rÃ©cupÃ©ration</label>
            <div class="row">
              <input id="sec-code" class="input" disabled>
              <button class="btn" onclick="secGenCode()">GÃ©nÃ©rer</button>
            </div>
            <div class="hint">ÙŠÙØ³ØªØ®Ø¯Ù… ÙÙŠ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙˆØµÙˆÙ„.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 5) Branding (ÙƒÙ„ Ù…Ø§ ÙŠØ®Øµ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§Ù„Ø®Ù„ÙÙŠØ§Øª) -->
    <div id="acc-brand" class="accordion acc open">
      <button class="acc-hd" onclick="toggleAcc('acc-brand')">
        4) Branding
        <span>Ù„ÙˆØºÙˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ â€¢ Ù‚ÙˆØ§Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â€¢ Ø§Ù„Ø®Ù„ÙÙŠØ§Øª</span>
      </button>
      <div class="acc-bd">

        <!-- Ø£) Ù‡ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø§Ù„Ù„ÙˆØºÙˆ + Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ù‡ÙŠØ¯Ø±) -->
        <div class="card" style="background:#050816;margin:0 0 8px 0;border-radius:12px;">
          <h3 style="font-size:13px;margin-bottom:4px">Ù‡ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
          <div class="grid">
            <div>
              <label class="label">Nom de lâ€™application (App Title)</label>
              <input id="cfg-app-title" class="input" placeholder="AB AGRIWEB">
            </div>
            <div>
              <label class="label">Logo principal (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±)</label>
              <input id="cfg-logo-url" class="input" placeholder="URL (png/gif)">
              <input id="cfg-logo-file" type="file" accept="image/png,image/gif" class="input">
            </div>
            <div>
              <label class="label">Badge header ØµØºÙŠØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="cfg-badge-url" class="input" placeholder="URL (png/gif)">
              <input id="cfg-badge-file" type="file" accept="image/png,image/gif" class="input">
            </div>
          </div>
        </div>

        <!-- Ø¨) ÙˆØ§Ø¬Ù‡Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div class="card" style="background:#050816;margin:0 0 8px 0;border-radius:12px;">
          <h3 style="font-size:13px;margin-bottom:4px">ÙˆØ§Ø¬Ù‡Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
          <div class="grid">
            <div>
              <label class="label">ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø¨Ø·Ø§Ù‚Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Login banner)</label>
              <input id="cfg-login-url" class="input" placeholder="URL (png/gif)">
              <input id="cfg-login-file" type="file" accept="image/png,image/gif" class="input">
            </div>
            <div>
              <label class="label">Ø®Ù„ÙÙŠØ© ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
              <input id="cfg-loginbg-url" class="input" placeholder="URL (png/jpg/gif)">
              <input id="cfg-loginbg-file" type="file" accept="image/png,image/gif,image/jpeg" class="input">
            </div>
          </div>
          <p class="hint">Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙØ³ØªØ®Ø¯Ù… ÙÙŠ ØµÙØ­Ø© <b>index.html</b>.</p>
        </div>

        <!-- Ø¬) Ø§Ù„Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ -->
        <div class="card" style="background:#050816;margin:0;border-radius:12px;">
          <h3 style="font-size:13px;margin-bottom:4px">Ø§Ù„Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…)</h3>
          <div class="grid">
            <div>
              <label class="label">Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø¥Ù† Ù„Ù… ØªØ³ØªØ¹Ù…Ù„ ØµÙˆØ±Ø©)</label>
              <input id="cfg-appbg-color" type="color" class="input" style="padding:0;height:36px;">
            </div>
            <div>
              <label class="label">ØµÙˆØ±Ø© Ø®Ù„ÙÙŠØ© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (App Background)</label>
              <input id="cfg-appbg-url" class="input" placeholder="URL (png/jpg/gif)">
              <input id="cfg-appbg-file" type="file" accept="image/png,image/gif,image/jpeg" class="input">
            </div>
            <div>
              <label class="label">ØµÙˆØ±Ø© Ø´Ø±ÙŠØ· Ø¬Ø§Ù†Ø¨ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="cfg-side-url" class="input" placeholder="URL (png/gif)">
              <input id="cfg-side-file" type="file" accept="image/png,image/gif" class="input">
            </div>
          </div>
          <p class="hint">Ø¥Ø°Ø§ ØªÙ… ØªØ¹ÙŠÙŠÙ† ØµÙˆØ±Ø© App Background Ø³ÙŠØªÙ… Ø§Ø³ØªØ¹Ù…Ø§Ù„Ù‡Ø§Ø› Ø¥Ø°Ø§ Ù„Ø§ØŒ ÙŠØªÙ… Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ù„ÙˆÙ†.</p>
        </div>

      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="appcfgSave()">Enregistrer</button>
      <button class="btn danger" onclick="appcfgReset()">Reset (dÃ©faut)</button>
    </div>
  </section>
</main>

<!-- Modals -->
<div id="opModal" class="modal-wrap">
  <div class="modal-bg" onclick="opCloseModal()"></div>
  <div class="modal">
    <h3>Modifier lâ€™opÃ©rateur</h3>
    <div class="row">
      <input id="edit_username" class="input" placeholder="Nom dâ€™utilisateur">
      <input id="edit_password" type="password" class="input" placeholder="Mot de passe">
    </div>
    <div class="row">
      <select id="edit_profile" class="input"></select>
      <div class="combo" id="combo-edit-ferme">
        <input id="edit_ferme_input" class="input" placeholder="Choisir une ferme...">
        <div id="edit_ferme_list" class="combo-list hidden"></div>
        <input type="hidden" id="edit_ferme">
      </div>
    </div>
    <div class="right">
      <button class="btn danger" onclick="opCloseModal()">Annuler</button>
      <button class="btn" onclick="opSaveEdit()">Enregistrer</button>
    </div>
  </div>
</div>

<div id="farmModal" class="modal-wrap">
  <div class="modal-bg" onclick="farmCloseModal()"></div>
  <div class="modal">
    <h3>Modifier la ferme</h3>
    <div class="row">
      <input id="edit_farm_name" class="input">
      <input id="edit_farm_area" class="input">
    </div>
    <div class="row">
      <input id="edit_farm_company" class="input">
      <input id="edit_farm_location" class="input">
    </div>
    <div class="row">
      <input id="edit_farm_manager" class="input">
      <input id="edit_farm_phone" class="input">
    </div>
    <div class="right">
      <button class="btn danger" onclick="farmCloseModal()">Annuler</button>
      <button class="btn" onclick="farmSaveEdit()">Enregistrer</button>
    </div>
  </div>
</div>

<script>
/* ======= CONSTANTS ======= */
const LS_PROFILES='ab_profiles';
const LS_FARMS='ab_farms';
const LS_OPERATORS='ab_operators';
const LS_REFS='ab_refs';
const LS_APP='ab_appcfg';
const LS_IMG='ab_appimg';
const LS_SEC='ab_security';
const SETUP_ON = localStorage.getItem('ab_setup') === '1';

const DEFAULT_PROFILES=["Admin","Magasinier","Pointeur","Directeur"];
const APP_DEFAULT={
  appTitle:"AB AGRIWEB",
  nav:{home:"Accueil",irrig:"Irrigation",trait:"Traitement",settings:"ParamÃ¨tres",logout:"Logout"},
  tiles:{operators:"OPÃ‰RATEUR",profiles:"PROFILE",refs:"RÃ‰FÃ‰RENTIELS",appcfg:"BRANDING"},
  appBgColor:"#0f172a"
};

function g(id){return document.getElementById(id)}
function v(id){return g(id).value.trim()}
function s(id,val){if(g(id)) g(id).value = val || "";}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}

/* GUARD */
(function guard(){
  let ops=[];
  try{ops=JSON.parse(localStorage.getItem(LS_OPERATORS)||"[]");}catch{}
  if(!SETUP_ON && ops.length===0){
    alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ù…Ø³ØªØ®Ø¯Ù…. Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.");
    location="index.html";
  }
})();

/* SIDEBAR */
const sidebar=g('sidebar'),overlay=g('overlay');
g('menuBtn').onclick=()=>{sidebar.classList.add('open');overlay.classList.add('active')}
overlay.onclick=closeMenu;
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeMenu()});
function closeMenu(){sidebar.classList.remove('open');overlay.classList.remove('active')}
function setActiveLink(el){
  document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));
  el.classList.add('active');
}

/* PAGES */
const pages={
  home:g('page-home'),
  settings:g('page-settings'),
  profiles:g('page-profiles'),
  operators:g('page-operators'),
  farms:g('page-farms'),
  refs:g('page-refs'),
  appcfg:g('page-appcfg')
};
function showPage(name){
  Object.values(pages).forEach(p=>p.classList.add('hidden'));
  (pages[name]||pages.home).classList.remove('hidden');
  closeMenu();
}
function openPage(name){
  if(name==='appcfg') setActiveLink(g('nav-settings'));
  showPage(name);
}
function focusAcc(id){
  const acc=g(id);
  if(!acc) return;
  acc.classList.add('open');
  setTimeout(()=>acc.scrollIntoView({behavior:'smooth',block:'start'}),80);
}

/* sidebar links */
g('nav-home').onclick=e=>{e.preventDefault();setActiveLink(g('nav-home'));showPage('home')}
g('nav-settings').onclick=e=>{e.preventDefault();setActiveLink(g('nav-settings'));showPage('settings')}
g('nav-irrig').onclick=e=>{e.preventDefault();alert("Module Irrigation (Ù„Ø§Ø­Ù‚Ø§Ù‹).")}
g('nav-trait').onclick=e=>{e.preventDefault();alert("Module Traitement (Ù„Ø§Ø­Ù‚Ø§Ù‹).")}
g('nav-logout').onclick=e=>{e.preventDefault();location="index.html"}
function goSettings(){setActiveLink(g('nav-settings'));showPage('settings')}

/* STORAGE HELPERS */
function loadJSON(key,def){try{return JSON.parse(localStorage.getItem(key)||JSON.stringify(def))}catch{return def}}
function saveJSON(key,val){localStorage.setItem(key,JSON.stringify(val))}

/* APP CONFIG & BRANDING */
function appcfgLoad(){
  const stored = loadJSON(LS_APP,{});
  return {
    appTitle: stored.appTitle || APP_DEFAULT.appTitle,
    nav:Object.assign({},APP_DEFAULT.nav,stored.nav||{}),
    tiles:Object.assign({},APP_DEFAULT.tiles,stored.tiles||{}),
    appBgColor: stored.appBgColor || APP_DEFAULT.appBgColor
  };
}
function loadImgs(){
  return loadJSON(LS_IMG,{
    badge:null,sidebar:null,login:null,
    loginBg:null,logo:null,appBg:null
  });
}
function saveImgs(o){saveJSON(LS_IMG,o)}

function applyBackground(){
  const cfg=appcfgLoad();
  const imgs=loadImgs();
  if(imgs.appBg){
    document.body.style.backgroundImage=`url('${imgs.appBg}')`;
    document.body.style.backgroundSize='cover';
    document.body.style.backgroundPosition='center';
  }else if(cfg.appBgColor){
    document.body.style.backgroundImage='none';
    document.body.style.backgroundColor=cfg.appBgColor;
  }else{
    document.body.style.backgroundImage='none';
    document.body.style.backgroundColor=APP_DEFAULT.appBgColor;
  }
}

function appcfgApply(){
  const c=appcfgLoad();
  const imgs=loadImgs();

  document.title = c.appTitle + " - Dashboard";

  const titleEl=g('appTitleTop');
  if(imgs.logo){
    titleEl.innerHTML = `<img src="${imgs.logo}" style="height:24px;border-radius:6px;vertical-align:middle">`;
  }else{
    titleEl.textContent = c.appTitle;
  }

  // nav labels
  g('lbl-nav-home').textContent = c.nav.home;
  g('lbl-nav-irrig').textContent = c.nav.irrig;
  g('lbl-nav-trait').textContent = c.nav.trait;
  g('lbl-nav-settings').textContent = c.nav.settings;
  g('lbl-nav-logout').textContent = c.nav.logout;

  // tiles libellÃ©s
  g('lbl-tile-operators').textContent = c.tiles.operators;
  g('lbl-tile-profiles').textContent = c.tiles.profiles;
  g('lbl-tile-refs').textContent = c.tiles.refs;
  g('lbl-tile-appcfg').textContent = c.tiles.appcfg;

  // badge
  const badge=g('appBadgeImg');
  if(imgs.badge){badge.src=imgs.badge;badge.classList.remove('hidden');}
  else badge.classList.add('hidden');

  // accueil hint
  const ops = loadJSON(LS_OPERATORS,[]);
  if(ops.length===0) g('firstRunHint').classList.remove('hidden'); else g('firstRunHint').classList.add('hidden');

  applyBackground();
}

function appcfgFillForm(){
  const c=appcfgLoad();
  const imgs=loadImgs();

  s('cfg-app-title',c.appTitle);

  s('cfg-nav-home',c.nav.home);
  s('cfg-nav-irrig',c.nav.irrig);
  s('cfg-nav-trait',c.nav.trait);
  s('cfg-nav-settings',c.nav.settings);
  s('cfg-nav-logout',c.nav.logout);

  s('cfg-tile-operators',c.tiles.operators);
  s('cfg-tile-profiles',c.tiles.profiles);
  s('cfg-tile-refs',c.tiles.refs);
  s('cfg-tile-appcfg',c.tiles.appcfg);

  const sec = loadJSON(LS_SEC,{});
  s('sec-email',sec.email);
  s('sec-phone',sec.phone);
  s('sec-question',sec.question);
  s('sec-code',sec.recoveryCode?String(sec.recoveryCode):"");

  // branding values (URLs ÙÙ‚Ø· ÙƒÙ…Ø±Ø¬Ø¹)
  s('cfg-logo-url',imgs.logo||"");
  s('cfg-badge-url',imgs.badge||"");
  s('cfg-side-url',imgs.sidebar||"");
  s('cfg-login-url',imgs.login||"");
  s('cfg-loginbg-url',imgs.loginBg||"");
  s('cfg-appbg-url',imgs.appBg||"");
  if(g('cfg-appbg-color')) g('cfg-appbg-color').value = c.appBgColor || APP_DEFAULT.appBgColor;
}

/* helpers */
function isImgUrl(u){return /^https?:\/\//.test(u) && /\.(png|gif|jpe?g)(\?|#|$)/i.test(u)}
function fileToDataURL(file,cb){
  const r=new FileReader();
  r.onload=()=>cb(r.result);
  r.readAsDataURL(file);
}

/* file inputs */
['cfg-badge-file','cfg-side-file','cfg-login-file','cfg-loginbg-file','cfg-logo-file','cfg-appbg-file']
.forEach(id=>{
  const el=g(id); if(!el)return;
  el.addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f)return;
    fileToDataURL(f,data=>{
      const imgs=loadImgs();
      if(id==='cfg-badge-file') imgs.badge=data;
      if(id==='cfg-side-file') imgs.sidebar=data;
      if(id==='cfg-login-file') imgs.login=data;
      if(id==='cfg-loginbg-file') imgs.loginBg=data;
      if(id==='cfg-logo-file') imgs.logo=data;
      if(id==='cfg-appbg-file') imgs.appBg=data;
      saveImgs(imgs); appcfgApply();
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ âœ…');
    });
  });
});

function appcfgSave(){
  const cfg=appcfgLoad();
  const imgs=loadImgs();

  // titre app
  const t=v('cfg-app-title');
  cfg.appTitle = t || APP_DEFAULT.appTitle;

  // logo url
  const logoUrl=v('cfg-logo-url');
  if(logoUrl){
    if(!isImgUrl(logoUrl)) return alert('Logo: lien image ØºÙŠØ± ØµØ§Ù„Ø­');
    imgs.logo=logoUrl;
  }

  // nav
  cfg.nav.home = v('cfg-nav-home')||APP_DEFAULT.nav.home;
  cfg.nav.irrig = v('cfg-nav-irrig')||APP_DEFAULT.nav.irrig;
  cfg.nav.trait = v('cfg-nav-trait')||APP_DEFAULT.nav.trait;
  cfg.nav.settings = v('cfg-nav-settings')||APP_DEFAULT.nav.settings;
  cfg.nav.logout = v('cfg-nav-logout')||APP_DEFAULT.nav.logout;

  // tiles
  cfg.tiles.operators = v('cfg-tile-operators')||APP_DEFAULT.tiles.operators;
  cfg.tiles.profiles = v('cfg-tile-profiles')||APP_DEFAULT.tiles.profiles;
  cfg.tiles.refs = v('cfg-tile-refs')||APP_DEFAULT.tiles.refs;
  cfg.tiles.appcfg = v('cfg-tile-appcfg')||APP_DEFAULT.tiles.appcfg;

  // sÃ©curitÃ©
  const sec = loadJSON(LS_SEC,{});
  sec.email = v('sec-email');
  sec.phone = v('sec-phone');
  sec.question = v('sec-question');
  const ans = v('sec-answer');
  if(ans) sec.answerHash = hashLite(ans.toLowerCase());
  saveJSON(LS_SEC,sec);

  // branding URLs
  const badgeUrl=v('cfg-badge-url'); if(badgeUrl){ if(!isImgUrl(badgeUrl)) return alert('Badge URL ØºÙŠØ± ØµØ§Ù„Ø­'); imgs.badge=badgeUrl; }
  const sideUrl=v('cfg-side-url'); if(sideUrl){ if(!isImgUrl(sideUrl)) return alert('Sidebar URL ØºÙŠØ± ØµØ§Ù„Ø­'); imgs.sidebar=sideUrl; }
  const loginUrl=v('cfg-login-url'); if(loginUrl){ if(!isImgUrl(loginUrl)) return alert('Login banner URL ØºÙŠØ± ØµØ§Ù„Ø­'); imgs.login=loginUrl; }
  const loginBgUrl=v('cfg-loginbg-url'); if(loginBgUrl){ if(!isImgUrl(loginBgUrl)) return alert('Login background URL ØºÙŠØ± ØµØ§Ù„Ø­'); imgs.loginBg=loginBgUrl; }
  const appBgUrl=v('cfg-appbg-url'); if(appBgUrl){ if(!isImgUrl(appBgUrl)) return alert('App background URL ØºÙŠØ± ØµØ§Ù„Ø­'); imgs.appBg=appBgUrl; }

  // app background color
  const colEl=g('cfg-appbg-color');
  if(colEl && colEl.value) cfg.appBgColor = colEl.value;

  saveImgs(imgs);
  saveJSON(LS_APP,cfg);
  appcfgApply();
  appcfgFillForm();
  alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
}

function appcfgReset(){
  localStorage.removeItem(LS_APP);
  localStorage.removeItem(LS_IMG);
  localStorage.removeItem(LS_SEC);
  appcfgApply();
  appcfgFillForm();
  alert('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© âœ…');
}

/* SECURITY CODE */
function hashLite(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return String(h)}
function secGenCode(){
  const code = Math.floor(100000+Math.random()*900000);
  const sec = loadJSON(LS_SEC,{});
  sec.recoveryCode = code;
  saveJSON(LS_SEC,sec);
  s('sec-code',String(code));
  alert('Code gÃ©nÃ©rÃ©: '+code);
}

/* SETUP BANNER */
function showSetupBanner(){
  if(SETUP_ON) g('setupBanner').classList.remove('hidden');
  else g('setupBanner').classList.add('hidden');
}
function disableSetup(){
  localStorage.removeItem('ab_setup');
  alert('Setup Mode ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡. Ù„Ø§ ØªÙ†Ø³ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ OpÃ©rateurs.');
  location.reload();
}

/* PROFILES */
function loadProfiles(){return loadJSON(LS_PROFILES,[])}
function saveProfiles(d){saveJSON(LS_PROFILES,d)}
function renderProfiles(){
  const list=g('profilesList');
  const d=loadProfiles();
  if(d.length===0){list.innerHTML='<div class="item"><div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯.</div></div>';return;}
  list.innerHTML=d.map((name,i)=>`
    <div class="item">
      <div class="meta"><span><b>${escapeHtml(name)}</b></span></div>
      <div class="right">
        <button class="btn icon" onclick="editProfile(${i})">âœï¸</button>
        <button class="btn danger icon" onclick="removeProfile(${i})">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('');
}
function toggleProfileForm(sh){g('profileForm').classList.toggle('hidden',!sh)}
function addProfile(){
  const name=v('profileName');
  if(!name) return alert('Nom requis');
  const d=loadProfiles();
  if(d.some(x=>x.toLowerCase()===name.toLowerCase())) return alert('Profil existe dÃ©jÃ ');
  d.push(name);saveProfiles(d);s('profileName','');toggleProfileForm(false);renderProfiles();opRefreshProfileSelects();
}
function editProfile(i){
  const d=loadProfiles();
  const old=d[i];
  const nv=prompt('Modifier le profil:',old);
  if(nv===null) return;
  const val=nv.trim();
  if(!val) return alert('Nom vide');
  if(val.toLowerCase()!==old.toLowerCase() && d.some(x=>x.toLowerCase()===val.toLowerCase())) return alert('Existe dÃ©jÃ ');
  d[i]=val;saveProfiles(d);renderProfiles();opRefreshProfileSelects();
}
function removeProfile(i){
  const d=loadProfiles();
  if(!confirm('Supprimer le profil '+d[i]+' ?'))return;
  d.splice(i,1);saveProfiles(d);renderProfiles();opRefreshProfileSelects();
}

/* FARMS */
function loadFarms(){return loadJSON(LS_FARMS,[])}
function saveFarms(d){saveJSON(LS_FARMS,d)}
function farmToggleForm(sh){g('farmAddForm').classList.toggle('hidden',!sh)}
function farmAdd(){
  const o={
    name:v('farm_name'),
    area:v('farm_area'),
    company:v('farm_company'),
    location:v('farm_location'),
    manager:v('farm_manager'),
    phone:v('farm_phone')
  };
  if(!o.name) return alert('Nom de la ferme requis');
  const d=loadFarms();
  if(d.some(x=>x.name.toLowerCase()===o.name.toLowerCase())) return alert('Existe dÃ©jÃ ');
  d.push(o);saveFarms(d);farmToggleForm(false);renderFarms();opRefreshFarmCombos();
}
function renderFarms(){
  const list=g('farmsList');
  const d=loadFarms();
  if(d.length===0){list.innerHTML='<div class="item"><div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¶ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯.</div></div>';return;}
  list.innerHTML=d.map((f,i)=>`
    <div class="item">
      <div class="meta">
        <span><b>Ferme:</b> ${escapeHtml(f.name)}</span>
        ${f.area?`<span><b>Surf.:</b> ${escapeHtml(f.area)}</span>`:""}
        ${f.company?`<span><b>SociÃ©tÃ©:</b> ${escapeHtml(f.company)}</span>`:""}
        ${f.location?`<span><b>Lieu:</b> ${escapeHtml(f.location)}</span>`:""}
        ${f.manager?`<span><b>Resp.:</b> ${escapeHtml(f.manager)}</span>`:""}
        ${f.phone?`<span><b>TÃ©l:</b> ${escapeHtml(f.phone)}</span>`:""}
      </div>
      <div class="right">
        <button class="btn icon" onclick="farmEdit(${i})">âœï¸</button>
        <button class="btn danger icon" onclick="farmDelete(${i})">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('');
}
let farmEditIndex=null;
function farmEdit(i){
  const f=loadFarms()[i];farmEditIndex=i;
  s('edit_farm_name',f.name||'');
  s('edit_farm_area',f.area||'');
  s('edit_farm_company',f.company||'');
  s('edit_farm_location',f.location||'');
  s('edit_farm_manager',f.manager||'');
  s('edit_farm_phone',f.phone||'');
  g('farmModal').classList.add('show');
}
function farmCloseModal(){g('farmModal').classList.remove('show');farmEditIndex=null}
function farmSaveEdit(){
  if(farmEditIndex==null)return;
  const d=loadFarms();
  const cur=d[farmEditIndex];
  const n={
    name:v('edit_farm_name'),
    area:v('edit_farm_area'),
    company:v('edit_farm_company'),
    location:v('edit_farm_location'),
    manager:v('edit_farm_manager'),
    phone:v('edit_farm_phone')
  };
  if(!n.name) return alert('Nom requis');
  if(n.name.toLowerCase()!==cur.name.toLowerCase()
     && d.some(x=>x.name.toLowerCase()===n.name.toLowerCase()))
     return alert('Nom existe dÃ©jÃ ');
  d[farmEditIndex]=n;saveFarms(d);farmCloseModal();renderFarms();opRefreshFarmCombos();
}
function farmDelete(i){
  const d=loadFarms();
  if(!confirm('Supprimer la ferme '+d[i].name+' ?'))return;
  d.splice(i,1);saveFarms(d);renderFarms();opRefreshFarmCombos();
}

/* OPERATORS */
function loadOps(){return loadJSON(LS_OPERATORS,[])}
function saveOps(d){saveJSON(LS_OPERATORS,d)}
function opToggleForm(sh){
  g('opAddForm').classList.toggle('hidden',!sh);
  if(sh){opRefreshProfileSelects();opRefreshFarmCombos();}
}
function opBuildProfileOptions(id){
  const sel=g(id); if(!sel) return;
  const p=loadProfiles();
  sel.innerHTML = p.length ? p.map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join('')
                           : `<option value="">(Aucun profil)</option>`;
}
function opRefreshProfileSelects(){
  opBuildProfileOptions('op_profile');
  opBuildProfileOptions('edit_profile');
}
function comboFill(baseId,items){
  const input=g(baseId+'_input');
  const list=g(baseId+'_list');
  const hidden=g(baseId);
  if(!input || !list || !hidden) return;
  function render(q){
    const m=items.filter(x=>x.toLowerCase().includes((q||'').toLowerCase()));
    if(!m.length){list.innerHTML='<div class="combo-item muted">(aucun rÃ©sultat)</div>';return;}
    list.innerHTML=m.map(v=>`<div class="combo-item" data-v="${escapeHtml(v)}">${escapeHtml(v)}</div>`).join('');
  }
  input.oninput=()=>{list.classList.remove('hidden');render(input.value);}
  input.onfocus=()=>{list.classList.remove('hidden');render(input.value);}
  document.addEventListener('click',e=>{
    if(!list.contains(e.target) && e.target!==input) list.classList.add('hidden');
  });
  list.onclick=e=>{
    const it=e.target.closest('.combo-item'); if(!it || it.classList.contains('muted')) return;
    const val=it.getAttribute('data-v');
    input.value=val; hidden.value=val; list.classList.add('hidden');
  };
  render('');
}
function opRefreshFarmCombos(){
  const farms=loadFarms().map(f=>f.name);
  comboFill('op_ferme',farms);
  comboFill('edit_ferme',farms);
}
function renderOps(){
  const list=g('operatorsList');
  const d=loadOps();
  if(d.length===0){list.innerHTML='<div class="item"><div class="meta">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯.</div></div>';return;}
  list.innerHTML=d.map((u,i)=>`
    <div class="item">
      <div class="meta">
        <span><b>Utilisateur:</b> ${escapeHtml(u.username)}</span>
        <span><b>Profil:</b> ${escapeHtml(u.profile||'')}</span>
        <span><b>Ferme:</b> ${escapeHtml(u.ferme||'')}</span>
      </div>
      <div class="right">
        <button class="btn icon" onclick="opEdit(${i})">âœï¸</button>
        <button class="btn danger icon" onclick="opDelete(${i})">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('');
}
let editIndex=null;
function opEdit(i){
  const d=loadOps(),u=d[i];editIndex=i;
  s('edit_username',u.username);
  s('edit_password',u.password);
  opRefreshProfileSelects();
  g('edit_profile').value=u.profile||'';
  opRefreshFarmCombos();
  s('edit_ferme_input',u.ferme||'');
  s('edit_ferme',u.ferme||'');
  g('opModal').classList.add('show');
}
function opCloseModal(){g('opModal').classList.remove('show');editIndex=null}
function opSaveEdit(){
  if(editIndex==null)return;
  const d=loadOps(),u=d[editIndex];
  const nu=v('edit_username');
  const np=v('edit_password');
  const npr=g('edit_profile').value.trim();
  const nfe=v('edit_ferme');
  if(!nu||!np||!npr||!nfe) return alert('Remplir tous les champs.');
  if(nu.toLowerCase()!==u.username.toLowerCase()
     && d.some(x=>x.username.toLowerCase()===nu.toLowerCase()))
     return alert('Nom dÃ©jÃ  utilisÃ©.');
  d[editIndex]={username:nu,password:np,profile:npr,ferme:nfe};
  saveOps(d);opCloseModal();renderOps();
}
function opAdd(){
  const username=v('op_username');
  const password=v('op_password');
  const profile=g('op_profile').value.trim();
  const ferme=v('op_ferme');
  if(!username||!password||!profile||!ferme) return alert('Remplir tous les champs.');
  const d=loadOps();
  if(d.some(x=>x.username.toLowerCase()===username.toLowerCase()))
    return alert('Cet utilisateur existe dÃ©jÃ .');
  d.push({username,password,profile,ferme});
  saveOps(d);
  s('op_username','');s('op_password','');s('op_ferme_input','');s('op_ferme','');
  opToggleForm(false);renderOps();
}
function opDelete(i){
  const d=loadOps();
  if(!confirm('Supprimer '+d[i].username+' ?'))return;
  d.splice(i,1);saveOps(d);renderOps();
}

/* REFS */
const REF_KEYS={
  companies:"SociÃ©tÃ©s",
  responsables:"Responsables",
  stations:"Stations",
  secteurs:"Secteurs",
  parcelles:"Parcelles",
  transports:"Transports",
  varietes:"VariÃ©tÃ©s",
  varietes_champ:"VariÃ©tÃ©s champ",
  gestions:"Gestion stock",
  achats:"Achats"
};
function loadRefs(){
  const base={
    companies:[],responsables:[],stations:[],secteurs:[],
    parcelles:[],transports:[],varietes:[],varietes_champ:[],
    gestions:[],achats:[]
  };
  return Object.assign(base,loadJSON(LS_REFS,{}));
}
function saveRefs(o){saveJSON(LS_REFS,o)}
let currentRefKey=null;
function refsOpen(key){
  currentRefKey=key;
  g('refsHome').classList.add('hidden');
  g('refsCat').classList.remove('hidden');
  g('refsCatTitle').textContent=REF_KEYS[key]||'CatÃ©gorie';
  refsRender();
}
function refsRender(){
  const list=g('refsList');
  const refs=loadRefs();
  const arr=refs[currentRefKey]||[];
  if(arr.length===0){list.innerHTML='<div class="item"><div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</div></div>';return;}
  list.innerHTML=arr.map((name,i)=>`
    <div class="item">
      <div class="meta"><span><b>${escapeHtml(name)}</b></span></div>
      <div class="right">
        <button class="btn icon" onclick="refsEdit(${i})">âœï¸</button>
        <button class="btn danger icon" onclick="refsDelete(${i})">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('');
}
function refsToggleForm(sh){g('refsAddForm').classList.toggle('hidden',!sh);if(sh)g('refsInput').focus()}
function refsAdd(){
  const name=v('refsInput');
  if(!name) return alert('Nom requis');
  const refs=loadRefs();
  const arr=refs[currentRefKey]||[];
  if(arr.some(x=>x.toLowerCase()===name.toLowerCase())) return alert('Existe dÃ©jÃ ');
  arr.push(name);refs[currentRefKey]=arr;saveRefs(refs);s('refsInput','');refsToggleForm(false);refsRender();
}
function refsEdit(i){
  const refs=loadRefs();const arr=refs[currentRefKey]||[];
  const old=arr[i];
  const nv=prompt('Modifier:',old);
  if(nv===null)return;
  const val=nv.trim();
  if(!val) return alert('Nom vide');
  if(val.toLowerCase()!==old.toLowerCase() && arr.some(x=>x.toLowerCase()===val.toLowerCase()))
    return alert('Existe dÃ©jÃ ');
  arr[i]=val;refs[currentRefKey]=arr;saveRefs(refs);refsRender();
}
function refsDelete(i){
  const refs=loadRefs();const arr=refs[currentRefKey]||[];
  if(!confirm('Supprimer '+arr[i]+' ?'))return;
  arr.splice(i,1);refs[currentRefKey]=arr;saveRefs(refs);refsRender();
}

/* ACCORDION */
function toggleAcc(id){g(id).classList.toggle('open')}

/* INIT */
(function init(){
  if(!localStorage.getItem(LS_PROFILES)) saveProfiles(DEFAULT_PROFILES.slice());
  saveRefs(loadRefs());
  appcfgApply();
  appcfgFillForm();
  renderProfiles();
  renderFarms();
  renderOps();
  showSetupBanner();
})();
</script>
</body>
</html>
