<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AB AGRIWEB - Dashboard</title>
<style>
:root{
  --bg:#0f172a;
  --bg-soft:#020817;
  --panel:#0b1220;
  --text:#e2e8f0;
  --muted:#9ca3af;
  --accent:#22c55e;
  --border:#243046;
  --tile:#0c1526;
  --tileIcon:#0f1a2e;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
}
.hidden{display:none!important}

/* HEADER */
header{
  position:sticky;top:0;z-index:40;
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 14px;
  background:var(--panel);
  border-bottom:1px solid var(--border);
}
.left-head{display:flex;align-items:center;gap:10px}
.menu-btn{
  width:36px;height:36px;border-radius:10px;
  border:1px solid #111827;background:#020817;
  color:var(--text);display:flex;align-items:center;justify-content:center;
  font-size:20px;cursor:pointer;
}
.brand{display:flex;align-items:center;gap:8px}
#appTitleTop{
  font-weight:800;font-size:15px;letter-spacing:.4px;
  color:var(--accent);
}
#appBadgeImg{
  height:22px;border-radius:6px;border:1px solid #1f2937;
}

/* SIDEBAR */
.sidebar{
  position:fixed;top:0;left:-260px;width:260px;height:100%;
  background:#020817;border-right:1px solid var(--border);
  padding-top:52px;display:flex;flex-direction:column;
  transition:left .25s ease;z-index:35;
}
.sidebar.open{left:0}
.sidebar a{
  display:flex;align-items:center;gap:8px;
  padding:9px 14px;margin:2px 8px;
  border-radius:9px;font-size:13px;
  color:#cbd5e1;text-decoration:none;
}
.sidebar a span.emoji{width:18px;text-align:center}
.sidebar a:hover{background:#111827;color:#fff;}
.sidebar a.active{background:var(--accent);color:#020817;font-weight:700;}
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  opacity:0;pointer-events:none;transition:opacity .25s;z-index:30;
}
.overlay.active{opacity:1;pointer-events:auto;}

/* MAIN */
main.content{padding:16px}
.card{
  background:var(--bg-soft);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.35);
}
.card h2{margin-bottom:6px;font-size:18px}
.card p{font-size:13px;color:var(--muted)}
.hint{font-size:11px;color:#9ca3af;margin-top:2px}

/* Setup banner */
.setup-banner{
  border-radius:14px;
  border:1px dashed #facc15;
  background:rgba(250,204,21,0.04);
  padding:10px;
  margin-bottom:14px;
  font-size:12px;
  color:#fde68a;
}
.setup-actions{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}

/* Buttons & inputs */
.btn{
  padding:7px 10px;border-radius:8px;
  border:1px solid var(--accent);background:transparent;
  color:var(--accent);cursor:pointer;font-size:12px;
}
.btn:hover{background:var(--accent);color:#020817}
.btn.icon{width:28px;height:28px;display:flex;align-items:center;justify-content:center;padding:0}
.btn.danger{border-color:#ef4444;color:#fca5a5}
.btn.danger:hover{background:#ef4444;color:#020817}
.input,select,textarea{
  width:100%;max-width:340px;
  padding:8px 9px;
  border-radius:9px;
  border:1px solid #111827;
  background:#020817;color:#e5e7eb;
  font-size:12px;
}
.row{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
.label{display:block;font-size:10px;color:#9ca3af;margin-bottom:3px}

/* Tiles */
.stack{display:grid;gap:8px;margin-top:8px}
.tile{
  display:flex;align-items:center;gap:10px;
  padding:9px 11px;
  background:var(--tile);
  border-radius:12px;
  border:1px solid #111827;
  cursor:pointer;
}
.tile .icon{
  width:28px;height:28px;
  display:grid;place-items:center;
  background:var(--tileIcon);
  border-radius:9px;
  border:1px solid #1f2a44;
  font-size:15px;
}
.tile h4{margin:0;font-size:13px}
.tile p{margin:0;font-size:10px;color:var(--muted)}
.tile:hover{border-color:var(--accent);box-shadow:0 0 0 1px rgba(34,197,94,.15) inset}

/* Home quick modules */
.home-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
  gap:8px;
  margin-top:10px;
}
.home-card{
  background:#020817;
  border-radius:12px;
  border:1px solid #111827;
  padding:8px;
  display:flex;
  flex-direction:column;
  gap:2px;
  cursor:pointer;
}
.home-card .icon{
  width:22px;height:22px;
  display:grid;place-items:center;
  border-radius:7px;
  background:#052e16;
  font-size:13px;
  margin-bottom:2px;
}
.home-card strong{font-size:11px;color:#bbf7d0}
.home-card span{font-size:9px;color:#9ca3af}
.home-card:hover{
  border-color:var(--accent);
  box-shadow:0 10px 20px rgba(0,0,0,.4);
}

/* Lists */
.list{display:grid;gap:6px;margin-top:8px}
.item{
  display:grid;grid-template-columns:1fr auto;gap:6px;
  align-items:center;
  padding:7px 9px;
  background:#020817;
  border-radius:9px;
  border:1px solid #111827;
  font-size:11px;
}
.meta{display:flex;flex-wrap:wrap;gap:6px;color:#9ca3af}
.meta b{color:#e5e7eb}

/* Accordion */
.accordion{margin-top:10px;border-radius:12px;border:1px solid var(--border);background:#020817;}
.acc-hd{
  width:100%;padding:8px 9px;
  border:none;outline:none;
  background:#0c1526;
  color:var(--text);font-size:12px;
  display:flex;align-items:center;justify-content:space-between;
  border-radius:12px 12px 0 0;
  cursor:pointer;
}
.acc-bd{padding:9px;display:none;font-size:11px}
.acc.open .acc-bd{display:block}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px}

/* Combo list */
.combo{position:relative;max-width:340px}
.combo-list{
  position:absolute;left:0;right:0;top:100%;
  background:#020817;border:1px solid #111827;
  max-height:200px;overflow-y:auto;
  border-radius:9px;margin-top:3px;z-index:50;
}
.combo-item{padding:5px 7px;font-size:11px;cursor:pointer;border-bottom:1px solid #111827}
.combo-item:hover{background:#111827}

/* Modals */
.modal-wrap{position:fixed;inset:0;display:none;place-items:center;z-index:60}
.modal-wrap.show{display:grid}
.modal-bg{position:absolute;inset:0;background:rgba(0,0,0,.45);}
.modal{
  position:relative;z-index:61;
  width:min(460px,94vw);
  background:#020817;border-radius:14px;
  border:1px solid var(--border);
  padding:10px;
  box-shadow:0 20px 40px rgba(0,0,0,.6);
  font-size:12px;
}
.modal h3{margin-bottom:4px;font-size:14px}
.right{display:flex;justify-content:flex-end;gap:6px;margin-top:6px}

/* TOAST */
#toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  min-width:200px;
  max-width:90vw;
  padding:8px 12px;
  border-radius:10px;
  font-size:12px;
  display:none;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  z-index:80;
  box-shadow:0 12px 24px rgba(0,0,0,.5);
}
#toast.show{display:flex;}
#toast.success{background:#16a34a;color:#ecfdf5;border:1px solid #22c55e;}
#toast.error{background:#7f1d1d;color:#fee2e2;border:1px solid #ef4444;}
#toast.info{background:#111827;color:#e5e7eb;border:1px solid #4b5563;}
#toast button{
  background:transparent;border:none;color:inherit;
  cursor:pointer;font-size:14px;line-height:1;
}
</style>
</head>
<body>

<header>
  <div class="left-head">
    <button id="menuBtn" class="menu-btn">â˜°</button>
    <div class="brand">
      <div id="appTitleTop">AB AGRIWEB</div>
      <img id="appBadgeImg" class="hidden" alt="">
    </div>
  </div>
</header>

<!-- SIDEBAR -->
<aside id="sidebar" class="sidebar">
  <a href="#" id="nav-home" class="active"><span class="emoji">ğŸ </span><span id="lbl-nav-home">Accueil</span></a>
  <a href="#" id="nav-irrig"><span class="emoji">ğŸŒ¿</span><span id="lbl-nav-irrig">Irrigation</span></a>
  <a href="#" id="nav-trait"><span class="emoji">ğŸ’§</span><span id="lbl-nav-trait">Traitement</span></a>
  <a href="#" id="nav-settings"><span class="emoji">âš™ï¸</span><span id="lbl-nav-settings">ParamÃ¨tres</span></a>
  <a href="#" id="nav-logout"><span class="emoji">ğŸšª</span><span id="lbl-nav-logout">Logout</span></a>
</aside>
<div id="overlay" class="overlay"></div>

<main class="content">

  <!-- Setup banner -->
  <section id="setupBanner" class="setup-banner hidden">
    âš ï¸ Setup Mode Ù…ÙØ¹Ù‘Ù„: ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ø³Ø± ÙÙ‚Ø· Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. Ù„Ø§ ØªÙ†Ø³ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø­Ù‚ÙŠÙ‚ÙŠ.
    <div class="setup-actions">
      <button class="btn danger" onclick="disableSetup()">Ø¥ÙŠÙ‚Ø§Ù Setup Mode</button>
      <button class="btn" onclick="goSettings()">Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ParamÃ¨tres</button>
    </div>
  </section>

  <!-- Accueil -->
  <section id="page-home" class="card">
    <h2>Bienvenue ğŸ‘‹</h2>
    <p>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ AB AGRIWEB. Ø§Ø³ØªØ¹Ù…Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ù‚ÙŠ.</p>
    <div id="firstRunHint" class="hint hidden">
      ğŸ” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ <b>ParamÃ¨tres â†’ OpÃ©rateurs</b> ÙˆØ£Ø¶Ù Ø£ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù….
    </div>

    <!-- QUICK IRRIGATION MODULES -->
    <div class="home-grid">
      <div class="home-card" onclick="homeShortcut('parcelles')">
        <div class="icon">ğŸ“</div>
        <strong>Parcelles</strong>
        <span>ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø³Ù‚ÙŠØ© ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ø¶Ù‘ÙŠØ¹Ø§Øª.</span>
      </div>
      <div class="home-card" onclick="homeShortcut('planning')">
        <div class="icon">ğŸ“…</div>
        <strong>Plan dâ€™irrigation</strong>
        <span>Ø¨Ø±Ù…Ø¬Ø© Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø³Ù‚ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø·Ø¹Ø© ÙˆØ§Ù„Ù…Ø­ØµÙˆÙ„.</span>
      </div>
      <div class="home-card" onclick="homeShortcut('humidite')">
        <div class="icon">ğŸ’§</div>
        <strong>Suivi humiditÃ©</strong>
        <span>ØªØªØ¨Ø¹ Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø© Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù‚ÙŠ.</span>
      </div>
      <div class="home-card" onclick="homeShortcut('eau')">
        <div class="icon">ğŸš°</div>
        <strong>Consommation dâ€™eau</strong>
        <span>ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙŠØ§Ù‡ Ù„ÙƒÙ„ Ø¶ÙŠØ¹Ø©.</span>
      </div>
      <div class="home-card" onclick="homeShortcut('fertil')">
        <div class="icon">ğŸŒ±</div>
        <strong>Fertigation / Engrais</strong>
        <span>ØªØ¯ÙˆÙŠÙ† Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ù…Ø¯Ø© Ù…Ø¹ Ø§Ù„Ø³Ù‚ÙŠ.</span>
      </div>
      <div class="home-card" onclick="homeShortcut('alertes')">
        <div class="icon">âš ï¸</div>
        <strong>Alertes</strong>
        <span>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù„Ù†Ù‚Øµ Ø§Ù„Ø³Ù‚ÙŠ Ø£Ùˆ Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù….</span>
      </div>
      <div class="home-card" onclick="homeShortcut('hist')">
        <div class="icon">ğŸ“œ</div>
        <strong>Historique</strong>
        <span>Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ù‚ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.</span>
      </div>
      <div class="home-card" onclick="homeShortcut('meteo')">
        <div class="icon">â˜€ï¸</div>
        <strong>MÃ©tÃ©o & ETc</strong>
        <span>Ø±Ø¨Ø· Ù‚Ø±Ø§Ø± Ø§Ù„Ø³Ù‚ÙŠ Ø¨Ø§Ù„Ø£Ø­ÙˆØ§Ù„ Ø§Ù„Ø¬ÙˆÙŠØ© (ÙÙƒØ±Ø© Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©).</span>
      </div>
    </div>
  </section>

  <!-- ParamÃ¨tres (menu tuiles) -->
  <section id="page-settings" class="card hidden">
    <h2>ParamÃ¨tres</h2>
    <p class="hint">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¯Ø§Ø±ØªÙ‡.</p>
    <div class="stack">
      <div class="tile" onclick="openPage('operators')">
        <div class="icon">ğŸ‘¥</div>
        <div><h4 id="lbl-tile-operators">OPÃ‰RATEUR</h4><p>Gestion des utilisateurs</p></div>
      </div>
      <div class="tile" onclick="openPage('profiles')">
        <div class="icon">ğŸ§©</div>
        <div><h4 id="lbl-tile-profiles">PROFILE</h4><p>Profils & rÃ´les</p></div>
      </div>
      <div class="tile" onclick="openPage('rights')">
        <div class="icon">ğŸ›¡ï¸</div>
        <div><h4>Droit dâ€™accÃ¨s</h4><p>ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¨Ø³Ø·Ø© (ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)</p></div>
      </div>
      <div class="tile" onclick="openPage('refs')">
        <div class="icon">ğŸ—‚ï¸</div>
        <div><h4 id="lbl-tile-refs">RÃ‰FÃ‰RENTIELS</h4><p>Listes maÃ®tres</p></div>
      </div>
      <div class="tile" onclick="openPage('appcfg')">
        <div class="icon">ğŸ¨</div>
        <div><h4 id="lbl-tile-appcfg">BRANDING</h4><p>Ù„ÙˆØºÙˆØŒ Ø®Ù„ÙÙŠØ§ØªØŒ LibellÃ©s, SÃ©curitÃ©</p></div>
      </div>
    </div>
  </section>

  <!-- Profils -->
  <section id="page-profiles" class="card hidden">
    <div class="right">
      <button class="btn icon" onclick="toggleProfileForm(true)">ï¼‹</button>
    </div>
    <h2>Profils</h2>
    <p class="hint">Ø£Ø¶Ù Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (Admin, Magasinier, Pointeur, ...).</p>
    <div id="profileForm" class="row hidden">
      <input id="profileName" class="input" placeholder="Ex: Admin, Magasinier">
      <button class="btn" onclick="addProfile()">Ajouter</button>
      <button class="btn danger" onclick="toggleProfileForm(false)">Annuler</button>
    </div>
    <div id="profilesList" class="list"></div>
  </section>

  <!-- Droits dâ€™accÃ¨s -->
  <section id="page-rights" class="card hidden">
    <h2>Droit dâ€™accÃ¨s</h2>
    <p class="hint">ØªÙ…Ù‡ÙŠØ¯ Ø¨Ø³ÙŠØ· Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¨Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ ÙŠÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹.</p>
    <div class="list">
      <div class="item"><div class="meta"><b>Admin:</b> AccÃ¨s complet Ã  tous les modules.</div></div>
      <div class="item"><div class="meta"><b>Magasinier:</b> Stock, RÃ©fÃ©rentiels liÃ©s.</div></div>
      <div class="item"><div class="meta"><b>Pointeur:</b> Saisie quotidienne ÙÙ‚Ø·.</div></div>
    </div>
  </section>

  <!-- Operators -->
  <section id="page-operators" class="card hidden">
    <div class="right">
      <button class="btn icon" onclick="opToggleForm(true)">ï¼‹</button>
    </div>
    <h2>OpÃ©rateurs</h2>
    <p class="hint">Ù…Ø³ØªØ®Ø¯Ù…Ùˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆØ¶ÙŠØ¹Ø©.</p>
    <div id="opAddForm" class="row hidden">
      <input id="op_username" class="input" placeholder="Nom dâ€™utilisateur">
      <input id="op_password" type="password" class="input" placeholder="Mot de passe">
      <select id="op_profile" class="input"></select>
      <div class="combo">
        <input id="op_ferme_input" class="input" placeholder="Choisir une ferme...">
        <div id="op_ferme_list" class="combo-list hidden"></div>
      </div>
      <button class="btn" onclick="opAdd()">Ajouter</button>
      <button class="btn danger" onclick="opToggleForm(false)">Annuler</button>
    </div>
    <div id="operatorsList" class="list"></div>
  </section>

  <!-- Fermes -->
  <section id="page-farms" class="card hidden">
    <div class="right">
      <button class="btn icon" onclick="farmToggleForm(true)">ï¼‹</button>
    </div>
    <h2>Fermes</h2>
    <p class="hint">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¶ÙŠØ¹Ø§Øª.</p>
    <div id="farmAddForm" class="row hidden">
      <input id="farm_name" class="input" placeholder="Nom de la ferme">
      <input id="farm_area" class="input" placeholder="Surface">
      <input id="farm_company" class="input" placeholder="SociÃ©tÃ©">
      <input id="farm_location" class="input" placeholder="Emplacement">
      <input id="farm_manager" class="input" placeholder="Responsable">
      <input id="farm_phone" class="input" placeholder="TÃ©lÃ©phone">
      <button class="btn" onclick="farmAdd()">Ajouter</button>
      <button class="btn danger" onclick="farmToggleForm(false)">Annuler</button>
    </div>
    <div id="farmsList" class="list"></div>
  </section>

  <!-- RÃ©fÃ©rentiels -->
  <section id="page-refs" class="card hidden">
    <h2>RÃ©fÃ©rentiels</h2>
    <p class="hint">Ù„ÙˆØ§Ø¦Ø­ Ù…Ø±Ø¬Ø¹ÙŠØ©: Ø´Ø±ÙƒØ§ØªØŒ Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†ØŒ Ù…Ø­Ø·Ø§ØªØŒ Ù‚Ø·Ø§Ø¹Ø§ØªØŒ ...</p>
    <div id="refsHome" class="stack">
      <div class="tile" onclick="openPage('farms')"><div class="icon">ğŸï¸</div><div><h4>Fermes</h4></div></div>
      <div class="tile" onclick="refsOpen('companies')"><div class="icon">ğŸ¢</div><div><h4>SociÃ©tÃ©s</h4></div></div>
      <div class="tile" onclick="refsOpen('responsables')"><div class="icon">ğŸ‘¤</div><div><h4>Responsables</h4></div></div>
      <div class="tile" onclick="refsOpen('stations')"><div class="icon">ğŸš</div><div><h4>Stations</h4></div></div>
      <div class="tile" onclick="refsOpen('secteurs')"><div class="icon">ğŸ§­</div><div><h4>Secteurs</h4></div></div>
      <div class="tile" onclick="refsOpen('parcelles')"><div class="icon">ğŸ§±</div><div><h4>Parcelles</h4></div></div>
      <div class="tile" onclick="refsOpen('transports')"><div class="icon">ğŸšš</div><div><h4>Transports</h4></div></div>
      <div class="tile" onclick="refsOpen('varietes')"><div class="icon">ğŸŒ±</div><div><h4>VariÃ©tÃ©s</h4></div></div>
      <div class="tile" onclick="refsOpen('varietes_champ')"><div class="icon">ğŸŒ¿</div><div><h4>VariÃ©tÃ©s champ</h4></div></div>
      <div class="tile" onclick="refsOpen('gestions')"><div class="icon">ğŸ“¦</div><div><h4>Gestion stock</h4></div></div>
      <div class="tile" onclick="refsOpen('achats')"><div class="icon">ğŸ§¾</div><div><h4>Achats</h4></div></div>
    </div>

    <div id="refsCat" class="hidden" style="margin-top:12px">
      <div class="right">
        <button class="btn icon" onclick="refsToggleForm(true)">ï¼‹</button>
      </div>
      <h3 id="refsCatTitle" style="font-size:14px;margin-bottom:3px">CatÃ©gorie</h3>
      <div id="refsHint" class="hint">Ajouter / supprimer Ø¹Ù†Ø§ØµØ± Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©.</div>
      <div id="refsAddForm" class="row hidden">
        <input id="refsInput" class="input" placeholder="Nom Ã  ajouter">
        <button class="btn" onclick="refsAdd()">Ajouter</button>
        <button class="btn danger" onclick="refsToggleForm(false)">Annuler</button>
      </div>
      <div id="refsList" class="list"></div>
    </div>
  </section>

  <!-- RÃ©glages de lâ€™application -->
  <section id="page-appcfg" class="card hidden">
    <h2>RÃ©glages de lâ€™application</h2>
    <p class="hint">ØªØ­ÙƒÙ… ÙÙŠ: Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ Ø§Ù„Ù†ØµÙˆØµØŒ Ø§Ù„Ù„ÙˆØºÙˆØŒ Ø§Ù„Ø®Ù„ÙÙŠØ§ØªØŒ ÙˆØ£Ù…Ø§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨.</p>

    <!-- 1) LibellÃ©s -->
    <div id="acc-nav" class="accordion acc">
      <button class="acc-hd" onclick="toggleAcc('acc-nav')">
        1) LibellÃ©s Navigation
        <span>Accueil â€¢ Irrigation â€¢ Traitement â€¢ ParamÃ¨tres â€¢ Logout</span>
      </button>
      <div class="acc-bd">
        <div class="grid">
          <div><label class="label">Accueil</label><input id="cfg-nav-home" class="input"></div>
          <div><label class="label">Irrigation</label><input id="cfg-nav-irrig" class="input"></div>
          <div><label class="label">Traitement</label><input id="cfg-nav-trait" class="input"></div>
          <div><label class="label">ParamÃ¨tres</label><input id="cfg-nav-settings" class="input"></div>
          <div><label class="label">Logout</label><input id="cfg-nav-logout" class="input"></div>
        </div>
      </div>
    </div>

    <!-- 2) Tiles -->
    <div id="acc-tiles" class="accordion acc">
      <button class="acc-hd" onclick="toggleAcc('acc-tiles')">
        2) Tuiles ParamÃ¨tres
        <span>OpÃ©rateur â€¢ Profil â€¢ Droit dâ€™accÃ¨s â€¢ RÃ©fÃ©rentiels â€¢ Branding</span>
      </button>
      <div class="acc-bd">
        <div class="grid">
          <div><label class="label">OpÃ©rateur</label><input id="cfg-tile-operators" class="input"></div>
          <div><label class="label">Profil</label><input id="cfg-tile-profiles" class="input"></div>
          <div><label class="label">Droit dâ€™accÃ¨s</label><input id="cfg-tile-rights" class="input"></div>
          <div><label class="label">RÃ©fÃ©rentiels</label><input id="cfg-tile-refs" class="input"></div>
          <div><label class="label">Branding</label><input id="cfg-tile-appcfg" class="input"></div>
        </div>
      </div>
    </div>

    <!-- 3) SÃ©curitÃ© -->
    <div id="acc-sec" class="accordion acc">
      <button class="acc-hd" onclick="toggleAcc('acc-sec')">
        3) SÃ©curitÃ©
        <span>Email â€¢ TÃ©lÃ©phone â€¢ Question â€¢ Code</span>
      </button>
      <div class="acc-bd">
        <div class="grid">
          <div><label class="label">Email de rÃ©cupÃ©ration</label><input id="sec-email" class="input"></div>
          <div><label class="label">TÃ©lÃ©phone</label><input id="sec-phone" class="input"></div>
          <div><label class="label">Question secrÃ¨te</label><input id="sec-question" class="input"></div>
          <div><label class="label">RÃ©ponse</label><input id="sec-answer" class="input" placeholder="Saisir pour mettre Ã  jour"></div>
          <div>
            <label class="label">Code de rÃ©cupÃ©ration</label>
            <div class="row">
              <input id="sec-code" class="input" disabled>
              <button class="btn" onclick="secGenCode()">GÃ©nÃ©rer</button>
            </div>
            <div class="hint">ÙŠÙØ³ØªØ¹Ù…Ù„ ÙÙŠ â€œForgot passwordâ€ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 4) Branding -->
    <div id="acc-brand" class="accordion acc">
      <button class="acc-hd" onclick="toggleAcc('acc-brand')">
        4) Branding
        <span>Logo â€¢ Badge â€¢ Login background â€¢ Fond dashboard â€¢ Zoom logo</span>
      </button>
      <div class="acc-bd">
        <div class="grid">
          <div>
            <label class="label">Nom de lâ€™application</label>
            <input id="cfg-app-title" class="input" placeholder="AB AGRIWEB">
          </div>
          <div>
            <label class="label">Logo principal (PNG/GIF)</label>
            <input id="cfg-logo-url" class="input" placeholder="URL (png/gif)">
            <input id="cfg-logo-file" type="file" accept="image/png,image/gif" class="input">
          </div>
          <div>
            <label class="label">Badge header</label>
            <input id="cfg-badge-url" class="input" placeholder="URL (png/gif)">
            <input id="cfg-badge-file" type="file" accept="image/png,image/gif" class="input">
          </div>
          <div>
            <label class="label">Login background</label>
            <input id="cfg-loginbg-url" class="input" placeholder="URL (png/jpg/gif)">
            <input id="cfg-loginbg-file" type="file" accept="image/png,image/gif,image/jpeg" class="input">
          </div>
          <div>
            <label class="label">Fond dashboard (intÃ©rieur)</label>
            <input id="cfg-appbg-url" class="input" placeholder="URL (png/jpg/gif)">
            <input id="cfg-appbg-file" type="file" accept="image/png,image/gif,image/jpeg" class="input">
          </div>
          <div>
            <label class="label">Couleur fond dashboard</label>
            <input id="cfg-appbg-color" type="color" class="input" style="padding:0;height:34px;">
          </div>
          <div>
            <label class="label">Zoom logo horizontal</label>
            <input id="cfg-zoom-x" type="range" min="50" max="150" value="100" class="input">
          </div>
          <div>
            <label class="label">Zoom logo vertical</label>
            <input id="cfg-zoom-y" type="range" min="50" max="150" value="100" class="input">
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="appcfgSave()">Enregistrer</button>
      <button class="btn danger" onclick="appcfgReset()">Reset (dÃ©faut)</button>
    </div>
  </section>
</main>

<!-- Modals -->
<div id="opModal" class="modal-wrap">
  <div class="modal-bg" onclick="opCloseModal()"></div>
  <div class="modal">
    <h3>Modifier lâ€™opÃ©rateur</h3>
    <div class="row">
      <input id="edit_username" class="input">
      <input id="edit_password" type="password" class="input">
    </div>
    <div class="row">
      <select id="edit_profile" class="input"></select>
      <input id="edit_ferme" class="input" placeholder="Ferme">
    </div>
    <div class="right">
      <button class="btn danger" onclick="opCloseModal()">Annuler</button>
      <button class="btn" onclick="opSaveEdit()">Enregistrer</button>
    </div>
  </div>
</div>

<div id="farmModal" class="modal-wrap">
  <div class="modal-bg" onclick="farmCloseModal()"></div>
  <div class="modal">
    <h3>Modifier la ferme</h3>
    <div class="row">
      <input id="edit_farm_name" class="input">
      <input id="edit_farm_area" class="input">
    </div>
    <div class="row">
      <input id="edit_farm_company" class="input">
      <input id="edit_farm_location" class="input">
    </div>
    <div class="row">
      <input id="edit_farm_manager" class="input">
      <input id="edit_farm_phone" class="input">
    </div>
    <div class="right">
      <button class="btn danger" onclick="farmCloseModal()">Annuler</button>
      <button class="btn" onclick="farmSaveEdit()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="info">
  <span id="toast-msg"></span>
  <button onclick="hideToast()">âœ•</button>
</div>

<script>
/* KEYS */
const LS_PROFILES='ab_profiles';
const LS_FARMS='ab_farms';
const LS_OPERATORS='ab_operators';
const LS_REFS='ab_refs';
const LS_APP='ab_appcfg';
const LS_IMG='ab_appimg';
const LS_SEC='ab_security';
const LS_ZOOM='ab_zoom';
const SETUP_ON = localStorage.getItem('ab_setup') === '1';

const DEFAULT_PROFILES=["Admin","Magasinier","Pointeur","Directeur"];
const APP_DEFAULT={
  appTitle:"AB AGRIWEB",
  nav:{home:"Accueil",irrig:"Irrigation",trait:"Traitement",settings:"ParamÃ¨tres",logout:"Logout"},
  tiles:{operators:"OPÃ‰RATEUR",profiles:"PROFILE",rights:"Droit dâ€™accÃ¨s",refs:"RÃ‰FÃ‰RENTIELS",appcfg:"BRANDING"},
  appBgColor:"#0f172a"
};
const REF_LABELS={
  companies:"SociÃ©tÃ©s",
  responsables:"Responsables",
  stations:"Stations",
  secteurs:"Secteurs",
  parcelles:"Parcelles",
  transports:"Transports",
  varietes:"VariÃ©tÃ©s",
  varietes_champ:"VariÃ©tÃ©s champ",
  gestions:"Gestion stock",
  achats:"Achats"
};

function g(id){return document.getElementById(id)}
function loadJSON(k,def){try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def))}catch{return def}}
function saveJSON(k,v){localStorage.setItem(k,JSON.stringify(v))}

/* Toast helpers */
let toastTimer=null;
function showToast(msg,type='info'){
  const box=g('toast'), span=g('toast-msg');
  if(!box||!span) return alert(msg);
  span.textContent=msg;
  box.classList.remove('info','success','error');
  box.classList.add(type);
  box.classList.add('show');
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{box.classList.remove('show')},3000);
}
function hideToast(){
  const box=g('toast');
  if(box) box.classList.remove('show');
  if(toastTimer) clearTimeout(toastTimer);
}

/* home shortcuts (placeholder logic) */
function homeShortcut(key){
  const messages={
    parcelles:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø·Ø¹ Ø³ÙŠØªÙ… Ø±Ø¨Ø·Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ø¹ rÃ©fÃ©rentiels.",
    planning:"ØªØ®Ø·ÙŠØ· Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø³Ù‚ÙŠ : Ù…ÙŠØ²Ø© Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø§Ø³ØªØ¹Ù…Ø§Ù„ RÃ©fÃ©rentiels + Ù…Ù„Ø§Ø­Ø¸Ø§Øª.",
    humidite:"ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø© Ù„ÙƒÙ„ Ù‚Ø·Ø¹Ø© (Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± ÙˆØ§Ø¬Ù‡Ø© Ø®Ø§ØµØ©).",
    eau:"ØªØªØ¨Ø¹ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…ÙŠØ§Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¶ÙŠØ¹Ø§Øª (ÙÙƒØ±Ø© Ù…ÙØ¹Ù‘Ù„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹).",
    fertil:"ØªØ¯ÙˆÙŠÙ† Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ù…Ø¯Ø© Ù…Ø¹ Ø§Ù„Ø³Ù‚ÙŠ (fertigation).",
    alertes:"ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ù†Ø¯ ØªØ£Ø®Ø± Ø§Ù„Ø³Ù‚ÙŠ Ø£Ùˆ ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ…ÙŠØ§Øª.",
    hist:"Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ù‚ÙŠ.",
    meteo:"Ø±Ø¨Ø· Ù‚Ø±Ø§Ø± Ø§Ù„Ø³Ù‚ÙŠ Ø¨Ø§Ù„Ø·Ù‚Ø³ ÙˆÙ…Ø¹Ø§Ù…Ù„ ETc."
  };
  showToast(messages[key]||"Module en prÃ©paration.",'info');
}

/* GUARD */
(function guard(){
  let ops=[];
  try{ops=JSON.parse(localStorage.getItem(LS_OPERATORS)||"[]");}catch{}
  if(!SETUP_ON && ops.length===0){
    showToast("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ù…Ø³ØªØ®Ø¯Ù…. Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.","error");
    location="index.html";
  }
})();

/* SIDEBAR */
const sidebar=g('sidebar'),overlay=g('overlay');
g('menuBtn').onclick=()=>{sidebar.classList.add('open');overlay.classList.add('active')}
overlay.onclick=closeMenu;
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeMenu()});
function closeMenu(){sidebar.classList.remove('open');overlay.classList.remove('active')}
function setActiveLink(el){
  document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));
  el.classList.add('active');
}

/* PAGES */
const pages={
  home:g('page-home'),
  settings:g('page-settings'),
  profiles:g('page-profiles'),
  rights:g('page-rights'),
  operators:g('page-operators'),
  farms:g('page-farms'),
  refs:g('page-refs'),
  appcfg:g('page-appcfg')
};
function showPage(name){
  Object.values(pages).forEach(p=>p.classList.add('hidden'));
  (pages[name]||pages.home).classList.remove('hidden');
  closeMenu();
}
function openPage(name){
  if(['operators','profiles','rights','refs','appcfg','farms'].includes(name)){
    setActiveLink(g('nav-settings'));
  }
  showPage(name);
}
function goSettings(){setActiveLink(g('nav-settings'));showPage('settings')}

/* NAV */
g('nav-home').onclick=e=>{e.preventDefault();setActiveLink(g('nav-home'));showPage('home')}
g('nav-settings').onclick=e=>{e.preventDefault();setActiveLink(g('nav-settings'));showPage('settings')}
g('nav-irrig').onclick=e=>{e.preventDefault();showPage('home');showToast("Ø§Ø³ØªØ¹Ù…Ù„ ÙƒØ±ÙˆØª Accueil Ù„Ù„ÙˆØµÙˆÙ„ Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ù‚ÙŠ.","info")}
g('nav-trait').onclick=e=>{e.preventDefault();showToast("Module Traitement (Ù„Ø§Ø­Ù‚Ø§Ù‹).","info")}
g('nav-logout').onclick=e=>{e.preventDefault();location="index.html"}

/* APP CONFIG / BRANDING */
function appcfgLoad(){
  const stored = loadJSON(LS_APP,{});
  return {
    appTitle: stored.appTitle || APP_DEFAULT.appTitle,
    nav:Object.assign({},APP_DEFAULT.nav,stored.nav||{}),
    tiles:Object.assign({},APP_DEFAULT.tiles,stored.tiles||{}),
    appBgColor: stored.appBgColor || APP_DEFAULT.appBgColor
  };
}
function loadImgs(){return loadJSON(LS_IMG,{badge:null,loginBg:null,logo:null,appBg:null});}
function saveImgs(o){saveJSON(LS_IMG,o)}
function loadZoom(){return loadJSON(LS_ZOOM,{x:100,y:100})}
function saveZoom(z){saveJSON(LS_ZOOM,z)}

function isImgUrl(u){
  if(/^data:image\//i.test(u)) return true;
  return /^https?:\/\//i.test(u) && /\.(png|gif|jpe?g)(\?|#|$)/i.test(u);
}

function applyBackground(){
  const cfg=appcfgLoad();
  const imgs=loadImgs();
  if(imgs.appBg){
    document.body.style.backgroundImage=`url('${imgs.appBg}')`;
    document.body.style.backgroundSize='cover';
    document.body.style.backgroundPosition='center';
  }else{
    document.body.style.backgroundImage='none';
    document.body.style.backgroundColor=cfg.appBgColor || APP_DEFAULT.appBgColor;
  }
}

function appcfgApply(){
  const c=appcfgLoad();
  const imgs=loadImgs();

  document.title = c.appTitle + " - Dashboard";
  const titleEl=g('appTitleTop');
  if(imgs.logo){
    const zoom=loadZoom();
    titleEl.innerHTML = `<img src="${imgs.logo}" style="height:22px;border-radius:6px;vertical-align:middle;transform:scale(${zoom.x/100},${zoom.y/100});transform-origin:left center;">`;
  }else{
    titleEl.textContent = c.appTitle;
  }

  g('lbl-nav-home').textContent = c.nav.home;
  g('lbl-nav-irrig').textContent = c.nav.irrig;
  g('lbl-nav-trait').textContent = c.nav.trait;
  g('lbl-nav-settings').textContent = c.nav.settings;
  g('lbl-nav-logout').textContent = c.nav.logout;

  g('lbl-tile-operators').textContent = c.tiles.operators;
  g('lbl-tile-profiles').textContent = c.tiles.profiles;
  g('lbl-tile-refs').textContent = c.tiles.refs;
  g('lbl-tile-appcfg').textContent = c.tiles.appcfg;

  const badge=g('appBadgeImg');
  if(imgs.badge){badge.src=imgs.badge;badge.classList.remove('hidden');}
  else badge.classList.add('hidden');

  const ops = loadJSON(LS_OPERATORS,[]);
  g('firstRunHint').classList.toggle('hidden',ops.length>0);

  applyBackground();
}

function appcfgFillForm(){
  const c=appcfgLoad();
  const imgs=loadImgs();
  const sec = loadJSON(LS_SEC,{});
  const zoom = loadZoom();

  g('cfg-app-title').value = c.appTitle;

  g('cfg-nav-home').value = c.nav.home;
  g('cfg-nav-irrig').value = c.nav.irrig;
  g('cfg-nav-trait').value = c.nav.trait;
  g('cfg-nav-settings').value = c.nav.settings;
  g('cfg-nav-logout').value = c.nav.logout;

  g('cfg-tile-operators').value = c.tiles.operators;
  g('cfg-tile-profiles').value = c.tiles.profiles;
  g('cfg-tile-rights').value = c.tiles.rights || "Droit dâ€™accÃ¨s";
  g('cfg-tile-refs').value = c.tiles.refs;
  g('cfg-tile-appcfg').value = c.tiles.appcfg;

  g('sec-email').value = sec.email||"";
  g('sec-phone').value = sec.phone||"";
  g('sec-question').value = sec.question||"";
  g('sec-code').value = sec.recoveryCode?String(sec.recoveryCode):"";

  g('cfg-logo-url').value = imgs.logo||"";
  g('cfg-badge-url').value= imgs.badge||"";
  g('cfg-loginbg-url').value = imgs.loginBg||"";
  g('cfg-appbg-url').value = imgs.appBg||"";

  if(g('cfg-appbg-color') && c.appBgColor){
    g('cfg-appbg-color').value = c.appBgColor;
  }

  g('cfg-zoom-x').value = zoom.x;
  g('cfg-zoom-y').value = zoom.y;
}

/* Files â†’ base64 */
function fileToDataURL(file,cb){
  const r=new FileReader();
  r.onload=()=>cb(r.result);
  r.readAsDataURL(file);
}

/* file inputs */
['cfg-badge-file','cfg-loginbg-file','cfg-logo-file','cfg-appbg-file'].forEach(id=>{
  const el=g(id); if(!el)return;
  el.addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f)return;
    fileToDataURL(f,data=>{
      const imgs=loadImgs();
      if(id==='cfg-badge-file') imgs.badge=data;
      if(id==='cfg-loginbg-file') imgs.loginBg=data;
      if(id==='cfg-logo-file') imgs.logo=data;
      if(id==='cfg-appbg-file') imgs.appBg=data;
      saveImgs(imgs);
      appcfgApply();
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© âœ…','success');
    });
  });
});

function appcfgSave(){
  const cfg=appcfgLoad();
  const imgs=loadImgs();
  const sec = loadJSON(LS_SEC,{});
  const zoom = loadZoom();

  const t=g('cfg-app-title').value.trim();
  cfg.appTitle = t || APP_DEFAULT.appTitle;

  const logoUrl=g('cfg-logo-url').value.trim();
  if(logoUrl){
    if(!isImgUrl(logoUrl)) return showToast('Logo URL ØºÙŠØ± ØµØ§Ù„Ø­','error');
    imgs.logo=logoUrl;
  }

  cfg.nav.home = g('cfg-nav-home').value.trim()||APP_DEFAULT.nav.home;
  cfg.nav.irrig = g('cfg-nav-irrig').value.trim()||APP_DEFAULT.nav.irrig;
  cfg.nav.trait = g('cfg-nav-trait').value.trim()||APP_DEFAULT.nav.trait;
  cfg.nav.settings = g('cfg-nav-settings').value.trim()||APP_DEFAULT.nav.settings;
  cfg.nav.logout = g('cfg-nav-logout').value.trim()||APP_DEFAULT.nav.logout;

  cfg.tiles.operators = g('cfg-tile-operators').value.trim()||APP_DEFAULT.tiles.operators;
  cfg.tiles.profiles = g('cfg-tile-profiles').value.trim()||APP_DEFAULT.tiles.profiles;
  cfg.tiles.rights = g('cfg-tile-rights').value.trim()||APP_DEFAULT.tiles.rights;
  cfg.tiles.refs = g('cfg-tile-refs').value.trim()||APP_DEFAULT.tiles.refs;
  cfg.tiles.appcfg = g('cfg-tile-appcfg').value.trim()||APP_DEFAULT.tiles.appcfg;

  sec.email = g('sec-email').value.trim();
  sec.phone = g('sec-phone').value.trim();
  sec.question = g('sec-question').value.trim();
  const ans = g('sec-answer').value.trim();
  if(ans) sec.answerHash = hashLite(ans.toLowerCase());

  const badgeUrl=g('cfg-badge-url').value.trim();
  if(badgeUrl){
    if(!isImgUrl(badgeUrl)) return showToast('Badge URL ØºÙŠØ± ØµØ§Ù„Ø­','error');
    imgs.badge=badgeUrl;
  }

  const loginBgUrl=g('cfg-loginbg-url').value.trim();
  if(loginBgUrl){
    if(!isImgUrl(loginBgUrl)) return showToast('Login background URL ØºÙŠØ± ØµØ§Ù„Ø­','error');
    imgs.loginBg=loginBgUrl;
  }

  const appBgUrl=g('cfg-appbg-url').value.trim();
  if(appBgUrl){
    if(!isImgUrl(appBgUrl)) return showToast('Fond dashboard URL ØºÙŠØ± ØµØ§Ù„Ø­','error');
    imgs.appBg=appBgUrl;
  }

  const colEl=g('cfg-appbg-color');
  if(colEl && colEl.value) cfg.appBgColor = colEl.value;

  zoom.x = parseInt(g('cfg-zoom-x').value||'100',10);
  zoom.y = parseInt(g('cfg-zoom-y').value||'100',10);

  saveJSON(LS_SEC,sec);
  saveImgs(imgs);
  saveJSON(LS_APP,cfg);
  saveZoom(zoom);

  appcfgApply();
  appcfgFillForm();
  showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…','success');
}

function appcfgReset(){
  localStorage.removeItem(LS_APP);
  localStorage.removeItem(LS_IMG);
  localStorage.removeItem(LS_SEC);
  localStorage.removeItem(LS_ZOOM);
  appcfgApply();
  appcfgFillForm();
  showToast('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© âœ…','success');
}

/* SECURITY */
function hashLite(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return String(h)}
function secGenCode(){
  const code = Math.floor(100000+Math.random()*900000);
  const sec = loadJSON(LS_SEC,{});
  sec.recoveryCode = code;
  saveJSON(LS_SEC,sec);
  g('sec-code').value = String(code);
  showToast('Code gÃ©nÃ©rÃ©: '+code,'success');
}

/* SETUP */
function showSetupBanner(){
  g('setupBanner').classList.toggle('hidden',!SETUP_ON);
}
function disableSetup(){
  localStorage.removeItem('ab_setup');
  showToast('Setup Mode ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡.','success');
  location.reload();
}

/* PROFILES */
function getProfiles(){
  let list = loadJSON(LS_PROFILES,[]);
  if(!Array.isArray(list) || !list.length){
    list = DEFAULT_PROFILES.slice();
    saveJSON(LS_PROFILES,list);
  }
  return list;
}
function renderProfiles(){
  const list=getProfiles();
  const wrap=g('profilesList');wrap.innerHTML='';
  list.forEach((name,idx)=>{
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`<div>${name}</div>
      <div><button class="btn danger" onclick="delProfile(${idx})">ğŸ—‘ï¸</button></div>`;
    wrap.appendChild(div);
  });
}
function toggleProfileForm(show){g('profileForm').classList.toggle('hidden',!show)}
function addProfile(){
  const name=g('profileName').value.trim();
  if(!name) return showToast('Nom du profil obligatoire','error');
  const list=getProfiles();
  if(list.includes(name)) return showToast('Profil existe dÃ©jÃ ','error');
  list.push(name);
  saveJSON(LS_PROFILES,list);
  g('profileName').value='';
  toggleProfileForm(false);
  renderProfiles();
  fillProfilesSelects();
  showToast('Profil ajoutÃ©','success');
}
function delProfile(i){
  const list=getProfiles();
  if(!confirm('Supprimer ce profil ?'))return;
  list.splice(i,1);
  saveJSON(LS_PROFILES,list);
  renderProfiles();
  fillProfilesSelects();
}

/* FARMS */
function getFarms(){return loadJSON(LS_FARMS,[])}
function renderFarms(){
  const list=getFarms();
  const wrap=g('farmsList');wrap.innerHTML='';
  list.forEach((f,i)=>{
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`
      <div>
        <div><b>${f.name||'Sans nom'}</b></div>
        <div class="meta">
          ${f.area?'<span>'+f.area+'</span>':''}
          ${f.company?'<span>'+f.company+'</span>':''}
          ${f.location?'<span>'+f.location+'</span>':''}
        </div>
      </div>
      <div>
        <button class="btn danger" onclick="farmDelete(${i})">ğŸ—‘ï¸</button>
      </div>`;
    wrap.appendChild(div);
  });
}
function farmToggleForm(show){g('farmAddForm').classList.toggle('hidden',!show)}
function farmAdd(){
  const f={
    name:g('farm_name').value.trim(),
    area:g('farm_area').value.trim(),
    company:g('farm_company').value.trim(),
    location:g('farm_location').value.trim(),
    manager:g('farm_manager').value.trim(),
    phone:g('farm_phone').value.trim()
  };
  if(!f.name) return showToast('Nom de la ferme obligatoire','error');
  const list=getFarms();list.push(f);saveJSON(LS_FARMS,list);
  ['farm_name','farm_area','farm_company','farm_location','farm_manager','farm_phone'].forEach(id=>g(id).value='');
  farmToggleForm(false);
  renderFarms();
  fillFarmsCombo();
  showToast('Ferme ajoutÃ©e','success');
}
function farmDelete(i){
  const list=getFarms();
  if(!confirm('Supprimer cette ferme ?'))return;
  list.splice(i,1);saveJSON(LS_FARMS,list);
  renderFarms();fillFarmsCombo();
}
function farmCloseModal(){g('farmModal').classList.remove('show')}
function farmSaveEdit(){/* placeholder future */}

/* OPERATORS */
let editOpIndex=null;
function getOperators(){return loadJSON(LS_OPERATORS,[])}
function saveOperators(list){saveJSON(LS_OPERATORS,list)}

function fillProfilesSelects(){
  const profs=getProfiles();
  const selAdd=g('op_profile');
  const selEdit=g('edit_profile');
  if(selAdd){selAdd.innerHTML=profs.map(p=>`<option>${p}</option>`).join('')}
  if(selEdit){selEdit.innerHTML=profs.map(p=>`<option>${p}</option>`).join('')}
}
function fillFarmsCombo(){
  const farms=getFarms();
  const list=g('op_ferme_list');
  if(!list)return;
  list.innerHTML='';
  farms.forEach(f=>{
    const div=document.createElement('div');
    div.className='combo-item';
    div.textContent=f.name;
    div.onclick=()=>{
      g('op_ferme_input').value=f.name;
      list.classList.add('hidden');
    };
    list.appendChild(div);
  });
  g('op_ferme_input').onfocus=()=>{list.classList.remove('hidden')};
  g('op_ferme_input').onblur=()=>setTimeout(()=>list.classList.add('hidden'),150);
}
function renderOperators(){
  const ops=getOperators();
  const wrap=g('operatorsList');wrap.innerHTML='';
  ops.forEach((op,i)=>{
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`
      <div>
        <div><b>${op.username}</b> (${op.profile||''})</div>
        <div class="meta">
          ${op.ferme?'<span>Ferme: '+op.ferme+'</span>':''}
        </div>
      </div>
      <div>
        <button class="btn" onclick="opEdit(${i})">âœï¸</button>
        <button class="btn danger" onclick="opDelete(${i})">ğŸ—‘ï¸</button>
      </div>`;
    wrap.appendChild(div);
  });
}
function opToggleForm(show){g('opAddForm').classList.toggle('hidden',!show)}
function opAdd(){
  const u=g('op_username').value.trim();
  const p=g('op_password').value.trim();
  const prof=g('op_profile').value;
  const ferme=g('op_ferme_input').value.trim();
  if(!u||!p) return showToast('Username + password obligatoires','error');
  const ops=getOperators();
  if(ops.some(o=>o.username.toLowerCase()===u.toLowerCase()))
    return showToast('Utilisateur existe dÃ©jÃ ','error');
  ops.push({username:u,password:p,profile:prof,ferme});
  saveOperators(ops);
  ['op_username','op_password','op_ferme_input'].forEach(id=>g(id).value='');
  opToggleForm(false);
  renderOperators();
  showToast('OpÃ©rateur ajoutÃ©','success');
}
function opDelete(i){
  const ops=getOperators();
  if(!confirm('Supprimer cet opÃ©rateur ?'))return;
  ops.splice(i,1);saveOperators(ops);renderOperators();
}
function opEdit(i){
  const op=getOperators()[i];
  if(!op)return;
  editOpIndex=i;
  g('edit_username').value=op.username;
  g('edit_password').value=op.password;
  g('edit_profile').value=op.profile||'';
  g('edit_ferme').value=op.ferme||'';
  g('opModal').classList.add('show');
}
function opCloseModal(){g('opModal').classList.remove('show');editOpIndex=null}
function opSaveEdit(){
  if(editOpIndex==null)return;
  const ops=getOperators();
  const op=ops[editOpIndex];
  op.username=g('edit_username').value.trim();
  op.password=g('edit_password').value.trim();
  op.profile=g('edit_profile').value;
  op.ferme=g('edit_ferme').value.trim();
  saveOperators(ops);
  opCloseModal();
  renderOperators();
  showToast('OpÃ©rateur modifiÃ©','success');
}

/* REFS */
let currentRefCat=null;
function getRefs(){return loadJSON(LS_REFS,{})}
function saveRefs(data){saveJSON(LS_REFS,data)}
function refsOpen(cat){
  currentRefCat=cat;
  const all=getRefs();
  if(!all[cat]) all[cat]=[];
  saveRefs(all);
  g('refsHome').classList.add('hidden');
  g('refsCat').classList.remove('hidden');
  g('refsCatTitle').textContent=REF_LABELS[cat]||cat;
  refsRender();
}
function refsRender(){
  if(!currentRefCat)return;
  const all=getRefs();
  const list=all[currentRefCat]||[];
  const wrap=g('refsList');wrap.innerHTML='';
  if(!list.length){
    wrap.innerHTML='<div class="hint">Aucun Ã©lÃ©ment. Ø§Ø³ØªØ¹Ù…Ù„ Ø§Ù„Ø²Ø± + Ù„Ù„Ø¥Ø¶Ø§ÙØ©.</div>';
    return;
  }
  list.forEach((name,i)=>{
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`<div>${name}</div>
      <div><button class="btn danger" onclick="refsDelete(${i})">ğŸ—‘ï¸</button></div>`;
    wrap.appendChild(div);
  });
}
function refsToggleForm(show){g('refsAddForm').classList.toggle('hidden',!show)}
function refsAdd(){
  if(!currentRefCat)return;
  const val=g('refsInput').value.trim();
  if(!val) return showToast('Valeur vide','error');
  const all=getRefs();
  const list=all[currentRefCat]||[];
  if(list.includes(val)) return showToast('Existe dÃ©jÃ ','error');
  list.push(val);
  all[currentRefCat]=list;
  saveRefs(all);
  g('refsInput').value='';
  refsToggleForm(false);
  refsRender();
  showToast('AjoutÃ©','success');
}
function refsDelete(i){
  if(!currentRefCat)return;
  const all=getRefs();
  const list=all[currentRefCat]||[];
  if(!confirm('Supprimer ?'))return;
  list.splice(i,1);
  all[currentRefCat]=list;
  saveRefs(all);
  refsRender();
}

/* ACCORDION */
function toggleAcc(id){
  const acc=g(id);
  if(acc) acc.classList.toggle('open');
}

/* INIT */
document.addEventListener('DOMContentLoaded',()=>{
  if(!loadJSON(LS_PROFILES,[]).length) saveJSON(LS_PROFILES,DEFAULT_PROFILES);
  appcfgApply();
  appcfgFillForm();
  renderProfiles();
  renderFarms();
  renderOperators();
  fillProfilesSelects();
  fillFarmsCombo();
  showSetupBanner();
  showPage('home');
});
</script>
</body>
</html>
