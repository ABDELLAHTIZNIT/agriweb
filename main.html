<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AB AGRIWEB - Dashboard</title>
  <link rel="stylesheet" href="assets/css/base.css" />
</head>
<body>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar">
  <div class="sidebar-header">
    <span class="sidebar-title" id="sb-app-name">AB AGRIWEB</span>
  </div>
  <nav class="sidebar-nav">
    <button onclick="openPage('accueil')" class="nav-item" id="nav-accueil">ğŸ  Accueil</button>
    <button onclick="openPage('param')" class="nav-item" id="nav-param">âš™ï¸ ParamÃ¨tres</button>
    <button onclick="openPage('ref')" class="nav-item" id="nav-ref">ğŸ“š RÃ©fÃ©rentiel</button>
    <button onclick="openPage('irrigation')" class="nav-item" id="nav-irrig">ğŸ’§ Suivi irrigation</button>
    <button onclick="logout()" class="nav-item nav-danger">ğŸšª DÃ©connecter</button>
  </nav>
</aside>

<!-- Top bar -->
<header class="topbar">
  <button id="menuBtn" class="icon-btn" onclick="toggleSidebar()">â˜°</button>
  <div class="top-title" id="top-app-name">AB AGRIWEB</div>
  <img id="top-logo" class="top-logo" alt="Logo" />
</header>

<main class="page-wrap">

  <!-- ACCUEIL -->
  <section id="page-accueil" class="card">
    <h2>Bienvenue ğŸ‘‹</h2>
    <p>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ <span id="home-app-name">AB AGRIWEB</span>. Ø§Ø³ØªØ¹Ù…Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„.</p>
  </section>

  <!-- PARAMETRES (Branding + sÃ©curitÃ© Ø¨Ø³ÙŠØ·Ø©) -->
  <section id="page-param" class="card hidden">
    <h2>ParamÃ¨tres de l'application</h2>
    <p class="muted">ÙƒÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆØ¨Ø¹Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.</p>

    <h3>Branding & Logos</h3>
    <div class="stack">
      <div>
        <label class="label">Nom de l'application</label>
        <input id="cfg-app-name" class="input" placeholder="AB AGRIWEB" />
      </div>
      <div>
        <label class="label">Logo principal (PNG/GIF) - URL</label>
        <input id="cfg-logo-url" class="input" placeholder="https://...png" />
      </div>
      <div>
        <label class="label">Logo principal - Fichier</label>
        <input id="cfg-logo-file" class="input" type="file" accept="image/png,image/gif,image/jpeg" />
      </div>

      <div>
        <label class="label">Login background - URL (PNG/JPG/GIF)</label>
        <input id="cfg-login-bg-url" class="input" placeholder="https://...jpg" />
      </div>
      <div>
        <label class="label">Login background - Fichier</label>
        <input id="cfg-login-bg-file" class="input" type="file" accept="image/png,image/gif,image/jpeg" />
      </div>

      <div>
        <label class="label">Fond dashboard (intÃ©rieur) - URL</label>
        <input id="cfg-main-bg-url" class="input" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
      </div>
      <div>
        <label class="label">Couleur fond dashboard</label>
        <input id="cfg-main-bg-color" class="input" type="color" value="#020817" />
      </div>

      <div>
        <label class="label">Zoom logo horizontal</label>
        <input id="cfg-zoom-x" type="range" min="50" max="200" value="100" />
      </div>
      <div>
        <label class="label">Zoom logo vertical</label>
        <input id="cfg-zoom-y" type="range" min="50" max="200" value="100" />
      </div>
    </div>

    <div class="row right" style="margin-top:10px;gap:10px">
      <button class="btn danger" onclick="cfgReset()">Reset (dÃ©faut)</button>
      <button class="btn" onclick="cfgSave()">Enregistrer</button>
    </div>

    <h3 style="margin-top:20px">SÃ©curitÃ© (info ÙÙ‚Ø·)</h3>
    <p class="small muted">
      Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ù† (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŒ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØŒ Ø§Ù„ÙƒÙˆØ¯) ØªÙØ¯Ø§Ø± Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
      (Operators / SÃ©curitÃ©). Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø· Ù„Ù„Ù…Ø¸Ù‡Ø±.
    </p>
  </section>

  <!-- REFERENTIEL -->
  <section id="page-ref" class="card hidden">
    <h2>RÃ©fÃ©rentiel</h2>
    <p class="muted">ØªÙ†Ø¸ÙŠÙ… SociÃ©tÃ© &gt; Ferme &gt; Secteur &gt; Parcelle &gt; Point.</p>

    <div class="ref-grid">

      <!-- SociÃ©tÃ© -->
      <div class="ref-box">
        <h3>SociÃ©tÃ©s</h3>
        <div class="row">
          <input id="rf-societe-name" class="input" placeholder="Nom sociÃ©tÃ©" />
          <button class="btn" onclick="rfAddSociete()">+</button>
        </div>
        <ul id="rf-societe-list" class="ref-list"></ul>
      </div>

      <!-- Ferme -->
      <div class="ref-box">
        <h3>Fermes</h3>
        <div class="row">
          <select id="rf-ferme-societe" class="input small"></select>
          <input id="rf-ferme-name" class="input" placeholder="Nom ferme" />
          <button class="btn" onclick="rfAddFerme()">+</button>
        </div>
        <ul id="rf-ferme-list" class="ref-list"></ul>
      </div>

      <!-- Secteur -->
      <div class="ref-box">
        <h3>Secteurs</h3>
        <div class="row">
          <select id="rf-sect-ferme" class="input small"></select>
          <input id="rf-sect-name" class="input" placeholder="Nom secteur" />
          <button class="btn" onclick="rfAddSecteur()">+</button>
        </div>
        <ul id="rf-sect-list" class="ref-list"></ul>
      </div>

      <!-- Parcelle -->
      <div class="ref-box">
        <h3>Parcelles</h3>
        <div class="row">
          <select id="rf-parc-ferme" class="input small"></select>
          <select id="rf-parc-secteur" class="input small"></select>
          <input id="rf-parc-name" class="input" placeholder="Nom parcelle" />
          <button class="btn" onclick="rfAddParcelle()">+</button>
        </div>
        <ul id="rf-parc-list" class="ref-list"></ul>
      </div>

      <!-- Point -->
      <div class="ref-box">
        <h3>Points</h3>
        <div class="row">
          <select id="rf-pt-ferme" class="input small"></select>
          <select id="rf-pt-secteur" class="input small"></select>
          <select id="rf-pt-parcelle" class="input small"></select>
          <input id="rf-pt-name" class="input" placeholder="Point ex: P1" />
          <button class="btn" onclick="rfAddPoint()">+</button>
        </div>
        <ul id="rf-pt-list" class="ref-list"></ul>
      </div>

    </div>

    <p class="small muted" style="margin-top:8px">
      Ø£Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù†ØµØ± Ù„Ø­Ø°ÙÙ‡.
      Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ <code>localStorage</code> Ù„Ù„Ù…ØªØµÙØ­.
    </p>
  </section>

  <!-- Suivi irrigation -->
  <!-- (Ù†ÙØ³ Ø§Ù„Ø³ÙƒØ´Ù† Ø§Ù„Ù„ÙŠ Ø¹Ø·ÙŠØªÙƒ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŒ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±) -->
  <section id="page-irrigation" class="card hidden">
    <h2>Suivi irrigation</h2>
    <p class="muted">
      Ø§Ø®ØªØ± Ferme / Secteur / Parcelle / Point Ø«Ù… Ø§Ø³ØªØ¹Ù…Ù„ Ø²Ø± <b>Irrigation</b> Ù„Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª.
    </p>

    <div class="stack">

      <div>
        <label class="label">Ferme</label>
        <select id="sv-ferme" class="input" onchange="svOnFermeChange()">
          <option value="">-- Ø§Ø®ØªØ± Ferme --</option>
        </select>
      </div>

      <div>
        <label class="label">Secteur</label>
        <select id="sv-secteur" class="input" onchange="svOnSecteurChange()">
          <option value="">-- Ø§Ø®ØªØ± Secteur --</option>
        </select>
      </div>

      <div>
        <label class="label">Parcelle</label>
        <select id="sv-parcelle" class="input" onchange="svOnParcelleChange()">
          <option value="">-- Ø§Ø®ØªØ± Parcelle --</option>
        </select>
      </div>

      <div>
        <label class="label">Point</label>
        <select id="sv-point" class="input">
          <option value="">-- Ø§Ø®ØªØ± Point --</option>
        </select>
      </div>

      <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:8px">
        <button class="btn" onclick="svOpenTable()">Irrigation</button>
        <button class="btn" onclick="svOpenAdd()">Ajouter</button>
        <button class="btn" onclick="svShare()">Partager</button>
        <button class="btn" onclick="svExportExcel()">Exporter Excel</button>
        <button class="btn" onclick="svExportPDF()">Exporter PDF</button>
      </div>
    </div>
  </section>

</main>

<!-- Modal: Ajouter mesure -->
<div id="sv-add-modal" class="modal-wrap">
  <div class="modal-bg" onclick="svCloseAdd()"></div>
  <div class="modal">
    <h3>Ajouter une mesure d'irrigation</h3>
    <p class="small">Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ù…Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª.</p>
    <div class="grid">
      <div>
        <label class="label">Tours / Heures</label>
        <input id="sv-tours" class="input" type="text" placeholder="Ex: 3 tours ou 6h">
      </div>
      <div>
        <label class="label">DurÃ©e (min)</label>
        <input id="sv-duree" class="input" type="number" min="0" placeholder="Ex: 45">
      </div>
      <div>
        <label class="label">Temps repos</label>
        <input id="sv-repos" class="input" type="text" placeholder="Ex: 15 min">
      </div>
      <div>
        <label class="label">V apport</label>
        <input id="sv-vapport" class="input" type="text">
      </div>
      <div>
        <label class="label">EC apport</label>
        <input id="sv-ecapport" class="input" type="text">
      </div>
      <div>
        <label class="label">pH apport</label>
        <input id="sv-phapport" class="input" type="text">
      </div>
      <div>
        <label class="label">V drainage</label>
        <input id="sv-vdrain" class="input" type="text">
      </div>
      <div>
        <label class="label">EC drainage</label>
        <input id="sv-ecdrain" class="input" type="text">
      </div>
      <div>
        <label class="label">pH drainage</label>
        <input id="sv-phdrain" class="input" type="text">
      </div>
      <div>
        <label class="label">% drainage</label>
        <input id="sv-pctdrain" class="input" type="text">
      </div>
    </div>

    <div class="right" style="margin-top:10px">
      <button class="btn danger" onclick="svCloseAdd()">âœ•</button>
      <button class="btn" onclick="svSaveAdd()">âœ“ Enregistrer</button>
    </div>
  </div>
</div>

<!-- Modal: Tableau irrigation -->
<div id="sv-table-modal" class="modal-wrap">
  <div class="modal-bg" onclick="svCloseTable()"></div>
  <div class="modal" style="max-width:980px">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <div>
        <h3 style="margin:0">Irrigation - Tableau</h3>
        <div id="sv-table-title" class="small muted"></div>
      </div>
      <div class="row" style="gap:6px">
        <button class="btn" onclick="svExportExcel()">Excel</button>
        <button class="btn" onclick="svExportPDF()">PDF / Imprimer</button>
        <button class="btn danger" onclick="svCloseTable()">âœ•</button>
      </div>
    </div>
    <div class="muted small">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø·Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø­Ø°Ù.</div>
    <div style="overflow-x:auto;margin-top:6px">
      <table id="sv-table" style="width:100%;border-collapse:collapse;font-size:12px">
        <thead>
          <tr>
            <th>#</th>
            <th>Point</th>
            <th>Tours / Heures</th>
            <th>DurÃ©e (min)</th>
            <th>Temps repos</th>
            <th>V apport</th>
            <th>EC apport</th>
            <th>pH apport</th>
            <th>V drainage</th>
            <th>EC drainage</th>
            <th>pH drainage</th>
            <th>% drainage</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script src="assets/js/core/ref.js"></script>
<script src="assets/js/pages/irrigation.js"></script>
<script>
/* Helpers */
const LS_APPCFG='ab_appcfg';
function g(id){return document.getElementById(id);}
function v(id){const el=g(id);return el?el.value.trim():'';}
function escapeHtml(s){return (s||'').replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c]));}

/* Layout */
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
}
function openPage(key){
  ['accueil','param','ref','irrigation'].forEach(k=>{
    g('page-'+k).classList.toggle('hidden',k!==key);
  });
  document.getElementById('sidebar').classList.remove('open');
}

/* Logout Ø¨Ø³ÙŠØ· */
function logout(){
  localStorage.removeItem('ab_setup');
  window.location.href='index.html';
}

/* APPCFG (branding) */
function cfgLoad(){
  try{return JSON.parse(localStorage.getItem(LS_APPCFG)||'{}')}catch{return{}}
}
function cfgApply(){
  const c=cfgLoad();
  const name=c.appName||'AB AGRIWEB';
  g('top-app-name').textContent=name;
  g('home-app-name').textContent=name;
  g('sb-app-name').textContent=name;

  // Logo
  const logo = c.logo || '';
  const img = g('top-logo');
  if(logo){
    img.src=logo; img.style.display='block';
  }else{
    img.style.display='none';
  }

  // Dashboard bg
  if(c.mainBgUrl){
    document.body.style.backgroundImage=`url('${c.mainBgUrl}')`;
    document.body.style.backgroundSize='cover';
    document.body.style.backgroundAttachment='fixed';
  }else{
    document.body.style.backgroundImage='none';
    document.body.style.backgroundColor=c.mainBgColor||'#020817';
  }
}
function cfgFillForm(){
  const c=cfgLoad();
  g('cfg-app-name').value = c.appName||'';
  g('cfg-logo-url').value = c.logoUrl||'';
  g('cfg-login-bg-url').value = c.loginBgUrl||'';
  g('cfg-main-bg-url').value = c.mainBgUrl||'';
  g('cfg-main-bg-color').value = c.mainBgColor||'#020817';
  g('cfg-zoom-x').value = (c.zoomX||100);
  g('cfg-zoom-y').value = (c.zoomY||100);
}
function fileToDataUrl(input, cb){
  const f=input.files[0]; if(!f){cb(null);return;}
  const r=new FileReader();
  r.onload=e=>cb(e.target.result);
  r.readAsDataURL(f);
}
function cfgSave(){
  const cur=cfgLoad();
  const cfg={
    ...cur,
    appName:v('cfg-app-name')||'AB AGRIWEB',
    logoUrl:v('cfg-logo-url')||'',
    loginBgUrl:v('cfg-login-bg-url')||'',
    mainBgUrl:v('cfg-main-bg-url')||'',
    mainBgColor:g('cfg-main-bg-color').value||'#020817',
    zoomX:parseInt(g('cfg-zoom-x').value||'100',10),
    zoomY:parseInt(g('cfg-zoom-y').value||'100',10)
  };
  // handle files async-ish: logo file Ø«Ù… login bg file
  fileToDataUrl(g('cfg-logo-file'), data=>{
    if(data) cfg.logo=data; else if(cfg.logoUrl) cfg.logo=cfg.logoUrl;
    fileToDataUrl(g('cfg-login-bg-file'), data2=>{
      if(data2) cfg.loginBg=data2; else if(cfg.loginBgUrl) cfg.loginBg=cfg.loginBgUrl;
      localStorage.setItem(LS_APPCFG,JSON.stringify(cfg));
      cfgApply();
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âœ…');
    });
  });
}
function cfgReset(){
  if(!confirm('Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ'))return;
  localStorage.removeItem(LS_APPCFG);
  cfgApply(); cfgFillForm();
}

/* INIT */
(function init(){
  cfgApply();
  cfgFillForm();
  rfInit();       // from ref.js
  svFillFarm();   // from irrigation.js
  openPage('accueil');
})();
</script>
</body>
</html>
