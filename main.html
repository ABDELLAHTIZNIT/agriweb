<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AB AGRIWEB - Dashboard</title>
<style>
:root{
  --bg:#0f172a;--panel:#0b1220;--text:#e2e8f0;--accent:#22c55e;
  --border:#243046;--tile:#0c1526;--tileIcon:#0f1a2e;--warn:#fde68a1a
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:linear-gradient(180deg,var(--bg),#1e293b);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
}
.hidden{display:none!important}

/* HEADER */
header{
  position:sticky;top:0;z-index:40;
  display:flex;align-items:center;justify-content:space-between;
  background:var(--panel);padding:10px 14px;
  border-bottom:1px solid var(--border);
}
.menu-btn{
  width:40px;height:40px;border-radius:10px;
  border:1px solid #111827;background:#020817;
  color:var(--text);font-size:20px;
  display:grid;place-items:center;cursor:pointer;
}
.brand{display:flex;align-items:center;gap:10px}
#appTitleTop{
  font-weight:800;letter-spacing:.4px;color:var(--accent);
}
#appBadgeImg{
  height:22px;border-radius:6px;border:1px solid #1f2937;
}

/* SIDEBAR */
.sidebar{
  position:fixed;top:0;left:-260px;width:260px;height:100%;
  background:#020817;
  border-right:1px solid var(--border);
  transition:left .3s ease;
  display:flex;flex-direction:column;
  padding-top:52px;
  box-shadow:4px 0 18px rgba(0,0,0,.45);
  z-index:35;
}
.sidebar.open{left:0}
.side-header{
  position:absolute;top:0;left:0;right:0;
  height:52px;display:flex;align-items:center;gap:8px;
  padding:0 10px;
  background:#020817;border-bottom:1px solid #111827;
}
.close-btn{
  width:32px;height:32px;border-radius:8px;
  border:none;background:#0f172a;color:#e5e7eb;
  font-size:20px;cursor:pointer;
}
.sidebar h3{
  margin:6px 10px 4px;font-size:13px;
  text-transform:uppercase;color:#6b7280;
}
.sidebar a{
  display:flex;align-items:center;gap:8px;
  padding:9px 14px;margin:2px 8px;
  color:#cbd5e1;text-decoration:none;
  border-radius:10px;font-size:14px;
}
.sidebar a:hover{
  background:#111827;color:#fff;
}
.sidebar a.active{
  background:var(--accent);color:#020817;font-weight:700;
}
.sidebar-brand{
  margin:10px;padding:6px 8px;
  border-radius:10px;border:1px solid #111827;
  background:#020817;
}
.sidebar-brand img{
  width:100%;border-radius:8px;
}

/* OVERLAY */
.overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  opacity:0;pointer-events:none;
  transition:opacity .25s;
  z-index:30;
}
.overlay.active{
  opacity:1;pointer-events:auto;
}

/* CONTENT */
main.content{padding:16px}
.card{
  max-width:1100px;margin:14px auto;
  background:#020817;
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px 14px 16px;
  box-shadow:0 10px 26px rgba(0,0,0,.35);
  position:relative;
}
h2{margin:0 0 6px}
.muted{font-size:13px;opacity:.85}

.stack{display:grid;gap:10px}
.tile{
  display:flex;align-items:center;gap:10px;
  background:var(--tile);
  border-radius:12px;
  padding:12px 14px;
  border:1px solid #111827;
  cursor:pointer;
}
.tile .icon{
  width:34px;height:34px;
  display:grid;place-items:center;
  background:var(--tileIcon);
  border-radius:10px;
  border:1px solid #1f2a44;
  font-size:18px;
}
.tile:hover{
  border-color:var(--accent);
  box-shadow:0 0 0 1px rgba(34,197,94,.26);
}

/* Buttons & Inputs */
.actions-top{
  position:absolute;top:10px;right:10px;
  display:flex;gap:6px;
}
.btn{
  padding:8px 10px;
  border-radius:9px;
  border:1px solid var(--accent);
  background:transparent;
  color:var(--accent);
  cursor:pointer;
  font-size:13px;
}
.btn.icon{
  width:32px;height:32px;padding:0;
  display:grid;place-items:center;
}
.btn:hover{background:var(--accent);color:#020817}
.btn.danger{
  border-color:#ef4444;color:#fca5a5;
}
.btn.danger:hover{
  background:#ef4444;color:#020817;
}
.row{display:flex;gap:8px;flex-wrap:wrap}
.input,select,textarea{
  width:100%;max-width:340px;
  padding:9px 10px;
  border-radius:9px;
  border:1px solid #111827;
  background:#020817;
  color:#e5e7eb;
  font-size:13px;
}
.list{display:grid;gap:8px;margin-top:12px}
.item{
  display:grid;grid-template-columns:1fr auto;
  gap:6px;align-items:center;
  background:#020817;
  border-radius:10px;
  padding:9px 10px;
  border:1px solid #111827;
}
.meta{
  display:flex;flex-wrap:wrap;
  gap:8px;font-size:12px;color:#9ca3af;
}
.meta b{color:#e5e7eb}
.actions{display:flex;gap:6px}
.label{
  display:block;margin-bottom:3px;
  font-size:11px;color:#9ca3af;
}
.sectionTitle{margin:10px 0 4px;font-weight:700;color:#e5e7eb}

/* Accordion */
.accordion{
  border:1px solid #111827;
  border-radius:10px;
  margin:10px 0;
  background:#020817;
}
.acc-hd{
  width:100%;padding:8px 10px;
  background:#020817;
  border:none;
  border-radius:10px 10px 0 0;
  color:#e5e7eb;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
  font-size:13px;
}
.acc-hd span{font-weight:400;font-size:11px;color:#9ca3af}
.acc-bd{
  display:none;
  padding:10px;
  border-top:1px solid #111827;
}
.acc.open .acc-bd{display:block}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:8px;
}

/* Combo dropdown */
.combo{position:relative}
.combo-list{
  position:absolute;left:0;right:0;top:100%;
  background:#020817;
  border:1px solid #111827;
  border-radius:8px;
  max-height:180px;
  overflow:auto;
  z-index:60;
  margin-top:3px;
}
.combo-item{
  padding:6px 8px;font-size:12px;cursor:pointer;
  border-bottom:1px solid #020817;
}
.combo-item:hover{background:#111827}

/* Modals */
.modal-wrap{
  position:fixed;inset:0;
  display:grid;place-items:center;
  z-index:80;
}
.modal-wrap:not(.show){display:none}
.modal-bg{
  position:absolute;inset:0;
  background:rgba(0,0,0,.5);
}
.modal{
  position:relative;
  width:min(480px,92vw);
  background:#020817;
  border-radius:12px;
  border:1px solid #111827;
  padding:12px;
  box-shadow:0 20px 40px rgba(0,0,0,.6);
}
.modal h3{margin:0 0 6px;font-size:15px}
.right{display:flex;gap:6px;justify-content:flex-end}
.hint{
  background:var(--warn);
  border:1px dashed #fbbf24;
  color:#fcd34d;
  padding:6px 7px;
  border-radius:8px;
  font-size:11px;margin-top:6px;
}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <button class="menu-btn" id="menuBtn">â˜°</button>
  <div class="brand">
    <div id="appTitleTop">AB AGRIWEB</div>
    <img id="appBadgeImg" class="hidden" alt="">
  </div>
</header>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="side-header">
    <button class="close-btn" id="closeSidebar">Ã—</button>
    <span>Menu</span>
  </div>

  <h3>Navigation</h3>
  <a href="#" id="nav-home" class="active">ğŸ  <span id="lbl-nav-home">Accueil</span></a>
  <a href="#" id="nav-irrig">ğŸŒ¿ <span id="lbl-nav-irrig">Irrigation</span></a>
  <a href="#" id="nav-trait">ğŸ’§ <span id="lbl-nav-trait">Traitement</span></a>
  <a href="#" id="nav-settings">âš™ï¸ <span id="lbl-nav-settings">ParamÃ¨tres</span></a>
  <a href="#" id="logout">ğŸšª <span id="lbl-nav-logout">Logout</span></a>

  <div id="sidebarBrand" class="sidebar-brand hidden">
    <img id="sidebarBrandImg" alt="">
  </div>
</aside>
<div class="overlay" id="overlay"></div>

<main class="content">

  <!-- Setup Banner -->
  <section id="setupBanner" class="card hidden" style="border-color:#fbbf24">
    <div class="hint">âš ï¸ Setup Mode Ù…ÙØ¹Ù‘Ù„: ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù….</div>
    <div class="row" style="margin-top:4px">
      <button class="btn" id="btnGoSettings">Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ParamÃ¨tres</button>
      <button class="btn danger" id="btnDisableSetup">Ø¥ÙŠÙ‚Ø§Ù Setup Mode</button>
    </div>
  </section>

  <!-- Accueil -->
  <section id="page-home" class="card">
    <h2>Bienvenue ğŸ‘‹</h2>
    <p class="muted">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… AB AGRIWEB.</p>
    <div id="firstRunHint" class="hint hidden">
      ğŸ” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯. Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰
      <b>ParamÃ¨tres â†’ OPÃ‰RATEUR</b> ÙˆØ£Ø¶Ù Ø£ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù….
    </div>
  </section>

  <!-- ParamÃ¨tres (tuiles) -->
  <section id="page-settings" class="card hidden">
    <h2>ParamÃ¨tres</h2>
    <p class="muted">Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯.</p>
    <div class="stack">
      <div class="tile" id="tile-operators">
        <div class="icon">ğŸ‘¥</div>
        <div><h4 id="lbl-tile-operators">OPÃ‰RATEUR</h4><p>Gestion des utilisateurs</p></div>
      </div>
      <div class="tile" id="tile-profiles">
        <div class="icon">ğŸ§©</div>
        <div><h4 id="lbl-tile-profiles">PROFILE</h4><p>RÃ´les &amp; profils</p></div>
      </div>
      <div class="tile" id="tile-refs">
        <div class="icon">ğŸ—‚ï¸</div>
        <div><h4 id="lbl-tile-refs">RÃ‰FÃ‰RENTIELS</h4><p>Listes de base</p></div>
      </div>
      <div class="tile" id="tile-rights">
        <div class="icon">ğŸ›¡ï¸</div>
        <div><h4 id="lbl-tile-rights">DROITS ACCÃˆS</h4><p>Permissions (Ã  venir)</p></div>
      </div>
      <div class="tile" id="tile-pass">
        <div class="icon">ğŸ”‘</div>
        <div><h4 id="lbl-tile-pass">MOT DE PASSE</h4><p>Gestion du mot de passe</p></div>
      </div>
      <div class="tile" id="tile-appcfg">
        <div class="icon">âš™ï¸</div>
        <div><h4 id="lbl-tile-appcfg">RÃ‰GLAGES APP</h4><p>Logo, labels &amp; sÃ©curitÃ©</p></div>
      </div>
    </div>
  </section>

  <!-- Profiles -->
  <section id="page-profiles" class="card hidden">
    <div class="actions-top">
      <button class="btn icon" id="btnProfileAdd">â•</button>
    </div>
    <h2>Profiles</h2>
    <p class="muted">Ø£Ø¶Ù Ùˆ Ø¹Ø¯Ù‘Ù„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</p>
    <div id="addProfileForm" class="row hidden" style="margin-top:8px">
      <input id="profileName" class="input" placeholder="Ex: Admin, Magasinier, Pointeur, Directeur">
      <button class="btn" id="profileConfirm">Confirmer</button>
      <button class="btn danger" id="profileCancel">Annuler</button>
    </div>
    <div id="profilesList" class="list" style="margin-top:8px"></div>
  </section>

  <!-- Operators -->
  <section id="page-operators" class="card hidden">
    <div class="actions-top">
      <button class="btn icon" id="btnOpAdd">â•</button>
    </div>
    <h2>OpÃ©rateurs</h2>
    <p class="muted">Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚.</p>
    <div id="opAddForm" class="row hidden" style="margin-top:8px">
      <input id="op_username" class="input" placeholder="Nom dâ€™utilisateur">
      <input id="op_password" type="password" class="input" placeholder="Mot de passe">
      <select id="op_profile" class="input"></select>
      <div class="combo" id="combo-op-ferme" style="max-width:340px;width:100%">
        <input id="op_ferme_input" class="input" placeholder="Chercher/choisir une ferme...">
        <div id="op_ferme_list" class="combo-list hidden"></div>
        <input type="hidden" id="op_ferme">
      </div>
      <button class="btn" id="opConfirm">Confirmer</button>
      <button class="btn danger" id="opCancel">Annuler</button>
    </div>
    <div id="operatorsList" class="list" style="margin-top:8px"></div>
  </section>

  <!-- Fermes -->
  <section id="page-farms" class="card hidden">
    <div class="actions-top">
      <button class="btn icon" id="btnFarmAdd">â•</button>
    </div>
    <h2>Fermes</h2>
    <p class="muted">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¶ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªØ¹Ù…Ù„Ø© ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</p>
    <div id="farmAddForm" class="row hidden" style="margin-top:8px">
      <input id="farm_name" class="input" placeholder="Nom de la ferme">
      <input id="farm_area" class="input" placeholder="Surface (ha)">
      <input id="farm_company" class="input" placeholder="SociÃ©tÃ©">
      <input id="farm_location" class="input" placeholder="Emplacement">
      <input id="farm_manager" class="input" placeholder="Responsable">
      <input id="farm_phone" class="input" placeholder="TÃ©lÃ©phone du responsable">
      <button class="btn" id="farmConfirm">Confirmer</button>
      <button class="btn danger" id="farmCancel">Annuler</button>
    </div>
    <div id="farmsList" class="list" style="margin-top:8px"></div>
  </section>

  <!-- RÃ©fÃ©rentiels -->
  <section id="page-refs" class="card hidden">
    <h2>RÃ©fÃ©rentiels</h2>
    <p class="muted">Ù„ÙˆØ§Ø¦Ø­ Ù…Ø±Ø¬Ø¹ÙŠØ© ØªØ³ØªØ¹Ù…Ù„ ÙÙŠ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª.</p>

    <div id="refsHome" class="stack">
      <div class="tile" data-ref="companies"><div class="icon">ğŸ¢</div><div><h4>SociÃ©tÃ©</h4></div></div>
      <div class="tile" data-ref="responsables"><div class="icon">ğŸ‘¤</div><div><h4>Responsable</h4></div></div>
      <div class="tile" data-ref="stations"><div class="icon">ğŸš</div><div><h4>Station</h4></div></div>
      <div class="tile" data-ref="secteurs"><div class="icon">ğŸ§­</div><div><h4>Secteur</h4></div></div>
      <div class="tile" data-ref="parcelles"><div class="icon">ğŸ§±</div><div><h4>Parcelle</h4></div></div>
      <div class="tile" data-ref="transports"><div class="icon">ğŸšš</div><div><h4>Transport</h4></div></div>
      <div class="tile" data-ref="varietes"><div class="icon">ğŸŒ±</div><div><h4>VariÃ©tÃ©</h4></div></div>
      <div class="tile" data-ref="varietes_champ"><div class="icon">ğŸŒ¿</div><div><h4>VariÃ©tÃ© champ</h4></div></div>
      <div class="tile" data-ref="gestions"><div class="icon">ğŸ“¦</div><div><h4>Gestion stock</h4></div></div>
      <div class="tile" data-ref="achats"><div class="icon">ğŸ§¾</div><div><h4>Achat</h4></div></div>
    </div>

    <div id="refsCat" class="hidden">
      <div class="actions-top">
        <button class="btn icon" id="refsAddBtn">â•</button>
      </div>
      <h3 id="refsCatTitle" style="margin-top:0">CatÃ©gorie</h3>
      <div id="refsHint" class="hint hidden">âœï¸ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ â€¢ ğŸ—‘ï¸ Ù„Ù„Ø­Ø°Ù.</div>
      <div id="refsAddForm" class="row hidden" style="margin-top:8px">
        <input id="refsInput" class="input" placeholder="Nom Ã  ajouter">
        <button class="btn" id="refsConfirm">Confirmer</button>
        <button class="btn danger" id="refsCancel">Annuler</button>
      </div>
      <div id="refsList" class="list" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- RÃ©glages APP -->
  <section id="page-appcfg" class="card hidden">
    <h2>RÃ©glages de lâ€™application</h2>
    <p class="muted">ØªØ­ÙƒÙ… ÙÙŠ Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ Ù†ØµÙˆØµ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…ØŒ Ø§Ù„Ø£Ù…Ø§Ù†ØŒ ÙˆØµÙˆØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.</p>

    <!-- GÃ©nÃ©ral -->
    <div class="accordion acc open" id="acc-general">
      <button class="acc-hd" onclick="toggleAcc('acc-general')">1) GÃ©nÃ©ral <span>Titre de lâ€™app</span></button>
      <div class="acc-bd">
        <label class="label">Titre de lâ€™application</label>
        <input id="cfg-app-title" class="input" placeholder="Ex: AB AGRIWEB">
        <label style="display:flex;align-items:center;gap:6px;margin-top:4px">
          <input id="cfg-title-hide" type="checkbox"> Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†ØµÙŠ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        </label>
      </div>
    </div>

    <!-- LibellÃ©s navigation -->
    <div class="accordion acc" id="acc-nav">
      <button class="acc-hd" onclick="toggleAcc('acc-nav')">2) LibellÃ©s Navigation <span>Accueil, Irrigation...</span></button>
      <div class="acc-bd">
        <div class="grid">
          <div><label class="label">Accueil</label><input id="cfg-nav-home" class="input" placeholder="Accueil"></div>
          <div><label class="label">Irrigation</label><input id="cfg-nav-irrig" class="input" placeholder="Irrigation"></div>
          <div><label class="label">Traitement</label><input id="cfg-nav-trait" class="input" placeholder="Traitement"></div>
          <div><label class="label">ParamÃ¨tres</label><input id="cfg-nav-settings" class="input" placeholder="ParamÃ¨tres"></div>
          <div><label class="label">Logout</label><input id="cfg-nav-logout" class="input" placeholder="Logout"></div>
        </div>
      </div>
    </div>

    <!-- Tuiles Param -->
    <div class="accordion acc" id="acc-tiles">
      <button class="acc-hd" onclick="toggleAcc('acc-tiles')">3) Tuiles ParamÃ¨tres <span>OpÃ©rateur, Profil...</span></button>
      <div class="acc-bd">
        <div class="grid">
          <div><label class="label">OpÃ©rateur</label><input id="cfg-tile-operators" class="input" placeholder="OPÃ‰RATEUR"></div>
          <div><label class="label">Profile</label><input id="cfg-tile-profiles" class="input" placeholder="PROFILE"></div>
          <div><label class="label">RÃ©fÃ©rentiels</label><input id="cfg-tile-refs" class="input" placeholder="RÃ‰FÃ‰RENTIELS"></div>
          <div><label class="label">Droits accÃ¨s</label><input id="cfg-tile-rights" class="input" placeholder="DROITS ACCÃˆS"></div>
          <div><label class="label">Mot de passe</label><input id="cfg-tile-pass" class="input" placeholder="MOT DE PASSE"></div>
        </div>
      </div>
    </div>

    <!-- SÃ©curitÃ© -->
    <div class="accordion acc" id="acc-sec">
      <button class="acc-hd" onclick="toggleAcc('acc-sec')">4) SÃ©curitÃ© <span>Email, TÃ©lÃ©phone, Question, Code</span></button>
      <div class="acc-bd">
        <div class="grid">
          <div>
            <label class="label">Email de rÃ©cupÃ©ration</label>
            <input id="sec-email" class="input" placeholder="ex: admin@example.com">
          </div>
          <div>
            <label class="label">TÃ©lÃ©phone</label>
            <input id="sec-phone" class="input" placeholder="+2126...">
          </div>
          <div>
            <label class="label">Question secrÃ¨te</label>
            <input id="sec-question" class="input" placeholder="Ex: Ville de naissance ?">
          </div>
          <div>
            <label class="label">RÃ©ponse</label>
            <input id="sec-answer" class="input" placeholder="Votre rÃ©ponse">
          </div>
          <div>
            <label class="label">Code de rÃ©cupÃ©ration</label>
            <div class="row">
              <input id="sec-code" class="input" placeholder="Cliquer sur GÃ©nÃ©rer" disabled>
              <button class="btn" id="secGen">GÃ©nÃ©rer</button>
            </div>
            <div class="muted">ÙŠÙØ³ØªØ®Ø¯Ù… ÙÙŠ ØµÙØ­Ø© "Mot de passe oubliÃ©".</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Branding: Ø§Ù„ÙƒÙ„ Ù‡Ù†Ø§ -->
    <div class="accordion acc" id="acc-brand">
      <button class="acc-hd" onclick="toggleAcc('acc-brand')">5) Branding <span>Logo, Badge, Sidebar, Login</span></button>
      <div class="acc-bd">
        <div class="grid">
          <div>
            <label class="label">Logo de lâ€™application</label>
            <input id="cfg-logo-url" class="input" placeholder="URL (png/gif)">
            <input id="cfg-logo-file" type="file" accept="image/png,image/gif" class="input">
            <button class="btn danger img-clear" data-key="logo">Supprimer logo</button>
          </div>
          <div>
            <label class="label">Badge header</label>
            <input id="cfg-badge-url" class="input" placeholder="URL (png/gif)">
            <input id="cfg-badge-file" type="file" accept="image/png,image/gif" class="input">
            <button class="btn danger img-clear" data-key="badge">Supprimer badge</button>
          </div>
          <div>
            <label class="label">Sidebar banner</label>
            <input id="cfg-side-url" class="input" placeholder="URL (png/gif)">
            <input id="cfg-side-file" type="file" accept="image/png,image/gif" class="input">
            <button class="btn danger img-clear" data-key="sidebar">Supprimer sidebar</button>
          </div>
          <div>
            <label class="label">Login banner</label>
            <input id="cfg-login-url" class="input" placeholder="URL (png/gif)">
            <input id="cfg-login-file" type="file" accept="image/png,image/gif" class="input">
            <button class="btn danger img-clear" data-key="login">Supprimer login banner</button>
          </div>
          <div>
            <label class="label">Login background</label>
            <input id="cfg-loginbg-url" class="input" placeholder="URL (png/gif)">
            <input id="cfg-loginbg-file" type="file" accept="image/png,image/gif" class="input">
            <button class="btn danger img-clear" data-key="loginBg">Supprimer background</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="appcfgSaveBtn">Enregistrer</button>
      <button class="btn danger" id="appcfgResetBtn">Reset</button>
    </div>
  </section>

</main>

<!-- Modals: Operators -->
<div id="opModal" class="modal-wrap">
  <div class="modal-bg"></div>
  <div class="modal">
    <h3>Modifier lâ€™opÃ©rateur</h3>
    <div class="row">
      <input id="edit_username" class="input" placeholder="Nom dâ€™utilisateur">
      <input id="edit_password" type="password" class="input" placeholder="Mot de passe">
    </div>
    <div class="row">
      <select id="edit_profile" class="input"></select>
      <div class="combo" id="combo-edit-ferme" style="max-width:340px;width:100%">
        <input id="edit_ferme_input" class="input" placeholder="Chercher/choisir une ferme...">
        <div id="edit_ferme_list" class="combo-list hidden"></div>
        <input type="hidden" id="edit_ferme">
      </div>
    </div>
    <div class="right" style="margin-top:6px">
      <button class="btn danger" id="opEditCancel">Annuler</button>
      <button class="btn" id="opEditSave">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Modals: Farms -->
<div id="farmModal" class="modal-wrap">
  <div class="modal-bg"></div>
  <div class="modal">
    <h3>Modifier la ferme</h3>
    <div class="row">
      <input id="edit_farm_name" class="input" placeholder="Nom de la ferme">
      <input id="edit_farm_area" class="input" placeholder="Surface">
    </div>
    <div class="row">
      <input id="edit_farm_company" class="input" placeholder="SociÃ©tÃ©">
      <input id="edit_farm_location" class="input" placeholder="Emplacement">
    </div>
    <div class="row">
      <input id="edit_farm_manager" class="input" placeholder="Responsable">
      <input id="edit_farm_phone" class="input" placeholder="TÃ©lÃ©phone">
    </div>
    <div class="right" style="margin-top:6px">
      <button class="btn danger" id="farmEditCancel">Annuler</button>
      <button class="btn" id="farmEditSave">Enregistrer</button>
    </div>
  </div>
</div>

<script>
/*=== CONSTANTS & HELPERS ===*/
const LS_PROFILES='ab_profiles';
const LS_FARMS='ab_farms';
const LS_OPERATORS='ab_operators';
const LS_REFS='ab_refs';
const LS_APP='ab_appcfg';
const LS_IMG='ab_appimg';
const LS_SEC='ab_security';

const DEFAULT_PROFILES=["Admin","Magasinier","Pointeur","Directeur"];
const SETUP_ON = localStorage.getItem('ab_setup') === '1';

function $(id){return document.getElementById(id);}
function loadJSON(k,f){try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(f));}catch{return f;}}
function saveJSON(k,v){localStorage.setItem(k,JSON.stringify(v));}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}

/*=== GUARD: Ù„Ø§ Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† opÃ©rateur Ø¥Ù„Ø§ ÙÙŠ Setup ===*/
(function guard(){
  let ops = loadJSON(LS_OPERATORS,[]);
  if(!SETUP_ON && ops.length===0){
    alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø© Ø¨Ø¯ÙˆÙ† Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ø±Ø¬Ø¹ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.");
    location="index.html";
  }
})();

/*=== SIDEBAR & NAV ===*/
(function sidebarInit(){
  const sidebar=$('sidebar'), overlay=$('overlay');
  $('menuBtn').onclick = ()=>{sidebar.classList.add('open');overlay.classList.add('active');};
  $('closeSidebar').onclick = close;
  if(overlay) overlay.onclick = close;
  function close(){sidebar.classList.remove('open');overlay.classList.remove('active');}
  document.addEventListener('keydown',e=>{if(e.key==='Escape')close();});

  function setActive(linkId){
    document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));
    const el=$(linkId); if(el) el.classList.add('active');
  }

  function showPage(name){
    const pid = name.startsWith('page-')?name:('page-'+name);
    document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden'));
    const tgt=$(pid); if(tgt) tgt.classList.remove('hidden');
    sidebar.classList.remove('open');overlay.classList.remove('active');
  }

  $('nav-home').onclick = e=>{e.preventDefault();setActive('nav-home');showPage('home');};
  $('nav-settings').onclick = e=>{e.preventDefault();setActive('nav-settings');showPage('settings');};
  $('nav-irrig').onclick = e=>{e.preventDefault();alert("Page Irrigation (Ã  dÃ©velopper).");};
  $('nav-trait').onclick = e=>{e.preventDefault();alert("Page Traitement (Ã  dÃ©velopper).");};
  $('logout').onclick = e=>{e.preventDefault();location="index.html";};

  // Tiles
  $('tile-operators').onclick = ()=>{setActive('nav-settings');showPage('operators');};
  $('tile-profiles').onclick  = ()=>{setActive('nav-settings');showPage('profiles');};
  $('tile-refs').onclick      = ()=>{setActive('nav-settings');showPage('refs');};
  $('tile-appcfg').onclick    = ()=>{setActive('nav-settings');showPage('appcfg');};
  $('tile-rights').onclick    = ()=>{alert("Droits d'accÃ¨s: Ù„Ø§Ø­Ù‚Ø§Ù‹.");};
  $('tile-pass').onclick      = ()=>{alert("Gestion mot de passe: Ù„Ø§Ø­Ù‚Ø§Ù‹.");};

  // Expose for other funcs
  window.showPage = showPage;
})();

/*=== APP CONFIG + BRANDING ===*/
const APP_DEFAULT = {
  appTitle:"AB AGRIWEB",
  hideTitle:false,
  nav:{home:"Accueil",irrig:"Irrigation",trait:"Traitement",settings:"ParamÃ¨tres",logout:"Logout"},
  tiles:{operators:"OPÃ‰RATEUR",profiles:"PROFILE",refs:"RÃ‰FÃ‰RENTIELS",rights:"DROITS ACCÃˆS",pass:"MOT DE PASSE",appcfg:"RÃ‰GLAGES APP"}
};

function appcfgLoad(){
  const saved = loadJSON(LS_APP,{});
  return {
    appTitle: saved.appTitle ?? APP_DEFAULT.appTitle,
    hideTitle: !!saved.hideTitle,
    nav:{...APP_DEFAULT.nav,...(saved.nav||{})},
    tiles:{...APP_DEFAULT.tiles,...(saved.tiles||{})}
  };
}
function appcfgSaveConfig(cfg){ saveJSON(LS_APP,cfg); }

function imgsLoad(){
  return loadJSON(LS_IMG,{logo:null,badge:null,sidebar:null,login:null,loginBg:null});
}
function imgsSave(i){ saveJSON(LS_IMG,i); }

function applyBranding(){
  const cfg=appcfgLoad();
  const imgs=imgsLoad();

  // document title
  document.title = (cfg.appTitle && !cfg.hideTitle) ? cfg.appTitle+" - Dashboard" : "AB AGRIWEB - Dashboard";

  // header title / logo
  const titleTop=$('appTitleTop');
  if(imgs.logo){
    titleTop.innerHTML = `<img src="${imgs.logo}" style="height:26px;border-radius:6px;vertical-align:middle">`;
    titleTop.classList.remove('hidden');
  }else if(!cfg.hideTitle && cfg.appTitle){
    titleTop.textContent = cfg.appTitle;
    titleTop.classList.remove('hidden');
  }else{
    titleTop.textContent='';
    titleTop.classList.add('hidden');
  }

  // nav labels
  $('lbl-nav-home').textContent   = cfg.nav.home;
  $('lbl-nav-irrig').textContent  = cfg.nav.irrig;
  $('lbl-nav-trait').textContent  = cfg.nav.trait;
  $('lbl-nav-settings').textContent=cfg.nav.settings;
  $('lbl-nav-logout').textContent = cfg.nav.logout;

  // tiles
  $('lbl-tile-operators').textContent = cfg.tiles.operators;
  $('lbl-tile-profiles').textContent  = cfg.tiles.profiles;
  $('lbl-tile-refs').textContent      = cfg.tiles.refs;
  $('lbl-tile-rights').textContent    = cfg.tiles.rights;
  $('lbl-tile-pass').textContent      = cfg.tiles.pass;
  $('lbl-tile-appcfg').textContent    = cfg.tiles.appcfg;

  // badge
  const badge=$('appBadgeImg');
  if(imgs.badge){ badge.src=imgs.badge; badge.classList.remove('hidden'); }
  else badge.classList.add('hidden');

  // sidebar brand
  const sb=$('sidebarBrand'), sbImg=$('sidebarBrandImg');
  if(imgs.sidebar){ sbImg.src=imgs.sidebar; sb.classList.remove('hidden'); }
  else sb.classList.add('hidden');

  // Accueil hint
  const ops = loadJSON(LS_OPERATORS,[]);
  if(ops.length===0) $('firstRunHint').classList.remove('hidden');
  else $('firstRunHint').classList.add('hidden');
}

function appcfgFillForm(){
  const cfg=appcfgLoad();
  const imgs=imgsLoad();
  const sec=loadJSON(LS_SEC,{});
  // General
  $('cfg-app-title').value = cfg.appTitle || '';
  $('cfg-title-hide').checked = !!cfg.hideTitle;
  // nav
  $('cfg-nav-home').value = cfg.nav.home;
  $('cfg-nav-irrig').value = cfg.nav.irrig;
  $('cfg-nav-trait').value = cfg.nav.trait;
  $('cfg-nav-settings').value = cfg.nav.settings;
  $('cfg-nav-logout').value = cfg.nav.logout;
  // tiles
  $('cfg-tile-operators').value = cfg.tiles.operators;
  $('cfg-tile-profiles').value  = cfg.tiles.profiles;
  $('cfg-tile-refs').value      = cfg.tiles.refs;
  $('cfg-tile-rights').value    = cfg.tiles.rights;
  $('cfg-tile-pass').value      = cfg.tiles.pass;
  // security
  $('sec-email').value = sec.email || '';
  $('sec-phone').value = sec.phone || '';
  $('sec-question').value = sec.question || '';
  $('sec-answer').value = '';
  $('sec-code').value = sec.recoveryCode || '';

  // urls (Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù„ÙŠ Ù…Ø®Ø²Ù† Ø­ØªÙ‰ Ù„Ùˆ base64)
  $('cfg-logo-url').value    = imgs.logo    || '';
  $('cfg-badge-url').value   = imgs.badge   || '';
  $('cfg-side-url').value    = imgs.sidebar || '';
  $('cfg-login-url').value   = imgs.login   || '';
  $('cfg-loginbg-url').value = imgs.loginBg || '';
}

function acceptImgUrl(u){
  return !u || /\.(png|gif)(\?|#|$)/i.test(u) || u.startsWith("data:image/");
}
function onFileInput(id,key){
  const input=$(id); if(!input) return;
  input.addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f) return;
    if(!/^image\/(png|gif)$/.test(f.type)){
      alert("PNG Ø£Ùˆ GIF ÙÙ‚Ø·"); input.value='';return;
    }
    const r=new FileReader();
    r.onload=ev=>{
      const imgs=imgsLoad(); imgs[key]=String(ev.target.result||''); imgsSave(imgs); appcfgFillForm(); applyBranding();
    };
    r.readAsDataURL(f);
  });
}
function wireBrandingFiles(){
  onFileInput('cfg-logo-file','logo');
  onFileInput('cfg-badge-file','badge');
  onFileInput('cfg-side-file','sidebar');
  onFileInput('cfg-login-file','login');
  onFileInput('cfg-loginbg-file','loginBg');
}
function wireBrandingClear(){
  document.querySelectorAll('.img-clear').forEach(btn=>{
    btn.onclick=()=>{
      const key=btn.dataset.key;
      if(!key) return;
      const imgs=imgsLoad(); imgs[key]=null; imgsSave(imgs);
      appcfgFillForm(); applyBranding();
    };
  });
}

function hashLite(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return String(h);}

function appcfgSave(){
  const cfg=appcfgLoad();
  const imgs=imgsLoad();
  const sec=loadJSON(LS_SEC,{});

  cfg.appTitle = $('cfg-app-title').value.trim() || '';
  cfg.hideTitle = $('cfg-title-hide').checked;

  cfg.nav.home = $('cfg-nav-home').value || APP_DEFAULT.nav.home;
  cfg.nav.irrig = $('cfg-nav-irrig').value || APP_DEFAULT.nav.irrig;
  cfg.nav.trait = $('cfg-nav-trait').value || APP_DEFAULT.nav.trait;
  cfg.nav.settings = $('cfg-nav-settings').value || APP_DEFAULT.nav.settings;
  cfg.nav.logout = $('cfg-nav-logout').value || APP_DEFAULT.nav.logout;

  cfg.tiles.operators = $('cfg-tile-operators').value || APP_DEFAULT.tiles.operators;
  cfg.tiles.profiles  = $('cfg-tile-profiles').value  || APP_DEFAULT.tiles.profiles;
  cfg.tiles.refs      = $('cfg-tile-refs').value      || APP_DEFAULT.tiles.refs;
  cfg.tiles.rights    = $('cfg-tile-rights').value    || APP_DEFAULT.tiles.rights;
  cfg.tiles.pass      = $('cfg-tile-pass').value      || APP_DEFAULT.tiles.pass;

  // security
  sec.email = $('sec-email').value.trim();
  sec.phone = $('sec-phone').value.trim();
  sec.question = $('sec-question').value.trim();
  const ans = $('sec-answer').value.trim().toLowerCase();
  if(ans) sec.answerHash = hashLite(ans);
  // recovery code Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ (Ù…Ø§Ø´ÙŠ Ø¶Ø±ÙˆØ±ÙŠ)
  const code = $('sec-code').value.trim();
  if(code) sec.recoveryCode = code;

  // URLs manual
  const logoUrl = $('cfg-logo-url').value.trim();
  if(acceptImgUrl(logoUrl) && logoUrl) imgs.logo=logoUrl;
  const badgeUrl = $('cfg-badge-url').value.trim();
  if(acceptImgUrl(badgeUrl) && badgeUrl) imgs.badge=badgeUrl;
  const sideUrl = $('cfg-side-url').value.trim();
  if(acceptImgUrl(sideUrl) && sideUrl) imgs.sidebar=sideUrl;
  const loginUrl = $('cfg-login-url').value.trim();
  if(acceptImgUrl(loginUrl) && loginUrl) imgs.login=loginUrl;
  const bgUrl = $('cfg-loginbg-url').value.trim();
  if(acceptImgUrl(bgUrl) && bgUrl) imgs.loginBg=bgUrl;

  appcfgSaveConfig(cfg);
  imgsSave(imgs);
  saveJSON(LS_SEC,sec);

  appcfgFillForm();
  applyBranding();
  alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…");
}
function appcfgReset(){
  localStorage.removeItem(LS_APP);
  localStorage.removeItem(LS_IMG);
  appcfgFillForm();
  applyBranding();
  alert("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.");
}

function toggleAcc(id){
  const acc=$(id);
  if(acc) acc.classList.toggle('open');
}

/*=== PROFILES ===*/
function loadProfiles(){return loadJSON(LS_PROFILES,[]);}
function saveProfiles(arr){saveJSON(LS_PROFILES,arr);}
function renderProfiles(){
  const list=$('profilesList');
  const arr=loadProfiles();
  if(arr.length===0){
    list.innerHTML=`<div class="item"><div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯.</div></div>`;
    return;
  }
  list.innerHTML = arr.map((p,i)=>`
    <div class="item">
      <div class="meta"><b>${escapeHtml(p)}</b></div>
      <div class="actions">
        <button class="btn icon" onclick="profileEdit(${i})">âœï¸</button>
        <button class="btn danger icon" onclick="profileDelete(${i})">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('');
}
function profileEdit(i){
  const arr=loadProfiles();const old=arr[i];
  const nv=prompt("Modifier le profil:",old);
  if(nv===null) return;
  const v=nv.trim();if(!v){alert("Nom vide");return;}
  if(arr.some((x,idx)=>idx!==i && x.toLowerCase()===v.toLowerCase())){
    alert("Ce profil existe dÃ©jÃ .");return;
  }
  arr[i]=v;saveProfiles(arr);renderProfiles();opRefreshProfiles();
}
function profileDelete(i){
  const arr=loadProfiles();
  if(!confirm("Supprimer ce profil ?"))return;
  arr.splice(i,1);saveProfiles(arr);renderProfiles();opRefreshProfiles();
}
function profileAdd(){
  const name=$('profileName').value.trim();
  if(!name){alert("Entrer un nom.");return;}
  const arr=loadProfiles();
  if(arr.some(x=>x.toLowerCase()===name.toLowerCase())){alert("Existe dÃ©jÃ .");return;}
  arr.push(name);saveProfiles(arr);$('profileName').value='';toggleProfileForm(false);renderProfiles();opRefreshProfiles();
}
function toggleProfileForm(show){
  $('addProfileForm').classList.toggle('hidden',!show);
}

/*=== FARMS ===*/
function loadFarms(){return loadJSON(LS_FARMS,[]);}
function saveFarms(a){saveJSON(LS_FARMS,a);}
function renderFarms(){
  const list=$('farmsList');const arr=loadFarms();
  if(arr.length===0){list.innerHTML='<div class="item"><div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¶ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯.</div></div>';return;}
  list.innerHTML=arr.map((f,i)=>`
    <div class="item">
      <div class="meta">
        <span><b>Ferme:</b> ${escapeHtml(f.name)}</span>
        ${f.area?`<span><b>Surface:</b> ${escapeHtml(f.area)}</span>`:''}
        ${f.company?`<span><b>SociÃ©tÃ©:</b> ${escapeHtml(f.company)}</span>`:''}
        ${f.location?`<span><b>Lieu:</b> ${escapeHtml(f.location)}</span>`:''}
        ${f.manager?`<span><b>Resp.:</b> ${escapeHtml(f.manager)}</span>`:''}
        ${f.phone?`<span><b>TÃ©l:</b> ${escapeHtml(f.phone)}</span>`:''}
      </div>
      <div class="actions">
        <button class="btn icon" onclick="farmEdit(${i})">âœï¸</button>
        <button class="btn danger icon" onclick="farmDelete(${i})">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('');
}
function farmAdd(){
  const o={
    name:$('farm_name').value.trim(),
    area:$('farm_area').value.trim(),
    company:$('farm_company').value.trim(),
    location:$('farm_location').value.trim(),
    manager:$('farm_manager').value.trim(),
    phone:$('farm_phone').value.trim()
  };
  if(!o.name){alert("Nom de la ferme requis.");return;}
  const arr=loadFarms();
  if(arr.some(x=>x.name.toLowerCase()===o.name.toLowerCase())){alert("Cette ferme existe dÃ©jÃ .");return;}
  arr.push(o);saveFarms(arr);
  ['farm_name','farm_area','farm_company','farm_location','farm_manager','farm_phone'].forEach(id=>$(id).value='');
  toggleFarmForm(false);renderFarms();opRefreshFarms();
}
function toggleFarmForm(show){$('farmAddForm').classList.toggle('hidden',!show);}
let farmEditIndex=null;
function farmEdit(i){
  const f=loadFarms()[i];farmEditIndex=i;
  $('edit_farm_name').value=f.name||'';
  $('edit_farm_area').value=f.area||'';
  $('edit_farm_company').value=f.company||'';
  $('edit_farm_location').value=f.location||'';
  $('edit_farm_manager').value=f.manager||'';
  $('edit_farm_phone').value=f.phone||'';
  $('farmModal').classList.add('show');
}
function farmDelete(i){
  const arr=loadFarms();
  if(!confirm("Supprimer cette ferme ?"))return;
  arr.splice(i,1);saveFarms(arr);renderFarms();opRefreshFarms();
}
function farmSaveEdit(){
  if(farmEditIndex==null)return;
  const arr=loadFarms();
  const f=arr[farmEditIndex];
  const nv={
    name:$('edit_farm_name').value.trim(),
    area:$('edit_farm_area').value.trim(),
    company:$('edit_farm_company').value.trim(),
    location:$('edit_farm_location').value.trim(),
    manager:$('edit_farm_manager').value.trim(),
    phone:$('edit_farm_phone').value.trim()
  };
  if(!nv.name){alert("Nom requis.");return;}
  if(nv.name.toLowerCase()!==f.name.toLowerCase() &&
     arr.some(x=>x.name.toLowerCase()===nv.name.toLowerCase())){
    alert("Nom dÃ©jÃ  utilisÃ©.");return;
  }
  arr[farmEditIndex]=nv;saveFarms(arr);farmEditIndex=null;
  $('farmModal').classList.remove('show');renderFarms();opRefreshFarms();
}
function farmCloseModal(){farmEditIndex=null;$('farmModal').classList.remove('show');}

/*=== OPERATORS ===*/
function loadOps(){return loadJSON(LS_OPERATORS,[]);}
function saveOps(a){saveJSON(LS_OPERATORS,a);}
function opRefreshProfiles(){
  const arr=loadProfiles();const sel1=$('op_profile'),sel2=$('edit_profile');
  const opts=arr.length?arr.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('')
                      :'<option value="">(Aucun profil)</option>';
  if(sel1) sel1.innerHTML=opts;
  if(sel2) sel2.innerHTML=opts;
}
function comboInit(baseId,items){
  const input=$(baseId+'_input'), list=$(baseId+'_list'), hidden=$(baseId);
  if(!input || !list || !hidden) return;
  function render(q){
    const m=items.filter(x=>x.toLowerCase().includes((q||'').toLowerCase()));
    list.innerHTML=m.length?m.map(v=>`<div class="combo-item" data-v="${escapeHtml(v)}">${escapeHtml(v)}</div>`).join('')
      :'<div class="combo-item">(Aucun rÃ©sultat)</div>';
  }
  input.onfocus=()=>{list.classList.remove('hidden');render(input.value);}
  input.oninput=()=>render(input.value);
  document.addEventListener('click',e=>{
    if(!list.contains(e.target) && e.target!==input) list.classList.add('hidden');
  });
  list.onclick=e=>{
    const el=e.target.closest('.combo-item');if(!el)return;
    const v=el.dataset.v;if(!v)return;
    input.value=v;hidden.value=v;list.classList.add('hidden');
  };
}
function opRefreshFarms(){
  const arr=loadFarms().map(f=>f.name);
  comboInit('op_ferme',arr);
  comboInit('edit_ferme',arr);
}
function renderOps(){
  const list=$('operatorsList');const arr=loadOps();
  if(arr.length===0){
    list.innerHTML='<div class="item"><div class="meta">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯.</div></div>';return;
  }
  list.innerHTML=arr.map((u,i)=>`
    <div class="item">
      <div class="meta">
        <span><b>${escapeHtml(u.username)}</b></span>
        ${u.profile?`<span>${escapeHtml(u.profile)}</span>`:''}
        ${u.ferme?`<span>${escapeHtml(u.ferme)}</span>`:''}
      </div>
      <div class="actions">
        <button class="btn icon" onclick="opEdit(${i})">âœï¸</button>
        <button class="btn danger icon" onclick="opDelete(${i})">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('');
}
function toggleOpForm(show){$('opAddForm').classList.toggle('hidden',!show);}
function opAdd(){
  const u=$('op_username').value.trim();
  const p=$('op_password').value.trim();
  const pr=$('op_profile').value.trim();
  const fm=$('op_ferme').value.trim();
  if(!u||!p||!pr||!fm){alert("Remplir tous les champs.");return;}
  const arr=loadOps();
  if(arr.some(x=>x.username.toLowerCase()===u.toLowerCase())){
    alert("Nom dâ€™utilisateur existe dÃ©jÃ .");return;
  }
  arr.push({username:u,password:p,profile:pr,ferme:fm});
  saveOps(arr);
  ['op_username','op_password','op_ferme_input','op_ferme'].forEach(id=>$(id).value='');
  toggleOpForm(false);renderOps();
}
let opEditIndex=null;
function opEdit(i){
  const arr=loadOps(),u=arr[i];opEditIndex=i;
  $('edit_username').value=u.username;
  $('edit_password').value=u.password;
  opRefreshProfiles();$('edit_profile').value=u.profile||'';
  opRefreshFarms();
  $('edit_ferme_input').value=u.ferme||'';
  $('edit_ferme').value=u.ferme||'';
  $('opModal').classList.add('show');
}
function opSaveEdit(){
  if(opEditIndex==null)return;
  const arr=loadOps(),old=arr[opEditIndex];
  const u=$('edit_username').value.trim();
  const p=$('edit_password').value.trim();
  const pr=$('edit_profile').value.trim();
  const fm=$('edit_ferme').value.trim();
  if(!u||!p||!pr||!fm){alert("Remplir tous les champs.");return;}
  if(u.toLowerCase()!==old.username.toLowerCase() &&
     arr.some(x=>x.username.toLowerCase()===u.toLowerCase())){
    alert("Nom dÃ©jÃ  utilisÃ©.");return;
  }
  arr[opEditIndex]={username:u,password:p,profile:pr,ferme:fm};
  saveOps(arr);opEditIndex=null;$('opModal').classList.remove('show');renderOps();
}
function opDelete(i){
  const arr=loadOps();
  if(!confirm("Supprimer cet opÃ©rateur ?"))return;
  arr.splice(i,1);saveOps(arr);renderOps();
}
function opCloseModal(){opEditIndex=null;$('opModal').classList.remove('show');}

/*=== REFS ===*/
const REF_DEFAULT = {
  companies:[],responsables:[],stations:[],secteurs:[],
  parcelles:[],transports:[],varietes:[],varietes_champ:[],
  gestions:[],achats:[]
};
let currentRefKey=null;
function loadRefs(){return Object.assign({},REF_DEFAULT,loadJSON(LS_REFS,{}));}
function saveRefs(o){saveJSON(LS_REFS,o);}
function refsOpen(key){
  currentRefKey=key;
  $('refsHome').classList.add('hidden');
  $('refsCat').classList.remove('hidden');
  $('refsCatTitle').textContent=key;
  $('refsHint').classList.add('hidden');
  $('refsAddForm').classList.add('hidden');
  $('refsInput').value='';
  refsRender();
}
function refsRender(){
  const arr=loadRefs()[currentRefKey]||[];
  const list=$('refsList');
  if(arr.length===0){list.innerHTML='<div class="item"><div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</div></div>';return;}
  list.innerHTML=arr.map((n,i)=>`
    <div class="item">
      <div class="meta"><b>${escapeHtml(n)}</b></div>
      <div class="actions">
        <button class="btn icon" onclick="refsEdit(${i})">âœï¸</button>
        <button class="btn danger icon" onclick="refsDelete(${i})">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('');
}
function refsAdd(){
  const name=$('refsInput').value.trim();
  if(!name){alert("Nom requis.");return;}
  const all=loadRefs();const arr=all[currentRefKey]||[];
  if(arr.some(x=>x.toLowerCase()===name.toLowerCase())){alert("Existe dÃ©jÃ .");return;}
  arr.push(name);all[currentRefKey]=arr;saveRefs(all);
  $('refsInput').value='';$('refsAddForm').classList.add('hidden');refsRender();
}
function refsEdit(i){
  const all=loadRefs();const arr=all[currentRefKey]||[];
  const old=arr[i];
  const nv=prompt("Modifier:",old);
  if(nv===null) return;
  const val=nv.trim();
  if(!val){alert("Nom vide.");return;}
  if(arr.some((x,idx)=>idx!==i && x.toLowerCase()===val.toLowerCase())){
    alert("Existe dÃ©jÃ .");return;
  }
  arr[i]=val;all[currentRefKey]=arr;saveRefs(all);refsRender();
}
function refsDelete(i){
  const all=loadRefs();const arr=all[currentRefKey]||[];
  if(!confirm("Supprimer ?"))return;
  arr.splice(i,1);all[currentRefKey]=arr;saveRefs(all);refsRender();
}
function toggleRefsForm(show){$('refsAddForm').classList.toggle('hidden',!show);}
function toggleRefsHint(){$('refsHint').classList.toggle('hidden');}

/*=== SETUP BANNER ===*/
function setupInit(){
  if(SETUP_ON){$('setupBanner').classList.remove('hidden');}
  $('btnGoSettings').onclick=()=>{showPage('settings');};
  $('btnDisableSetup').onclick=()=>{
    localStorage.removeItem('ab_setup');
    alert("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Setup Mode. Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¶Ù Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ØŒ Ø«Ù… Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬.");
    location.reload();
  };
}

/*=== INIT ===*/
document.addEventListener('DOMContentLoaded',()=>{
  // defaults
  if(loadProfiles().length===0) saveProfiles(DEFAULT_PROFILES.slice());
  saveRefs(loadRefs()); // ensure structure

  // wire profiles
  $('btnProfileAdd').onclick=()=>toggleProfileForm(true);
  $('profileCancel').onclick=()=>toggleProfileForm(false);
  $('profileConfirm').onclick=profileAdd;

  // wire farms
  $('btnFarmAdd').onclick=()=>toggleFarmForm(true);
  $('farmCancel').onclick=()=>toggleFarmForm(false);
  $('farmConfirm').onclick=farmAdd;
  $('farmEditCancel').onclick=farmCloseModal;
  $('farmEditSave').onclick=farmSaveEdit;

  // wire ops
  $('btnOpAdd').onclick=()=>{toggleOpForm(true);opRefreshProfiles();opRefreshFarms();};
  $('opCancel').onclick=()=>toggleOpForm(false);
  $('opConfirm').onclick=opAdd;
  $('opEditCancel').onclick=opCloseModal;
  $('opEditSave').onclick=opSaveEdit;

  // refs
  document.querySelectorAll('#refsHome .tile').forEach(t=>{
    t.onclick=()=>refsOpen(t.dataset.ref);
  });
  $('refsAddBtn').onclick=()=>toggleRefsForm(true);
  $('refsCancel').onclick=()=>toggleRefsForm(false);
  $('refsConfirm').onclick=refsAdd;

  // app cfg
  $('appcfgSaveBtn').onclick=appcfgSave;
  $('appcfgResetBtn').onclick=appcfgReset;
  $('secGen').onclick=()=>{
    const c=String(Math.floor(100000+Math.random()*900000));
    $('sec-code').disabled=false;$('sec-code').value=c;$('sec-code').disabled=true;
  };
  document.querySelectorAll('.acc-hd').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const acc=btn.parentElement;acc.classList.toggle('open');
    });
  });

  wireBrandingFiles();
  wireBrandingClear();
  appcfgFillForm();
  applyBranding();
  renderProfiles();
  renderFarms();
  renderOps();
  setupInit();
});
</script>
</body>
</html>
