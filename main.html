<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AB AGRIWEB - Dashboard</title>
<style>
:root{
  --bg:#04121f;
  --bg-soft:#071827;
  --panel:#050f1b;
  --accent:#22c55e;
  --accent-soft:#14532d;
  --text:#e2e8f0;
  --muted:#9ca3af;
  --border:#1f2937;
  --danger:#ef4444;
  --radius:18px;
  --shadow:0 14px 35px rgba(0,0,0,.6);
  --font:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:var(--font);
  background:radial-gradient(circle at top,#0f172a,#020817);
  color:var(--text);
  min-height:100vh;
  padding:0;
  margin:0;
  overflow-x:hidden;
}
.hidden{display:none!important}

/* Toast */
.toast-wrap{
  position:fixed;
  bottom:18px;
  left:50%;
  transform:translateX(-50%);
  z-index:4000;
}
.toast{
  background:#0f172acc;
  border:1px solid var(--accent);
  padding:8px 14px;
  border-radius:999px;
  box-shadow:var(--shadow);
  font-size:13px;
}

/* Header */
.topbar{
  position:sticky;
  top:0;
  z-index:1000;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 14px;
  background:#020817ee;
  backdrop-filter:blur(10px);
  border-bottom:1px solid #111827;
}
.menu-btn{
  width:40px;height:40px;
  border-radius:14px;
  border:none;
  background:#0f172a;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.6);
}
.menu-btn span{
  width:18px;height:2px;
  background:var(--accent);
  box-shadow:0 6px 0 var(--accent),0 -6px 0 var(--accent);
  border-radius:999px;
}
.app-title{
  padding:4px 14px;
  border-radius:999px;
  background:#052e16;
  color:#bbf7d0;
  font-weight:700;
  letter-spacing:.5px;
  box-shadow:0 6px 16px rgba(0,0,0,.5);
}
.brand-badge{
  max-height:26px;
}

/* Sidebar */
.sidebar{
  position:fixed;
  top:0;left:-260px;
  width:260px;
  height:100%;
  background:#020817f2;
  backdrop-filter:blur(18px);
  border-right:1px solid #111827;
  display:flex;
  flex-direction:column;
  padding-top:64px;
  transition:left .3s ease;
  z-index:1200;
}
.sidebar.active{left:0}
.sidebar a{
  padding:11px 18px;
  display:flex;
  align-items:center;
  gap:10px;
  color:var(--muted);
  text-decoration:none;
  font-size:14px;
  border-left:3px solid transparent;
}
.sidebar a span.icon{width:18px;text-align:center}
.sidebar a:hover{
  background:#030712;
  color:var(--accent);
}
.sidebar a.active{
  background:#020817;
  color:var(--accent);
  border-left-color:var(--accent);
}
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  opacity:0;
  pointer-events:none;
  transition:opacity .25s ease;
  z-index:1100;
}
.overlay.active{
  opacity:1;
  pointer-events:auto;
}

/* Layout */
.main-wrap{padding:14px}
.card{
  background:var(--panel);
  border-radius:var(--radius);
  padding:16px 14px 14px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  margin-bottom:14px;
}
.card h2{
  font-size:20px;
  margin-bottom:6px;
}
.card p.muted{
  font-size:13px;
  color:var(--muted);
}

/* ParamÃ¨tres tiles */
.tiles{display:grid;gap:8px;margin-top:6px}
.tile{
  display:flex;align-items:center;gap:10px;
  padding:9px 10px;
  border-radius:14px;
  background:#020817;
  border:1px solid #111827;
  cursor:pointer;
}
.tile .ico{
  width:26px;height:26px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  background:#0f172a;color:var(--accent);font-size:15px;
}
.tile span.lbl{font-size:14px}

/* Forms & buttons */
.label{font-size:12px;color:var(--muted);margin-bottom:3px}
.input,select,textarea{
  width:100%;
  padding:9px 10px;
  border-radius:10px;
  border:1px solid #111827;
  background:#020817;
  color:var(--text);
  font-size:13px;
}
.row{display:flex;flex-wrap:wrap;gap:8px}
.btn{
  padding:9px 13px;
  border-radius:999px;
  border:1px solid var(--accent);
  background:var(--accent);
  color:#020817;
  font-size:13px;
  cursor:pointer;
  font-weight:600;
}
.btn.ghost{
  background:transparent;
  color:var(--accent);
}
.btn.danger{
  background:transparent;
  border-color:var(--danger);
  color:var(--danger);
}
.btn.small{padding:5px 9px;font-size:11px}

/* Lists */
.list{display:grid;gap:6px;margin-top:8px}
.item{
  padding:7px 8px;
  border-radius:10px;
  background:#020817;
  border:1px solid #111827;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:6px;
  font-size:12px;
  color:var(--muted);
}
.item b{color:var(--text)}
.actions{display:flex;gap:4px}

/* Suivi irrigation */
.suivi-header{margin-bottom:10px}
.select-row{margin:4px 0}
.table-wrap{
  margin-top:10px;
  overflow-x:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:10px;
}
th,td{
  border:1px solid #111827;
  padding:4px 3px;
  white-space:nowrap;
}
th{
  background:#020817;
  color:var(--accent);
  position:sticky;
  top:0;
}
.tr-active{outline:2px solid var(--accent)}

/* Add form inline */
.suivi-add{
  margin-top:8px;
  padding:8px;
  border-radius:12px;
  background:#020817;
  border:1px dashed #374151;
  display:grid;
  gap:6px;
  font-size:10px;
}
.suivi-add .row{gap:4px}
.suivi-add input{
  padding:5px 6px;
  font-size:10px;
}

/* Branding sliders */
.range-row{display:flex;align-items:center;gap:8px;margin-top:4px}
.range-row input[type=range]{flex:1}
.range-row span{font-size:10px;color:var(--muted)}

@media(min-width:800px){
  .main-wrap{max-width:640px;margin:0 auto 30px}
}
</style>
</head>
<body>

<header class="topbar">
  <button class="menu-btn" onclick="toggleMenu()"><span></span></button>
  <div class="app-title" id="appTitleTop">AB AGRIWEB</div>
  <img id="brandBadge" class="brand-badge hidden" alt="">
</header>

<aside class="sidebar" id="sidebar">
  <a href="#" id="nav-home" class="active" onclick="navTo(event,'home')"><span class="icon">ğŸ </span>Accueil</a>
  <a href="#" id="nav-settings" onclick="navTo(event,'settings')"><span class="icon">âš™ï¸</span>ParamÃ¨tres</a>
  <a href="#" id="nav-suivi" onclick="navTo(event,'suivi')"><span class="icon">ğŸ’§</span>Suivi irrigation</a>
  <a href="#" id="nav-logout" onclick="logout(event)"><span class="icon">ğŸšª</span>Logout</a>
</aside>
<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<main class="main-wrap">

  <!-- Accueil -->
  <section id="page-home" class="card">
    <h2>Bienvenue ğŸ‘‹</h2>
    <p class="muted">Ù‡Ø°Ù‡ Ù‡ÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ <b>AB AGRIWEB</b>. Ø§Ø³ØªØ¹Ù…Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ùˆ Suivi irrigation.</p>
  </section>

  <!-- ParamÃ¨tres hub -->
  <section id="page-settings" class="card hidden">
    <h2>ParamÃ¨tres</h2>
    <p class="muted">Ø§Ø®ØªØ± Ù…Ø§ ØªØ±ÙŠØ¯ ØªÙ‡ÙŠØ¦ØªÙ‡.</p>
    <div class="tiles">
      <div class="tile" onclick="showPage('operators')">
        <div class="ico">ğŸ‘¥</div><span class="lbl">Gestion des utilisateurs</span>
      </div>
      <div class="tile" onclick="showPage('profiles')">
        <div class="ico">ğŸ§©</div><span class="lbl">Profils</span>
      </div>
      <div class="tile" onclick="showPage('refs')">
        <div class="ico">ğŸ“š</div><span class="lbl">RÃ©fÃ©rentiels (Ferme / Secteur / Parcelle / Point)</span>
      </div>
      <div class="tile" onclick="alert('Module Droits dâ€™accÃ¨s Ã  complÃ©ter Ù„Ø§Ø­Ù‚Ù‹Ø§.')">
        <div class="ico">ğŸ›¡ï¸</div><span class="lbl">Droits dâ€™accÃ¨s</span>
      </div>
      <div class="tile" onclick="showPage('branding')">
        <div class="ico">ğŸ¨</div><span class="lbl">Branding & ThÃ¨me</span>
      </div>
    </div>
  </section>

  <!-- Operators -->
  <section id="page-operators" class="card hidden">
    <h2>Gestion des utilisateurs</h2>
    <div class="row" style="margin-top:6px">
      <div style="flex:1 1 140px">
        <div class="label">Username</div>
        <input id="op_user" class="input">
      </div>
      <div style="flex:1 1 140px">
        <div class="label">Password</div>
        <input id="op_pass" type="password" class="input">
      </div>
      <div style="flex:1 1 140px">
        <div class="label">Profil</div>
        <select id="op_profile" class="input"></select>
      </div>
      <div style="flex:1 1 140px">
        <div class="label">Ferme</div>
        <select id="op_farm" class="input"></select>
      </div>
      <button class="btn" onclick="opAdd()">Ajouter</button>
    </div>
    <div class="list" id="opList"></div>
  </section>

  <!-- Profiles -->
  <section id="page-profiles" class="card hidden">
    <h2>Profils</h2>
    <div class="row" style="margin-top:6px">
      <div style="flex:1 1 160px">
        <div class="label">Nom du profil</div>
        <input id="pr_name" class="input">
      </div>
      <button class="btn" onclick="prAdd()">Ajouter</button>
    </div>
    <div class="list" id="prList"></div>
  </section>

  <!-- RÃ©fÃ©rentiels -->
  <section id="page-refs" class="card hidden">
    <h2>RÃ©fÃ©rentiels</h2>
    <p class="muted">Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø¶ÙŠØ¹Ø§Øª Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„Ù‡Ø§ ÙÙŠ Suivi irrigation.</p>

    <!-- Ferme -->
    <div class="card" style="margin-bottom:8px">
      <h3 style="font-size:14px">Fermes</h3>
      <div class="row" style="margin-top:4px">
        <div class="label">Nom ferme</div>
        <input id="rf_farm_name" class="input">
        <button class="btn small" onclick="rfAddFarm()">+</button>
      </div>
      <div class="list" id="rfFarmList"></div>
    </div>

    <!-- Secteur -->
    <div class="card" style="margin-bottom:8px">
      <h3 style="font-size:14px">Secteurs</h3>
      <div class="row" style="margin-top:4px">
        <div class="label">Ferme</div>
        <select id="rf_sec_farm" class="input"></select>
        <div class="label">Nom secteur</div>
        <input id="rf_sec_name" class="input">
        <button class="btn small" onclick="rfAddSecteur()">+</button>
      </div>
      <div class="list" id="rfSecList"></div>
    </div>

    <!-- Parcelle -->
    <div class="card" style="margin-bottom:8px">
      <h3 style="font-size:14px">Parcelles</h3>
      <div class="row" style="margin-top:4px">
        <div class="label">Ferme</div>
        <select id="rf_par_farm" class="input"></select>
        <div class="label">Secteur</div>
        <select id="rf_par_sec" class="input"></select>
        <div class="label">Nom parcelle</div>
        <input id="rf_par_name" class="input">
        <button class="btn small" onclick="rfAddParcelle()">+</button>
      </div>
      <div class="list" id="rfParList"></div>
    </div>

    <!-- Point -->
    <div class="card">
      <h3 style="font-size:14px">Points</h3>
      <div class="row" style="margin-top:4px">
        <div class="label">Ferme</div>
        <select id="rf_pt_farm" class="input"></select>
        <div class="label">Secteur</div>
        <select id="rf_pt_sec" class="input"></select>
        <div class="label">Parcelle</div>
        <select id="rf_pt_par" class="input"></select>
        <div class="label">Point</div>
        <input id="rf_pt_name" class="input">
        <button class="btn small" onclick="rfAddPoint()">+</button>
      </div>
      <div class="list" id="rfPointList"></div>
    </div>
  </section>

  <!-- Branding & ThÃ¨me -->
  <section id="page-branding" class="card hidden">
    <h2>Branding & ThÃ¨me</h2>
    <p class="muted">ÙƒÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ (localStorage).</p>

    <div class="label" style="margin-top:8px">Logo principal (PNG/GIF)</div>
    <input id="br_logo_url" class="input" placeholder="URL (png/gif)">
    <input id="br_logo_file" type="file" accept="image/png,image/gif" class="input">

    <div class="label" style="margin-top:8px">Badge header (ØµØºÙŠØ± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰)</div>
    <input id="br_badge_url" class="input" placeholder="URL (png/gif)">
    <input id="br_badge_file" type="file" accept="image/png,image/gif" class="input">

    <div class="label" style="margin-top:8px">Login background (Ø®Ù„ÙÙŠØ© Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„)</div>
    <input id="br_loginbg_url" class="input" placeholder="URL (jpg/png/gif)">
    <input id="br_loginbg_file" type="file" accept="image/*" class="input">

    <div class="label" style="margin-top:8px">Fond dashboard (Ø®Ù„ÙÙŠØ© Ø¯Ø§Ø®Ù„ÙŠØ©)</div>
    <input id="br_dashbg_url" class="input" placeholder="URL (jpg/png/gif)">
    <input id="br_dashbg_file" type="file" accept="image/*" class="input">

    <div class="label" style="margin-top:8px">Couleur fond dashboard</div>
    <input id="br_dash_color" type="color" class="input" value="#020817">

    <div class="label" style="margin-top:8px">Zoom logo (login)</div>
    <div class="range-row">
      <span>X</span><input id="br_zoom_x" type="range" min="50" max="200" value="100">
      <span>Y</span><input id="br_zoom_y" type="range" min="50" max="200" value="100">
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="brandingSave()">Enregistrer</button>
      <button class="btn danger" onclick="brandingReset()">Reset (dÃ©faut)</button>
    </div>
  </section>

  <!-- Suivi irrigation -->
  <section id="page-suivi" class="card hidden">
    <div class="suivi-header">
      <h2>Suivi irrigation</h2>
      <p class="muted">Ø§Ø®ØªØ± Ø§Ù„Ø¶ÙŠØ¹Ø© Ø«Ù… secteur / parcelle / point Ø«Ù… Ø£Ø¶Ù Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„.</p>
    </div>

    <div class="select-row">
      <div class="label">Ferme</div>
      <select id="sv_farm" class="input" onchange="svOnFarm()"></select>
    </div>
    <div class="select-row">
      <div class="label">Secteur</div>
      <select id="sv_sec" class="input" onchange="svOnSec()"></select>
    </div>
    <div class="select-row">
      <div class="label">Parcelle</div>
      <select id="sv_par" class="input" onchange="svOnPar()"></select>
    </div>
    <div class="select-row">
      <div class="label">Point</div>
      <select id="sv_pt" class="input" onchange="svReloadTable()"></select>
    </div>

    <div class="row" style="margin-top:8px;gap:6px">
      <button class="btn small" onclick="svShowAdd()">Ajouter</button>
      <button class="btn small" onclick="svSetMode('edit')">Modifier</button>
      <button class="btn small danger" onclick="svSetMode('delete')">Supprimer</button>
      <button class="btn small" onclick="svShare()">Partager</button>
      <button class="btn small" onclick="svExportCSV()">Exporter Excel</button>
      <button class="btn small" onclick="svPrint()">Exporter PDF</button>
    </div>

    <div id="sv_add_wrap" class="suivi-add hidden">
      <div class="row">
        <input id="sv_tours" placeholder="Tours / Heures">
        <input id="sv_duree" placeholder="DurÃ©e (min)">
        <input id="sv_repos" placeholder="Temps repos">
        <input id="sv_vapp" placeholder="V apport">
        <input id="sv_ecapp" placeholder="EC apport">
      </div>
      <div class="row">
        <input id="sv_phapp" placeholder="pH apport">
        <input id="sv_vdr" placeholder="V drainage">
        <input id="sv_ecdr" placeholder="EC drainage">
        <input id="sv_phdr" placeholder="pH drainage">
        <input id="sv_pctdr" placeholder="% drainage">
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn small" onclick="svSaveNew()">âœ“</button>
        <button class="btn small danger" onclick="svHideAdd()">âœ•</button>
      </div>
    </div>

    <div class="table-wrap">
      <table id="sv_table">
        <thead>
          <tr>
            <th>#</th>
            <th>Serre / Point</th>
            <th>Tours / Heures</th>
            <th>DurÃ©e (min)</th>
            <th>Temps repos</th>
            <th>V apport</th>
            <th>EC apport</th>
            <th>pH apport</th>
            <th>V drainage</th>
            <th>EC drainage</th>
            <th>pH drainage</th>
            <th>% drainage</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

</main>

<div class="toast-wrap hidden" id="toast"><div class="toast" id="toast-msg"></div></div>

<script>
/* ========== Helpers ========== */
const LS_PROFILES='ab_profiles';
const LS_OPERATORS='ab_operators';
const LS_FARMS='ab_farms';
const LS_SECT='ab_secteurs';
const LS_PARC='ab_parcelles';
const LS_POINT='ab_points';
const LS_SUIVI='ab_suivi_irrig';
const LS_BRAND='ab_branding';

function $(id){return document.getElementById(id)}
function toast(msg){
  const w=$('toast'),m=$('toast-msg');
  m.textContent=msg;w.classList.remove('hidden');
  setTimeout(()=>w.classList.add('hidden'),2200);
}
function openMenu(){ $('sidebar').classList.add('active');$('overlay').classList.add('active');}
function closeMenu(){ $('sidebar').classList.remove('active');$('overlay').classList.remove('active');}
function toggleMenu(){ $('sidebar').classList.contains('active')?closeMenu():openMenu(); }
function navTo(e,page){e.preventDefault();setActiveNav(e.currentTarget);showPage(page);closeMenu();}
function setActiveNav(el){document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));el.classList.add('active');}
function showPage(page){
  ['home','settings','operators','profiles','refs','branding','suivi'].forEach(p=>{
    const el=$('page-'+p); if(el) el.classList.add('hidden');
  });
  const t=$('page-'+page); if(t) t.classList.remove('hidden');
}

/* Logout to index.html */
function logout(e){e.preventDefault();window.location.href='index.html';}

/* ========== Storage helpers ========== */
function lsGet(k,def){try{const v=JSON.parse(localStorage.getItem(k));return v||def;}catch{return def;}}
function lsSet(k,v){localStorage.setItem(k,JSON.stringify(v));}

/* ========== Profiles ========== */
function prLoad(){return lsGet(LS_PROFILES,["Admin"]);}
function prSave(a){lsSet(LS_PROFILES,a);}
function prRender(){
  const list=$('prList');const arr=prLoad();
  list.innerHTML=arr.map((n,i)=>`<div class="item">
    <div><b>${n}</b></div>
    <div class="actions">
      <button class="btn small" onclick="prEdit(${i})">âœï¸</button>
      <button class="btn small danger" onclick="prDel(${i})">ğŸ—‘ï¸</button>
    </div>
  </div>`).join('')||'<div class="item"><span>Aucun profil.</span></div>';
  // fill select
  const sel=$('op_profile'); if(sel){sel.innerHTML=arr.map(n=>`<option>${n}</option>`).join('');}
}
function prAdd(){
  const v=$('pr_name').value.trim(); if(!v)return toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… profil');
  const arr=prLoad(); if(arr.includes(v))return toast('Profil Ù…ÙˆØ¬ÙˆØ¯');
  arr.push(v);prSave(arr);$('pr_name').value='';prRender();toast('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
}
function prEdit(i){
  const arr=prLoad();const nv=prompt('Modifier profil',arr[i]);if(!nv)return;
  arr[i]=nv.trim();prSave(arr);prRender();
}
function prDel(i){
  const arr=prLoad();if(!confirm('Supprimer profil ?'))return;
  arr.splice(i,1);prSave(arr);prRender();
}

/* ========== Fermes / Secteurs / Parcelles / Points ========== */
function rfLoadFarms(){return lsGet(LS_FARMS,[]);}
function rfSaveFarms(a){lsSet(LS_FARMS,a);}
function rfAddFarm(){
  const name=$('rf_farm_name').value.trim();
  if(!name)return toast('Nom ferme ?');
  const arr=rfLoadFarms();
  if(arr.some(f=>f.name===name))return toast('Ferme Ù…ÙˆØ¬ÙˆØ¯Ø©');
  arr.push({id:Date.now(),name});
  rfSaveFarms(arr);$('rf_farm_name').value='';rfRenderAll();toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© ferme');
}
function rfRenderFarms(){
  const arr=rfLoadFarms();const list=$('rfFarmList');
  list.innerHTML=arr.map((f,i)=>`<div class="item">
    <div><b>${f.name}</b></div>
    <div class="actions">
      <button class="btn small danger" onclick="rfDelFarm(${i})">ğŸ—‘ï¸</button>
    </div>
  </div>`).join('')||'<div class="item"><span>Aucune ferme.</span></div>';
  // fill selects
  const opts=arr.map(f=>`<option value="${f.id}">${f.name}</option>`).join('');
  ['rf_sec_farm','rf_par_farm','rf_pt_farm','sv_farm','op_farm'].forEach(id=>{
    const s=$(id);if(s){s.innerHTML='<option value="">--</option>'+opts;}
  });
}
function rfDelFarm(i){
  const arr=rfLoadFarms();if(!confirm('Supprimer ferme ?'))return;
  const id=arr[i].id;
  arr.splice(i,1);rfSaveFarms(arr);
  // also remove sectors/parcelles/points liÃ©s
  lsSet(LS_SECT, rfLoadSecteurs().filter(s=>s.farmId!==id));
  lsSet(LS_PARC, rfLoadParcelles().filter(p=>p.farmId!==id));
  lsSet(LS_POINT, rfLoadPoints().filter(p=>p.farmId!==id));
  rfRenderAll();
}

/* Secteurs */
function rfLoadSecteurs(){return lsGet(LS_SECT,[]);}
function rfSaveSecteurs(a){lsSet(LS_SECT,a);}
function rfAddSecteur(){
  const farmId=parseInt($('rf_sec_farm').value||0);
  const name=$('rf_sec_name').value.trim();
  if(!farmId||!name)return toast('Ø§Ø®ØªØ± ferme ÙˆØ§Ø³Ù… secteur');
  const arr=rfLoadSecteurs();
  if(arr.some(s=>s.name===name && s.farmId===farmId))return toast('Secteur Ù…ÙˆØ¬ÙˆØ¯');
  arr.push({id:Date.now(),farmId,name});
  rfSaveSecteurs(arr);$('rf_sec_name').value='';rfRenderAll();toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© secteur');
}
function rfRenderSecteurs(){
  const farms=rfLoadFarms();
  const arr=rfLoadSecteurs();
  const list=$('rfSecList');
  list.innerHTML=arr.map((s,i)=>{
    const f=farms.find(x=>x.id===s.farmId);
    return `<div class="item">
      <div><b>${s.name}</b> <span>(${f?f.name:''})</span></div>
      <div class="actions"><button class="btn small danger" onclick="rfDelSecteur(${i})">ğŸ—‘ï¸</button></div>
    </div>`;
  }).join('')||'<div class="item"><span>Aucun secteur.</span></div>';
}
function rfDelSecteur(i){
  const arr=rfLoadSecteurs();if(!confirm('Supprimer secteur ?'))return;
  const id=arr[i].id;
  arr.splice(i,1);rfSaveSecteurs(arr);
  // remove parcelles & points liÃ©s
  lsSet(LS_PARC, rfLoadParcelles().filter(p=>p.sectId!==id));
  lsSet(LS_POINT, rfLoadPoints().filter(p=>p.sectId!==id));
  rfRenderAll();
}

/* Parcelles */
function rfLoadParcelles(){return lsGet(LS_PARC,[]);}
function rfSaveParcelles(a){lsSet(LS_PARC,a);}
function rfUpdateParSecOptions(){
  const farmId=parseInt($('rf_par_farm').value||0);
  const secs=rfLoadSecteurs().filter(s=>!farmId || s.farmId===farmId);
  const s=$('rf_par_sec');
  if(s)s.innerHTML='<option value="">--</option>'+secs.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
}
$('rf_par_farm') && $('rf_par_farm').addEventListener('change',rfUpdateParSecOptions);
function rfAddParcelle(){
  const farmId=parseInt($('rf_par_farm').value||0);
  const sectId=parseInt($('rf_par_sec').value||0);
  const name=$('rf_par_name').value.trim();
  if(!farmId||!sectId||!name)return toast('Ø£ÙƒÙ…Ù„ Ferme/Secteur/Parcelle');
  const arr=rfLoadParcelles();
  if(arr.some(p=>p.name===name && p.sectId===sectId))return toast('Parcelle Ù…ÙˆØ¬ÙˆØ¯Ø©');
  arr.push({id:Date.now(),farmId,sectId,name});
  rfSaveParcelles(arr);$('rf_par_name').value='';rfRenderAll();toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© parcelle');
}
function rfRenderParcelles(){
  const farms=rfLoadFarms();
  const secs=rfLoadSecteurs();
  const arr=rfLoadParcelles();
  const list=$('rfParList');
  list.innerHTML=arr.map((p,i)=>{
    const f=farms.find(x=>x.id===p.farmId);
    const s=secs.find(x=>x.id===p.sectId);
    return `<div class="item">
      <div><b>${p.name}</b> <span>(${f?f.name:''} / ${s?s.name:''})</span></div>
      <div class="actions"><button class="btn small danger" onclick="rfDelParcelle(${i})">ğŸ—‘ï¸</button></div>
    </div>`;
  }).join('')||'<div class="item"><span>Aucune parcelle.</span></div>';
}
function rfDelParcelle(i){
  const arr=rfLoadParcelles();if(!confirm('Supprimer parcelle ?'))return;
  const id=arr[i].id;
  arr.splice(i,1);rfSaveParcelles(arr);
  lsSet(LS_POINT, rfLoadPoints().filter(p=>p.parId!==id));
  rfRenderAll();
}

/* Points */
function rfLoadPoints(){return lsGet(LS_POINT,[]);}
function rfSavePoints(a){lsSet(LS_POINT,a);}
function rfUpdatePtSecPar(){
  const farmId=parseInt($('rf_pt_farm').value||0);
  const secs=rfLoadSecteurs().filter(s=>!farmId || s.farmId===farmId);
  $('rf_pt_sec').innerHTML='<option value="">--</option>'+secs.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('rf_pt_par').innerHTML='<option value="">--</option>';
}
$('rf_pt_farm') && $('rf_pt_farm').addEventListener('change',rfUpdatePtSecPar);
$('rf_pt_sec') && $('rf_pt_sec').addEventListener('change',()=>{
  const farmId=parseInt($('rf_pt_farm').value||0);
  const sectId=parseInt($('rf_pt_sec').value||0);
  const pars=rfLoadParcelles().filter(p=>
    (!farmId || p.farmId===farmId) && (!sectId || p.sectId===sectId)
  );
  $('rf_pt_par').innerHTML='<option value="">--</option>'+pars.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
});
function rfAddPoint(){
  const farmId=parseInt($('rf_pt_farm').value||0);
  const sectId=parseInt($('rf_pt_sec').value||0);
  const parId=parseInt($('rf_pt_par').value||0);
  const name=$('rf_pt_name').value.trim();
  if(!farmId||!sectId||!parId||!name)return toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¥Ø®ØªÙŠØ§Ø±');
  const arr=rfLoadPoints();
  if(arr.some(p=>p.name===name && p.parId===parId))return toast('Point Ù…ÙˆØ¬ÙˆØ¯');
  arr.push({id:Date.now(),farmId,sectId,parId,name});
  rfSavePoints(arr);$('rf_pt_name').value='';rfRenderAll();toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© point');
}
function rfRenderPoints(){
  const farms=rfLoadFarms(),secs=rfLoadSecteurs(),pars=rfLoadParcelles();
  const arr=rfLoadPoints();
  const list=$('rfPointList');
  list.innerHTML=arr.map((p,i)=>{
    const f=farms.find(x=>x.id===p.farmId);
    const s=secs.find(x=>x.id===p.sectId);
    const pr=pars.find(x=>x.id===p.parId);
    return `<div class="item">
      <div><b>${p.name}</b> <span>(${f?f.name:''} / ${s?s.name:''} / ${pr?pr.name:''})</span></div>
      <div class="actions"><button class="btn small danger" onclick="rfDelPoint(${i})">ğŸ—‘ï¸</button></div>
    </div>`;
  }).join('')||'<div class="item"><span>Aucun point.</span></div>';
}
function rfDelPoint(i){
  const arr=rfLoadPoints();if(!confirm('Supprimer point ?'))return;
  arr.splice(i,1);rfSavePoints(arr);rfRenderAll();
}
function rfRenderAll(){
  rfRenderFarms();
  rfRenderSecteurs();
  rfRenderParcelles();
  rfRenderPoints();
  svFillFarm();
}

/* ========== Operators ========== */
function opLoad(){return lsGet(LS_OPERATORS,[]);}
function opSave(a){lsSet(LS_OPERATORS,a);}
function opAdd(){
  const u=$('op_user').value.trim();
  const p=$('op_pass').value.trim();
  const profile=$('op_profile').value.trim();
  const farmId=parseInt($('op_farm').value||0);
  if(!u||!p||!profile||!farmId)return toast('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
  const arr=opLoad();
  if(arr.some(x=>x.username.toLowerCase()===u.toLowerCase()))return toast('User Ù…ÙˆØ¬ÙˆØ¯');
  arr.push({username:u,password:p,profile,farmId});
  opSave(arr);$('op_user').value='';$('op_pass').value='';opRender();toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
}
function opRender(){
  const list=$('opList');const arr=opLoad();const farms=rfLoadFarms();
  list.innerHTML=arr.map((u,i)=>{
    const f=farms.find(x=>x.id===u.farmId);
    return `<div class="item">
      <div><b>${u.username}</b> <span>${u.profile}</span> <span>${f?f.name:''}</span></div>
      <div class="actions"><button class="btn small danger" onclick="opDel(${i})">ğŸ—‘ï¸</button></div>
    </div>`;
  }).join('')||'<div class="item"><span>Aucun utilisateur.</span></div>';
}
function opDel(i){
  const arr=opLoad();if(!confirm('Supprimer utilisateur ?'))return;
  arr.splice(i,1);opSave(arr);opRender();
}

/* ========== Branding & ThÃ¨me ========== */
function readFileAsDataURL(file,cb){
  const r=new FileReader();r.onload=()=>cb(r.result);r.readAsDataURL(file);
}
function brandLoad(){return lsGet(LS_BRAND,{
  logo:null,badge:null,loginBg:null,dashBg:null,dashColor:"#020817",zoom:{x:100,y:100}
});}
function brandSave(cfg){lsSet(LS_BRAND,cfg);}
function applyBrand(){
  const c=brandLoad();
  // badge top-right
  if(c.badge){$('brandBadge').src=c.badge;$('brandBadge').classList.remove('hidden');}
  else $('brandBadge').classList.add('hidden');
  // app title maybe from logo handled in index.html
  document.body.style.backgroundColor=c.dashColor||'#020817';
}
function brandingInitForm(){
  const c=brandLoad();
  $('br_logo_url').value=c.logo||'';
  $('br_badge_url').value=c.badge||'';
  $('br_loginbg_url').value=c.loginBg||'';
  $('br_dashbg_url').value=c.dashBg||'';
  $('br_dash_color').value=c.dashColor||'#020817';
  $('br_zoom_x').value=c.zoom?.x||100;
  $('br_zoom_y').value=c.zoom?.y||100;
}
function brandingSave(){
  const c=brandLoad();
  const urlLogo=$('br_logo_url').value.trim();
  const urlBadge=$('br_badge_url').value.trim();
  const urlLoginBg=$('br_loginbg_url').value.trim();
  const urlDashBg=$('br_dashbg_url').value.trim();
  if(urlLogo && !/\.(png|gif)(\?|#|$)/i.test(urlLogo) && !urlLogo.startsWith('data:')) return toast('Logo URL ØºÙŠØ± ØµØ§Ù„Ø­');
  c.logo=urlLogo||c.logo;
  if(urlBadge && !/\.(png|gif)(\?|#|$)/i.test(urlBadge) && !urlBadge.startsWith('data:')) return toast('Badge URL ØºÙŠØ± ØµØ§Ù„Ø­');
  c.badge=urlBadge||c.badge;
  if(urlLoginBg && !urlLoginBg.startsWith('data:')) c.loginBg=urlLoginBg;
  if(urlDashBg && !urlDashBg.startsWith('data:')) c.dashBg=urlDashBg;
  c.dashColor=$('br_dash_color').value||'#020817';
  c.zoom={x:parseInt($('br_zoom_x').value||100),y:parseInt($('br_zoom_y').value||100)};
  brandSave(c);
  applyBrand();
  toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
}
function brandingReset(){
  localStorage.removeItem(LS_BRAND);
  brandingInitForm();applyBrand();
  toast('Ø±Ø¬Ø¹Ù†Ø§ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
}

/* handle file inputs */
['br_logo_file','br_badge_file','br_loginbg_file','br_dashbg_file'].forEach(id=>{
  const el=$(id); if(!el)return;
  el.addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f)return;
    readFileAsDataURL(f,(data)=>{
      const c=brandLoad();
      if(id==='br_logo_file') c.logo=data;
      if(id==='br_badge_file') c.badge=data;
      if(id==='br_loginbg_file') c.loginBg=data;
      if(id==='br_dashbg_file') c.dashBg=data;
      brandSave(c);applyBrand();toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©');
    });
  });
});

/* ========== Suivi irrigation ========== */
let svMode=''; // '', 'edit', 'delete'
function svKey(fId,sId,pId,ptId){return [fId,sId,pId,ptId].join('|');}
function svLoad(){return lsGet(LS_SUIVI,{});}
function svSave(obj){lsSet(LS_SUIVI,obj);}
function svFillFarm(){
  const farmSel=$('sv_farm');
  if(!farmSel)return;
  const farms=rfLoadFarms();
  farmSel.innerHTML='<option value="">-- Ø§Ø®ØªØ± ferme --</option>'+
    farms.map(f=>`<option value="${f.id}">${f.name}</option>`).join('');
  svOnFarm();
}
function svOnFarm(){
  const fId=parseInt($('sv_farm').value||0);
  const secs=rfLoadSecteurs().filter(s=>!fId || s.farmId===fId);
  $('sv_sec').innerHTML='<option value="">-- Secteur --</option>'+
    secs.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('sv_par').innerHTML='<option value="">-- Parcelle --</option>';
  $('sv_pt').innerHTML='<option value="">-- Point --</option>';
  svReloadTable();
}
function svOnSec(){
  const fId=parseInt($('sv_farm').value||0);
  const sId=parseInt($('sv_sec').value||0);
  const pars=rfLoadParcelles().filter(p=>
    (!fId||p.farmId===fId)&&(!sId||p.sectId===sId)
  );
  $('sv_par').innerHTML='<option value="">-- Parcelle --</option>'+
    pars.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  $('sv_pt').innerHTML='<option value="">-- Point --</option>';
  svReloadTable();
}
function svOnPar(){
  const fId=parseInt($('sv_farm').value||0);
  const sId=parseInt($('sv_sec').value||0);
  const pId=parseInt($('sv_par').value||0);
  const pts=rfLoadPoints().filter(pt=>
    (!fId||pt.farmId===fId)&&(!sId||pt.sectId===sId)&&(!pId||pt.parId===pId)
  );
  $('sv_pt').innerHTML='<option value="">-- Point --</option>'+
    pts.map(pt=>`<option value="${pt.id}">${pt.name}</option>`).join('');
  svReloadTable();
}
function svShowAdd(){$('sv_add_wrap').classList.remove('hidden');}
function svHideAdd(){$('sv_add_wrap').classList.add('hidden');}
function svGetCurrentKey(){
  const fId=parseInt($('sv_farm').value||0);
  const sId=parseInt($('sv_sec').value||0);
  const pId=parseInt($('sv_par').value||0);
  const ptId=parseInt($('sv_pt').value||0);
  if(!fId||!sId||!pId||!ptId){return null;}
  return svKey(fId,sId,pId,ptId);
}
function svSaveNew(){
  const key=svGetCurrentKey();
  if(!key)return toast('Ø§Ø®ØªØ± Ferme / Secteur / Parcelle / Point Ø£ÙˆÙ„Ø§');
  const row={
    tours:$('sv_tours').value.trim(),
    duree:$('sv_duree').value.trim(),
    repos:$('sv_repos').value.trim(),
    vapp:$('sv_vapp').value.trim(),
    ecapp:$('sv_ecapp').value.trim(),
    phapp:$('sv_phapp').value.trim(),
    vdr:$('sv_vdr').value.trim(),
    ecdr:$('sv_ecdr').value.trim(),
    phdr:$('sv_phdr').value.trim(),
    pctdr:$('sv_pctdr').value.trim()
  };
  const store=svLoad();
  store[key]=store[key]||[];
  store[key].push(row);
  svSave(store);
  ['sv_tours','sv_duree','sv_repos','sv_vapp','sv_ecapp','sv_phapp','sv_vdr','sv_ecdr','sv_phdr','sv_pctdr'].forEach(id=>$(id).value='');
  svHideAdd();
  svReloadTable();
  toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø·Ø±');
}
function svReloadTable(){
  const key=svGetCurrentKey();
  const tbody=$('sv_table').querySelector('tbody');
  tbody.innerHTML='';
  if(!key)return;
  const store=svLoad();
  const rows=store[key]||[];
  const ptSel=$('sv_pt');
  const ptName=ptSel.options[ptSel.selectedIndex]?.text||'';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.dataset.index=i;
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${ptName}</td>
      <td>${r.tours||''}</td>
      <td>${r.duree||''}</td>
      <td>${r.repos||''}</td>
      <td>${r.vapp||''}</td>
      <td>${r.ecapp||''}</td>
      <td>${r.phapp||''}</td>
      <td>${r.vdr||''}</td>
      <td>${r.ecdr||''}</td>
      <td>${r.phdr||''}</td>
      <td>${r.pctdr||''}</td>`;
    tr.onclick=()=>svOnRowClick(tr);
    tbody.appendChild(tr);
  });
}
function svSetMode(m){
  svMode=(svMode===m)?'':m;
  toast(svMode?`ÙˆØ¶Ø¹ ${svMode}`:'ÙˆØ¶Ø¹ Ø¹Ø§Ø¯ÙŠ');
}
function svOnRowClick(tr){
  const key=svGetCurrentKey(); if(!key)return;
  const store=svLoad(); const rows=store[key]||[];
  const idx=parseInt(tr.dataset.index);
  if(svMode==='delete'){
    if(!confirm('Supprimer cette ligne ?'))return;
    rows.splice(idx,1); store[key]=rows; svSave(store); svReloadTable(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
  }else if(svMode==='edit'){
    const r=rows[idx];
    const nv=prompt('Modifier (sÃ©parÃ© par ;)', [
      r.tours,r.duree,r.repos,r.vapp,r.ecapp,r.phapp,r.vdr,r.ecdr,r.phdr,r.pctdr
    ].join(';'));
    if(nv==null)return;
    const parts=nv.split(';');
    if(parts.length>=10){
      [r.tours,r.duree,r.repos,r.vapp,r.ecapp,r.phapp,r.vdr,r.ecdr,r.phdr,r.pctdr]=parts;
      store[key]=rows; svSave(store); svReloadTable(); toast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
    }else{
      toast('ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    }
  }
}
function svShare(){
  const key=svGetCurrentKey(); if(!key)return toast('Ø§Ø®ØªØ± Point');
  const store=svLoad(); const rows=store[key]||[];
  if(!rows.length)return toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª');
  const txt=rows.map((r,i)=>`${i+1}) ${r.tours} | ${r.duree} | ${r.vapp} | ${r.vdr} ...`).join('\n');
  if(navigator.share){
    navigator.share({text:txt}).catch(()=>{});
  }else{
    navigator.clipboard && navigator.clipboard.writeText(txt);
    toast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ WhatsApp Ø£Ùˆ Gmail');
  }
}
function svExportCSV(){
  const key=svGetCurrentKey(); if(!key)return toast('Ø§Ø®ØªØ± Point');
  const store=svLoad(); const rows=store[key]||[];
  if(!rows.length)return toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª');
  const header=['Serre/Point','Tours/Heures','Duree(min)','Temps repos','V apport','EC apport','pH apport','V drainage','EC drainage','pH drainage','% drainage'];
  const ptName=$('sv_pt').options[$('sv_pt').selectedIndex].text;
  const lines=[header.join(',')];
  rows.forEach(r=>{
    lines.push([
      ptName,r.tours,r.duree,r.repos,r.vapp,r.ecapp,r.phapp,r.vdr,r.ecdr,r.phdr,r.pctdr
    ].map(x=>`"${(x||'').replace(/"/g,'""')}"`).join(','));
  });
  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='suivi_irrigation.csv';a.click();
  URL.revokeObjectURL(url);
}
function svPrint(){
  window.print();
}

/* ========== INIT ========== */
(function init(){
  applyBrand();
  rfRenderAll();
  prRender();
  opRender();
  brandingInitForm();
  showPage('home');
})();
</script>
</body>
</html>
