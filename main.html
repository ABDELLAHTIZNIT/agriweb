<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AB AGRIWEB - Dashboard</title>
  <link rel="stylesheet" href="assets/css/base.css"/>
</head>
<body>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar">
  <div class="sidebar-header">
    <span class="sidebar-title" id="sb-app-name">AB AGRIWEB</span>
  </div>
  <nav class="sidebar-nav">
    <button onclick="openPage('home')" class="nav-item" id="nav-home">üè† Home</button>
    <button onclick="openPage('settings')" class="nav-item" id="nav-settings">‚öôÔ∏è Settings</button>
    <button onclick="openPage('ref')" class="nav-item" id="nav-ref">üìö Referential</button>
    <button onclick="openPage('irr')" class="nav-item" id="nav-irr">üíß Irrigation tracking</button>
    <button onclick="logout()" class="nav-item nav-danger">üö™ Logout</button>
  </nav>
</aside>

<!-- Topbar -->
<header class="topbar">
  <button id="menuBtn" class="icon-btn" onclick="toggleSidebar()">‚ò∞</button>
  <div class="top-title" id="top-app-name">AB AGRIWEB</div>
  <img id="top-logo" class="top-logo" alt="Logo"/>
</header>

<main class="page-wrap">

  <!-- HOME -->
  <section id="page-home" class="card">
    <h2>Welcome üëã</h2>
    <p>Control panel for <span id="home-app-name">AB AGRIWEB</span>. Use the menu to navigate.</p>
  </section>

  <!-- SETTINGS -->
  <section id="page-settings" class="card hidden">
    <h2>Application settings</h2>
    <p class="muted">Branding and basic configuration are stored locally in this browser.</p>

    <!-- Branding -->
    <h3>Branding & Logos</h3>
    <div class="stack">
      <div>
        <label class="label">Application name</label>
        <input id="cfg-app-name" class="input" placeholder="AB AGRIWEB"/>
      </div>

      <div>
        <label class="label">Main logo URL (PNG/JPG/GIF)</label>
        <input id="cfg-logo-url" class="input" placeholder="https://...png"/>
      </div>
      <div>
        <label class="label">Main logo file</label>
        <input id="cfg-logo-file" class="input" type="file" accept="image/png,image/gif,image/jpeg"/>
      </div>

      <div>
        <label class="label">Login background URL</label>
        <input id="cfg-login-bg-url" class="input" placeholder="https://...jpg"/>
      </div>
      <div>
        <label class="label">Login background file</label>
        <input id="cfg-login-bg-file" class="input" type="file" accept="image/png,image/gif,image/jpeg"/>
      </div>

      <div>
        <label class="label">Dashboard background URL (inside)</label>
        <input id="cfg-main-bg-url" class="input" placeholder="optional"/>
      </div>
      <div>
        <label class="label">Dashboard background color</label>
        <input id="cfg-main-bg-color" class="input" type="color" value="#020817"/>
      </div>

      <div>
        <label class="label">Logo zoom horizontal</label>
        <input id="cfg-zoom-x" type="range" min="50" max="200" value="100"/>
      </div>
      <div>
        <label class="label">Logo zoom vertical</label>
        <input id="cfg-zoom-y" type="range" min="50" max="200" value="100"/>
      </div>
    </div>

    <div class="row right" style="margin-top:10px;gap:10px">
      <button class="btn danger" onclick="cfgReset()">Reset default</button>
      <button class="btn" onclick="cfgSave()">Save</button>
    </div>

    <!-- Management -->
    <h3 style="margin-top:24px">Management</h3>
    <div class="ref-grid">
      <button type="button" class="ref-box ref-button" onclick="mgOpenUsers()">
        <h3>Users</h3>
        <p class="small muted">Create / edit operators who can access this dashboard.</p>
      </button>
      <button type="button" class="ref-box ref-button" onclick="mgOpenProfiles()">
        <h3>Profiles</h3>
        <p class="small muted">Define roles / profiles for operators.</p>
      </button>
      <button type="button" class="ref-box ref-button" onclick="mgOpenRights()">
        <h3>Access rights</h3>
        <p class="small muted">Assign what each profile can see or edit.</p>
      </button>
      <button type="button" class="ref-box ref-button" onclick="mgOpenSecurity()">
        <h3>Security / Password</h3>
        <p class="small muted">Recovery email, phone, secret question, recovery code.</p>
      </button>
    </div>
  </section>

  <!-- REFERENTIAL -->
  <section id="page-ref" class="card hidden">
    <h2>Referential</h2>
    <p class="muted">Structure: <b>Company ‚Üí Farm ‚Üí Sector ‚Üí Parcel (Parcelle) ‚Üí Point</b>.</p>

    <div class="ref-grid">

      <div class="ref-box">
        <h3>Companies</h3>
        <div class="row">
          <input id="rf-societe-name" class="input" placeholder="Company name"/>
          <button class="btn" onclick="rfAddSociete()">+</button>
        </div>
        <ul id="rf-societe-list" class="ref-list"></ul>
      </div>

      <div class="ref-box">
        <h3>Farms</h3>
        <div class="row">
          <select id="rf-ferme-societe" class="input small"></select>
          <input id="rf-ferme-name" class="input" placeholder="Farm name"/>
          <button class="btn" onclick="rfAddFerme()">+</button>
        </div>
        <ul id="rf-ferme-list" class="ref-list"></ul>
      </div>

      <div class="ref-box">
        <h3>Sectors</h3>
        <div class="row">
          <select id="rf-sect-ferme" class="input small"></select>
          <input id="rf-sect-name" class="input" placeholder="Sector name"/>
          <button class="btn" onclick="rfAddSecteur()">+</button>
        </div>
        <ul id="rf-sect-list" class="ref-list"></ul>
      </div>

      <div class="ref-box">
        <h3>Parcels</h3>
        <div class="row">
          <select id="rf-parc-ferme" class="input small"></select>
          <select id="rf-parc-secteur" class="input small"></select>
          <input id="rf-parc-name" class="input" placeholder="Parcel name"/>
          <button class="btn" onclick="rfAddParcelle()">+</button>
        </div>
        <ul id="rf-parc-list" class="ref-list"></ul>
      </div>

      <div class="ref-box">
        <h3>Points</h3>
        <div class="row">
          <select id="rf-pt-ferme" class="input small"></select>
          <select id="rf-pt-secteur" class="input small"></select>
          <select id="rf-pt-parcelle" class="input small"></select>
          <input id="rf-pt-name" class="input" placeholder="Point name (P1...)"/>
          <button class="btn" onclick="rfAddPoint()">+</button>
        </div>
        <ul id="rf-pt-list" class="ref-list"></ul>
      </div>

    </div>

    <p class="small muted" style="margin-top:8px">
      Click on any item to delete it. All data is stored only in this browser (localStorage).
    </p>
  </section>

  <!-- IRRIGATION -->
  <section id="page-irr" class="card hidden">
    <h2>Suivi irrigation</h2>
    <p class="muted">
      Select <b>Farm / Sector / Parcel / Point</b>, then:
      <b>Add</b> to record a measurement,
      <b>Irrigation</b> to view the table,
      <b>Share</b> to copy summary,
      <b>Export</b> to download.
    </p>

    <div class="stack">
      <div>
        <label class="label">Farm</label>
        <select id="sv-ferme" class="input" onchange="svOnFermeChange()">
          <option value="">-- Select Farm --</option>
        </select>
      </div>
      <div>
        <label class="label">Sector</label>
        <select id="sv-secteur" class="input" onchange="svOnSecteurChange()">
          <option value="">-- Select Sector --</option>
        </select>
      </div>
      <div>
        <label class="label">Parcel</label>
        <select id="sv-parcelle" class="input" onchange="svOnParcelleChange()">
          <option value="">-- Select Parcel --</option>
        </select>
      </div>
      <div>
        <label class="label">Point</label>
        <select id="sv-point" class="input">
          <option value="">-- Select Point --</option>
        </select>
      </div>

      <div class="row" style="flex-wrap:wrap;gap:8px;margin-top:8px">
        <button class="btn" onclick="svOpenTable()">Irrigation</button>
        <button class="btn" onclick="svOpenAdd()">Add</button>
        <button class="btn" onclick="svShare()">Share</button>
        <button class="btn" onclick="svExportExcel()">Export Excel</button>
        <button class="btn" onclick="svExportPDF()">Export PDF</button>
      </div>
    </div>
  </section>

</main>

<!-- Modal: Add measurement -->
<div id="sv-add-modal" class="modal-wrap">
  <div class="modal-bg" onclick="svCloseAdd()"></div>
  <div class="modal">
    <h3>Add irrigation measurement</h3>
    <p class="small">Linked to current Farm / Sector / Parcel / Point.</p>
    <div class="grid">
      <div>
        <label class="label">Tours / Hours</label>
        <input id="sv-tours" class="input" type="text">
      </div>
      <div>
        <label class="label">Duration (min)</label>
        <input id="sv-duree" class="input" type="number" min="0">
      </div>
      <div>
        <label class="label">Rest time</label>
        <input id="sv-repos" class="input" type="text">
      </div>
      <div>
        <label class="label">V apport</label>
        <input id="sv-vapport" class="input" type="text">
      </div>
      <div>
        <label class="label">EC apport</label>
        <input id="sv-ecapport" class="input" type="text">
      </div>
      <div>
        <label class="label">pH apport</label>
        <input id="sv-phapport" class="input" type="text">
      </div>
      <div>
        <label class="label">V drainage</label>
        <input id="sv-vdrain" class="input" type="text">
      </div>
      <div>
        <label class="label">EC drainage</label>
        <input id="sv-ecdrain" class="input" type="text">
      </div>
      <div>
        <label class="label">pH drainage</label>
        <input id="sv-phdrain" class="input" type="text">
      </div>
      <div>
        <label class="label">% drainage</label>
        <input id="sv-pctdrain" class="input" type="text">
      </div>
    </div>
    <div class="right" style="margin-top:10px">
      <button class="btn danger" onclick="svCloseAdd()">‚úï Cancel</button>
      <button class="btn" onclick="svSaveAdd()">‚úì Save</button>
    </div>
  </div>
</div>

<!-- Modal: Irrigation table -->
<div id="sv-table-modal" class="modal-wrap">
  <div class="modal-bg" onclick="svCloseTable()"></div>
  <div class="modal" style="max-width:980px">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <div>
        <h3 style="margin:0">Irrigation - Table</h3>
        <div id="sv-table-title" class="small muted"></div>
      </div>
      <div class="row" style="gap:6px">
        <button class="btn" onclick="svExportExcel()">Excel</button>
        <button class="btn" onclick="svExportPDF()">PDF / Print</button>
        <button class="btn danger" onclick="svCloseTable()">‚úï</button>
      </div>
    </div>
    <div class="small muted">Click a row to edit or delete.</div>
    <div style="overflow-x:auto;margin-top:6px">
      <table id="sv-table" class="tbl">
        <thead>
        <tr>
          <th>#</th>
          <th>Point</th>
          <th>Tours / Hours</th>
          <th>Duration (min)</th>
          <th>Rest time</th>
          <th>V apport</th>
          <th>EC apport</th>
          <th>pH apport</th>
          <th>V drainage</th>
          <th>EC drainage</th>
          <th>pH drainage</th>
          <th>% drainage</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal: Users -->
<div id="mg-users-modal" class="modal-wrap">
  <div class="modal-bg" onclick="mgCloseUsers()"></div>
  <div class="modal" style="max-width:720px">
    <h3>Users (operators)</h3>
    <p class="small muted">
      Users are stored locally in this browser and used on the login screen.
    </p>

    <div class="grid">
      <div>
        <label class="label">Username</label>
        <input id="mg-user-name" class="input" placeholder="admin">
      </div>
      <div>
        <label class="label">Password</label>
        <input id="mg-user-pass" class="input" placeholder="******">
      </div>
      <div>
        <label class="label">Profile</label>
        <select id="mg-user-prof" class="input"></select>
      </div>
    </div>
    <div class="right" style="margin-top:8px">
      <button class="btn" onclick="mgSaveUser()">Save / Update</button>
    </div>

    <h4 style="margin-top:16px">Existing users</h4>
    <table class="tbl small">
      <thead>
      <tr><th>#</th><th>Username</th><th>Profile</th><th>Actions</th></tr>
      </thead>
      <tbody id="mg-users-tbody"></tbody>
    </table>

    <div class="right" style="margin-top:10px">
      <button class="btn danger" onclick="mgCloseUsers()">Close</button>
    </div>
  </div>
</div>

<!-- Modal: Profiles -->
<div id="mg-prof-modal" class="modal-wrap">
  <div class="modal-bg" onclick="mgCloseProfiles()"></div>
  <div class="modal" style="max-width:600px">
    <h3>Profiles</h3>
    <p class="small muted">Define roles like Admin, Supervisor, Viewer‚Ä¶</p>

    <div class="grid">
      <div>
        <label class="label">Profile name</label>
        <input id="mg-prof-name" class="input" placeholder="Admin">
      </div>
      <div>
        <label class="label">Description</label>
        <input id="mg-prof-desc" class="input" placeholder="Full access">
      </div>
    </div>
    <div class="right" style="margin-top:8px">
      <button class="btn" onclick="mgSaveProfile()">Save profile</button>
    </div>

    <h4 style="margin-top:16px">Existing profiles</h4>
    <table class="tbl small">
      <thead>
      <tr><th>#</th><th>Name</th><th>Description</th><th>Delete</th></tr>
      </thead>
      <tbody id="mg-prof-tbody"></tbody>
    </table>

    <div class="right" style="margin-top:10px">
      <button class="btn danger" onclick="mgCloseProfiles()">Close</button>
    </div>
  </div>
</div>

<!-- Modal: Rights -->
<div id="mg-rights-modal" class="modal-wrap">
  <div class="modal-bg" onclick="mgCloseRights()"></div>
  <div class="modal" style="max-width:620px">
    <h3>Access rights</h3>
    <p class="small muted">
      Check what each profile can access. (Currently not enforced, stored for future use.)
    </p>

    <table class="tbl small">
      <thead>
      <tr>
        <th>Profile</th>
        <th>Settings</th>
        <th>Referential</th>
        <th>Irrigation</th>
      </tr>
      </thead>
      <tbody id="mg-rights-tbody"></tbody>
    </table>

    <div class="right" style="margin-top:10px">
      <button class="btn" onclick="mgSaveRights()">Save rights</button>
      <button class="btn danger" onclick="mgCloseRights()">Close</button>
    </div>
  </div>
</div>

<!-- Modal: Security -->
<div id="mg-sec-modal" class="modal-wrap">
  <div class="modal-bg" onclick="mgCloseSecurity()"></div>
  <div class="modal" style="max-width:620px">
    <h3>Security / Password recovery</h3>
    <p class="small muted">
      These settings are used on the login screen for account recovery.
    </p>

    <div class="stack">
      <div>
        <label class="label">Recovery email</label>
        <input id="mg-sec-email" class="input" placeholder="admin@farm.com">
      </div>
      <div>
        <label class="label">Recovery phone</label>
        <input id="mg-sec-phone" class="input" placeholder="+2126....">
      </div>
      <div>
        <label class="label">Secret question</label>
        <input id="mg-sec-question" class="input" placeholder="Your favourite city?">
      </div>
      <div>
        <label class="label">Secret answer</label>
        <input id="mg-sec-answer" class="input" placeholder="Casablanca">
      </div>
      <div>
        <label class="label">Recovery code (6 digits)</label>
        <input id="mg-sec-code" class="input" placeholder="123456">
      </div>
    </div>

    <div class="right" style="margin-top:10px">
      <button class="btn" onclick="mgSaveSecurity()">Save security</button>
      <button class="btn danger" onclick="mgCloseSecurity()">Close</button>
    </div>
  </div>
</div>

<script src="assets/js/core/ref.js"></script>
<script src="assets/js/pages/irrigation.js"></script>
<script>
/* ---------- Helpers ---------- */
const LS_APPCFG = 'ab_appcfg';
const LS_OPERATORS = 'ab_operators';
const LS_PROFILES = 'ab_profiles';
const LS_SECURITY = 'ab_security';

function g(id){return document.getElementById(id);}
function v(id){const el=g(id);return el?el.value.trim():'';}
function escapeHtml(s){return (s||'').replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));}
function mLoad(key, defVal){
  try{
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : (defVal!==undefined?defVal:null);
  }catch(e){ return defVal!==undefined?defVal:null; }
}
function mSave(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

/* ---------- Navigation ---------- */
function toggleSidebar(){g('sidebar').classList.toggle('open');}
function openPage(key){
  ['home','settings','ref','irr'].forEach(k=>{
    g('page-'+k).classList.toggle('hidden',k!==key);
  });
  g('sidebar').classList.remove('open');
}
function logout(){
  localStorage.removeItem('ab_setup');
  window.location.href='index.html';
}

/* ---------- Branding ---------- */
function cfgLoad(){return mLoad(LS_APPCFG,{}) || {};}

function fileToDataUrl(input,cb){
  const f=input.files[0]; if(!f){cb(null);return;}
  const r=new FileReader();
  r.onload=e=>cb(e.target.result);
  r.readAsDataURL(f);
}
function cfgApply(){
  const c=cfgLoad();
  const name=c.appName||'AB AGRIWEB';
  g('top-app-name').textContent=name;
  g('home-app-name').textContent=name;
  g('sb-app-name').textContent=name;

  const logo=c.logo||c.logoUrl;
  const img=g('top-logo');
  if(logo){img.src=logo;img.style.display='block';}
  else{img.style.display='none';}

  if(c.mainBgUrl){
    document.body.style.backgroundImage=`url('${c.mainBgUrl}')`;
    document.body.style.backgroundSize='cover';
    document.body.style.backgroundAttachment='fixed';
  }else{
    document.body.style.backgroundImage='none';
    document.body.style.backgroundColor=c.mainBgColor||'#020817';
  }
}
function cfgFillForm(){
  const c=cfgLoad();
  g('cfg-app-name').value=c.appName||'';
  g('cfg-logo-url').value=c.logoUrl||'';
  g('cfg-login-bg-url').value=c.loginBgUrl||'';
  g('cfg-main-bg-url').value=c.mainBgUrl||'';
  g('cfg-main-bg-color').value=c.mainBgColor||'#020817';
  g('cfg-zoom-x').value=c.zoomX||100;
  g('cfg-zoom-y').value=c.zoomY||100;
}
function cfgSave(){
  const cur=cfgLoad();
  const cfg={
    ...cur,
    appName: v('cfg-app-name')||'AB AGRIWEB',
    logoUrl: v('cfg-logo-url')||'',
    loginBgUrl: v('cfg-login-bg-url')||'',
    mainBgUrl: v('cfg-main-bg-url')||'',
    mainBgColor: g('cfg-main-bg-color').value||'#020817',
    zoomX: parseInt(g('cfg-zoom-x').value||'100',10),
    zoomY: parseInt(g('cfg-zoom-y').value||'100',10)
  };
  fileToDataUrl(g('cfg-logo-file'),d=>{
    if(d) cfg.logo=d; else if(cfg.logoUrl) cfg.logo=cfg.logoUrl;
    fileToDataUrl(g('cfg-login-bg-file'),d2=>{
      if(d2) cfg.loginBg=d2; else if(cfg.loginBgUrl) cfg.loginBg=cfg.loginBgUrl;
      mSave(LS_APPCFG,cfg);
      cfgApply();
      alert('Branding saved.');
    });
  });
}
function cfgReset(){
  if(!confirm('Reset all branding to default?'))return;
  localStorage.removeItem(LS_APPCFG);
  cfgApply();
  cfgFillForm();
}

/* ---------- Management: Users ---------- */

let mgEditingUser = null; // username being edited

function mgOpenUsers(){
  mgEditingUser = null;
  mgFillUserProfiles();
  mgRenderUsers();
  g('mg-user-name').value='';
  g('mg-user-pass').value='';
  g('mg-user-prof').value='';

  g('mg-users-modal').classList.add('show');
}
function mgCloseUsers(){
  g('mg-users-modal').classList.remove('show');
  mgEditingUser = null;
}

function mgFillUserProfiles(){
  const sel=g('mg-user-prof');
  const profs = mLoad(LS_PROFILES,[]) || [];
  let html='<option value="">(no profile)</option>';
  profs.forEach(p=>{ html+=`<option value="${escapeHtml(p.name)}">${escapeHtml(p.name)}</option>`; });
  sel.innerHTML=html;
}

function mgRenderUsers(){
  const tbody=g('mg-users-tbody');
  const users=mLoad(LS_OPERATORS,[])||[];
  if(!users.length){
    tbody.innerHTML='<tr><td colspan="4" class="muted">No users yet.</td></tr>';
    return;
  }
  tbody.innerHTML=users.map((u,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${escapeHtml(u.username||'')}</td>
      <td>${escapeHtml(u.profile||'')}</td>
      <td>
        <button class="btn small" onclick="mgEditUser('${escapeHtml(u.username)}')">Edit</button>
        <button class="btn small danger" onclick="mgDeleteUser('${escapeHtml(u.username)}')">Delete</button>
      </td>
    </tr>
  `).join('');
}

function mgSaveUser(){
  const name=v('mg-user-name');
  const pass=v('mg-user-pass');
  const prof=v('mg-user-prof');
  if(!name || !pass){alert('Username and password are required.');return;}
  let users=mLoad(LS_OPERATORS,[])||[];

  if(mgEditingUser && mgEditingUser!==name){
    users = users.filter(u=>u.username!==mgEditingUser);
  }
  const existing=users.find(u=>u.username===name);
  if(existing){
    existing.password=pass;
    existing.profile=prof;
  }else{
    users.push({username:name,password:pass,profile:prof});
  }
  mSave(LS_OPERATORS,users);
  mgEditingUser=null;
  mgRenderUsers();
  alert('User saved.');
}
function mgEditUser(username){
  const users=mLoad(LS_OPERATORS,[])||[];
  const u=users.find(x=>x.username===username);
  if(!u)return;
  mgEditingUser=username;
  g('mg-user-name').value=u.username||'';
  g('mg-user-pass').value=u.password||'';
  mgFillUserProfiles();
  g('mg-user-prof').value=u.profile||'';
}
function mgDeleteUser(username){
  if(!confirm('Delete this user?'))return;
  let users=mLoad(LS_OPERATORS,[])||[];
  users=users.filter(u=>u.username!==username);
  mSave(LS_OPERATORS,users);
  mgRenderUsers();
}

/* ---------- Management: Profiles ---------- */

function mgOpenProfiles(){
  mgRenderProfiles();
  g('mg-prof-name').value='';
  g('mg-prof-desc').value='';
  g('mg-prof-modal').classList.add('show');
}
function mgCloseProfiles(){
  g('mg-prof-modal').classList.remove('show');
}

function mgRenderProfiles(){
  const tbody=g('mg-prof-tbody');
  const list=mLoad(LS_PROFILES,[])||[];
  if(!list.length){
    tbody.innerHTML='<tr><td colspan="4" class="muted">No profiles yet.</td></tr>';
    return;
  }
  tbody.innerHTML=list.map((p,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${escapeHtml(p.name)}</td>
      <td>${escapeHtml(p.desc||'')}</td>
      <td><button class="btn small danger" onclick="mgDeleteProfile('${escapeHtml(p.name)}')">Delete</button></td>
    </tr>
  `).join('');
}

function mgSaveProfile(){
  const name=v('mg-prof-name');
  const desc=v('mg-prof-desc');
  if(!name){alert('Profile name is required.');return;}
  let list=mLoad(LS_PROFILES,[])||[];
  if(list.some(p=>p.name===name)){
    alert('Profile already exists.');
    return;
  }
  list.push({name,desc,rights:{settings:true,ref:true,irr:true}});
  mSave(LS_PROFILES,list);
  mgRenderProfiles();
  alert('Profile saved.');
}

function mgDeleteProfile(name){
  if(!confirm('Delete this profile?'))return;
  let list=mLoad(LS_PROFILES,[])||[];
  list=list.filter(p=>p.name!==name);
  mSave(LS_PROFILES,list);
  mgRenderProfiles();
}

/* used by Users modal */
function mgRenderProfilesSelect(){
  mgFillUserProfiles();
}

/* ---------- Management: Rights ---------- */

function mgOpenRights(){
  mgRenderRightsTable();
  g('mg-rights-modal').classList.add('show');
}
function mgCloseRights(){
  g('mg-rights-modal').classList.remove('show');
}

function mgRenderRightsTable(){
  const tbody=g('mg-rights-tbody');
  const list=mLoad(LS_PROFILES,[])||[];
  if(!list.length){
    tbody.innerHTML='<tr><td colspan="4" class="muted">No profiles defined.</td></tr>';
    return;
  }
  tbody.innerHTML=list.map((p,i)=>{
    const r=p.rights||{};
    return `
      <tr>
        <td>${escapeHtml(p.name)}</td>
        <td><input type="checkbox" id="rt-${i}-settings" ${r.settings!==false?'checked':''}></td>
        <td><input type="checkbox" id="rt-${i}-ref" ${r.ref!==false?'checked':''}></td>
        <td><input type="checkbox" id="rt-${i}-irr" ${r.irr!==false?'checked':''}></td>
      </tr>
    `;
  }).join('');
}

function mgSaveRights(){
  const list=mLoad(LS_PROFILES,[])||[];
  list.forEach((p,i)=>{
    const r=p.rights||{};
    r.settings=!!document.getElementById(`rt-${i}-settings`)?.checked;
    r.ref=!!document.getElementById(`rt-${i}-ref`)?.checked;
    r.irr=!!document.getElementById(`rt-${i}-irr`)?.checked;
    p.rights=r;
  });
  mSave(LS_PROFILES,list);
  alert('Rights saved (not enforced yet).');
}

/* ---------- Management: Security ---------- */

function mgOpenSecurity(){
  const sec=mLoad(LS_SECURITY,{})||{};
  g('mg-sec-email').value=sec.email||'';
  g('mg-sec-phone').value=sec.phone||'';
  g('mg-sec-question').value=sec.question||'';
  g('mg-sec-answer').value='';
  g('mg-sec-code').value=sec.recoveryCode||'';
  g('mg-sec-modal').classList.add('show');
}
function mgCloseSecurity(){
  g('mg-sec-modal').classList.remove('show');
}

function hashLite(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return String(h);}

function mgSaveSecurity(){
  const email=v('mg-sec-email');
  const phone=v('mg-sec-phone');
  const question=v('mg-sec-question');
  const answer=v('mg-sec-answer');
  const code=v('mg-sec-code');
  const sec={
    email,
    phone,
    question,
    answerHash: answer ? hashLite(answer.toLowerCase()) : null,
    recoveryCode: code || null
  };
  mSave(LS_SECURITY,sec);
  alert('Security settings saved. Use them on the login recovery screen.');
}

/* ---------- INIT ---------- */
(function init(){
  cfgApply();
  cfgFillForm();
  rfInit();
  svFillFarm();
  openPage('home');
})();
</script>
</body>
</html>
